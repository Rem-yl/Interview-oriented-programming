# Hash Index Database å®ç°æŒ‡å—

> åŸºäº DDIA ç¬¬ä¸‰ç« çš„å“ˆå¸Œç´¢å¼•å­˜å‚¨å¼•æ“å®ç°

## é¡¹ç›®æ¦‚è¿°

å®ç°ä¸€ä¸ªæç®€çš„ Key-Value æ•°æ®åº“ï¼Œé‡‡ç”¨**å“ˆå¸Œç´¢å¼• + è¿½åŠ æ—¥å¿—**çš„æ¶æ„ï¼Œç±»ä¼¼äº Bitcask å­˜å‚¨å¼•æ“ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… è¿½åŠ æ—¥å¿—ï¼ˆAppend-only logï¼‰
- âœ… å†…å­˜å“ˆå¸Œç´¢å¼•ï¼ˆIn-memory hash indexï¼‰
- âœ… æ®µå‹ç¼©ï¼ˆSegment compactionï¼‰
- âœ… å´©æºƒæ¢å¤ï¼ˆCrash recoveryï¼‰
- âœ… å¹¶å‘æ§åˆ¶ï¼ˆConcurrency controlï¼‰
- âœ… å¢“ç¢‘æ ‡è®°åˆ é™¤ï¼ˆTombstone deletionï¼‰

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Hash Index Database            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å†…å­˜å“ˆå¸Œè¡¨ (HashMap)                    â”‚
â”‚  key -> FileOffset {segmentID, offset}  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç£ç›˜æ®µæ–‡ä»¶ (Segments)                   â”‚
â”‚  segment-0.log (active)                 â”‚
â”‚  segment-1.log (compacting)             â”‚
â”‚  segment-2.log (immutable)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

**å†™å…¥æµç¨‹**ï¼š
```
å†™å…¥ key=123, value="London"
    â†“
è¿½åŠ åˆ° active segment
    â†“
æ›´æ–°å†…å­˜å“ˆå¸Œè¡¨: 123 -> {segmentID=0, offset=1024}
    â†“
æ£€æŸ¥ segment å¤§å°ï¼Œæ˜¯å¦éœ€è¦åˆ›å»ºæ–° segment
```

**è¯»å–æµç¨‹**ï¼š
```
è¯»å– key=123
    â†“
æŸ¥æ‰¾å†…å­˜å“ˆå¸Œè¡¨
    â†“
å®šä½ {segmentID=0, offset=1024}
    â†“
ä»ç£ç›˜è¯»å–å¹¶è§£æ
    â†“
è¿”å› value="London"
```

**å‹ç¼©æµç¨‹**ï¼š
```
åå°çº¿ç¨‹å®šæœŸè§¦å‘
    â†“
é€‰æ‹©å¤šä¸ªæ—§æ®µåˆå¹¶
    â†“
éå†æ¯ä¸ªæ®µï¼Œä¿ç•™æ¯ä¸ª key çš„æœ€æ–°å€¼
    â†“
å†™å…¥æ–°æ®µï¼Œæ›´æ–°å“ˆå¸Œè¡¨
    â†“
åˆ é™¤æ—§æ®µæ–‡ä»¶
```

---

## é¡¹ç›®ç»“æ„

```
hash-index-db/
â”œâ”€â”€ main.go                    # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ go.mod                     # ä¾èµ–ç®¡ç†
â”œâ”€â”€ README.md                  # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ IMPLEMENTATION_GUIDE.md    # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ db.go             # æ•°æ®åº“æ ¸å¿ƒæ¥å£
â”‚   â”‚   â”œâ”€â”€ segment.go        # æ®µæ–‡ä»¶ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ compaction.go     # å‹ç¼©é€»è¾‘
â”‚   â”‚   â””â”€â”€ recovery.go       # å´©æºƒæ¢å¤
â”‚   â”‚
â”‚   â”œâ”€â”€ index/
â”‚   â”‚   â””â”€â”€ hashindex.go      # å†…å­˜å“ˆå¸Œç´¢å¼•
â”‚   â”‚
â”‚   â””â”€â”€ encoding/
â”‚       â””â”€â”€ record.go         # è®°å½•ç¼–ç /è§£ç 
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ db_test.go            # æ•°æ®åº“åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ compaction_test.go    # å‹ç¼©æµ‹è¯•
â”‚   â”œâ”€â”€ benchmark_test.go     # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â””â”€â”€ crash_test.go         # å´©æºƒæ¢å¤æµ‹è¯•
â”‚
â””â”€â”€ examples/
    â”œâ”€â”€ basic_usage.go        # åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹
    â””â”€â”€ benchmark.go          # æ€§èƒ½æµ‹è¯•ç¤ºä¾‹
```

---

## å®ç°æ­¥éª¤

### Phase 1: åŸºç¡€ç»“æ„ï¼ˆç¬¬ 1-2 å¤©ï¼‰

#### Step 1.1: å®šä¹‰æ ¸å¿ƒæ•°æ®ç»“æ„

**æ–‡ä»¶**: `pkg/encoding/record.go`

```go
// Record è¡¨ç¤ºä¸€æ¡æ—¥å¿—è®°å½•
type Record struct {
    Key       string
    Value     string
    Timestamp int64  // Unix çº³ç§’æ—¶é—´æˆ³
    Tombstone bool   // æ˜¯å¦ä¸ºå¢“ç¢‘æ ‡è®°ï¼ˆåˆ é™¤ï¼‰
}

// FileOffset è¡¨ç¤ºæ–‡ä»¶åç§»é‡
type FileOffset struct {
    SegmentID int    // æ®µæ–‡ä»¶ ID
    Offset    int64  // æ–‡ä»¶å†…åç§»é‡
    Size      int64  // è®°å½•å¤§å°
}
```

**è®°å½•ç¼–ç æ ¼å¼**ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRC (4 byte) â”‚ Timestamp    â”‚ Key Size    â”‚ Value Size â”‚ Flags     â”‚ Key     â”‚
â”‚              â”‚ (8 byte)     â”‚ (4 byte)    â”‚ (4 byte)   â”‚ (1 byte)  â”‚ (var)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    Value (var)
```

**éœ€è¦å®ç°çš„æ–¹æ³•**ï¼š
- `Encode() []byte` - åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„
- `Decode([]byte) (Record, error)` - ä»å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–
- `CalculateCRC(data []byte) uint32` - è®¡ç®—æ ¡éªŒå’Œ

---

#### Step 1.2: å®ç°æ®µæ–‡ä»¶ç®¡ç†

**æ–‡ä»¶**: `pkg/db/segment.go`

```go
// Segment è¡¨ç¤ºä¸€ä¸ªæ®µæ–‡ä»¶
type Segment struct {
    ID       int
    FilePath string
    file     *os.File
    size     int64
    mu       sync.RWMutex
}
```

**éœ€è¦å®ç°çš„æ–¹æ³•**ï¼š

1. **NewSegment(id int, dirPath string) (*Segment, error)**
   - åˆ›å»ºæ–°æ®µæ–‡ä»¶
   - æ–‡ä»¶å‘½åï¼š`segment-{id}.log`

2. **Append(record Record) (FileOffset, error)**
   - è¿½åŠ è®°å½•åˆ°æ®µæ–‡ä»¶
   - è¿”å›æ–‡ä»¶åç§»é‡
   - çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨äº’æ–¥é”ï¼‰

3. **Read(offset int64) (Record, error)**
   - ä»æŒ‡å®šåç§»é‡è¯»å–è®°å½•
   - éªŒè¯ CRC æ ¡éªŒå’Œ
   - å¤„ç†æŸåçš„è®°å½•

4. **Close() error**
   - å…³é—­æ–‡ä»¶å¥æŸ„

5. **Size() int64**
   - è¿”å›å½“å‰æ®µå¤§å°

**å…³é”®ç‚¹**ï¼š
- æ‰€æœ‰å†™å…¥æ“ä½œéœ€è¦åŠ **å†™é”**
- è¯»å–æ“ä½œåŠ **è¯»é”**
- å†™å…¥åç«‹å³ `Sync()` ç¡®ä¿æ•°æ®æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼Œæ€§èƒ½ vs å¯é æ€§æƒè¡¡ï¼‰

---

#### Step 1.3: å®ç°å†…å­˜å“ˆå¸Œç´¢å¼•

**æ–‡ä»¶**: `pkg/index/hashindex.go`

```go
// HashIndex å†…å­˜å“ˆå¸Œç´¢å¼•
type HashIndex struct {
    index map[string]FileOffset
    mu    sync.RWMutex
}
```

**éœ€è¦å®ç°çš„æ–¹æ³•**ï¼š

1. **NewHashIndex() *HashIndex**
   - åˆå§‹åŒ–ç©ºçš„å“ˆå¸Œè¡¨

2. **Put(key string, offset FileOffset)**
   - æ›´æ–°ç´¢å¼•
   - çº¿ç¨‹å®‰å…¨

3. **Get(key string) (FileOffset, bool)**
   - æŸ¥æ‰¾ç´¢å¼•
   - è¿”å›åç§»é‡å’Œæ˜¯å¦å­˜åœ¨

4. **Delete(key string)**
   - åˆ é™¤ç´¢å¼•é¡¹

5. **Len() int**
   - è¿”å›ç´¢å¼•ä¸­é”®çš„æ•°é‡

6. **Keys() []string**
   - è¿”å›æ‰€æœ‰é”®ï¼ˆç”¨äºå‹ç¼©ï¼‰

---

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆç¬¬ 3-4 å¤©ï¼‰

#### Step 2.1: å®ç°æ•°æ®åº“æ ¸å¿ƒæ¥å£

**æ–‡ä»¶**: `pkg/db/db.go`

```go
// DB æ•°æ®åº“æ ¸å¿ƒç»“æ„
type DB struct {
    dirPath       string
    segments      []*Segment         // æ‰€æœ‰æ®µï¼Œæœ€æ–°çš„åœ¨å‰
    activeSegment *Segment           // å½“å‰æ´»è·ƒæ®µ
    index         *index.HashIndex   // å†…å­˜ç´¢å¼•

    maxSegmentSize int64             // æ®µå¤§å°é˜ˆå€¼ï¼ˆå¦‚ 1MBï¼‰

    mu            sync.RWMutex       // ä¿æŠ¤ segments å’Œ activeSegment
    compactionMu  sync.Mutex         // å‹ç¼©é”

    stopCh        chan struct{}      // åœæ­¢ä¿¡å·
    wg            sync.WaitGroup     // ç­‰å¾…åå°ä»»åŠ¡
}
```

**éœ€è¦å®ç°çš„æ–¹æ³•**ï¼š

1. **Open(dirPath string, opts Options) (*DB, error)**
   - æ‰“å¼€æˆ–åˆ›å»ºæ•°æ®åº“
   - åŠ è½½æ‰€æœ‰æ®µæ–‡ä»¶
   - é‡å»ºå†…å­˜ç´¢å¼•ï¼ˆæ‰«ææ‰€æœ‰æ®µï¼‰
   - å¯åŠ¨åå°å‹ç¼©åç¨‹

2. **Put(key, value string) error**
   - åˆ›å»º Record
   - è¿½åŠ åˆ° activeSegment
   - æ›´æ–°å†…å­˜ç´¢å¼•
   - æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨åˆ°æ–°æ®µ

3. **Get(key string) (string, error)**
   - ä»ç´¢å¼•æŸ¥æ‰¾ FileOffset
   - ä»å¯¹åº”æ®µè¯»å–è®°å½•
   - æ£€æŸ¥æ˜¯å¦ä¸ºå¢“ç¢‘
   - è¿”å› value

4. **Delete(key string) error**
   - å†™å…¥å¢“ç¢‘æ ‡è®°ï¼ˆTombstone=trueï¼‰
   - æ›´æ–°ç´¢å¼•ï¼ˆæˆ–åˆ é™¤ç´¢å¼•é¡¹ï¼‰

5. **Close() error**
   - åœæ­¢åå°åç¨‹
   - å…³é—­æ‰€æœ‰æ®µæ–‡ä»¶
   - ç­‰å¾…ä»»åŠ¡å®Œæˆ

**å…³é”®é€»è¾‘**ï¼š

**æ»šåŠ¨æ–°æ®µ**ï¼š
```go
func (db *DB) maybeRotateSegment() error {
    if db.activeSegment.Size() >= db.maxSegmentSize {
        // 1. å…³é—­å½“å‰æ´»è·ƒæ®µï¼ˆå˜ä¸ºåªè¯»ï¼‰
        // 2. åˆ›å»ºæ–°æ®µä½œä¸ºæ´»è·ƒæ®µ
        // 3. æ›´æ–° db.segments åˆ—è¡¨
    }
}
```

---

### Phase 3: æ®µå‹ç¼©ï¼ˆç¬¬ 5-6 å¤©ï¼‰

#### Step 3.1: å®ç°å‹ç¼©é€»è¾‘

**æ–‡ä»¶**: `pkg/db/compaction.go`

```go
// CompactionWorker åå°å‹ç¼©åç¨‹
func (db *DB) CompactionWorker() {
    ticker := time.NewTicker(30 * time.Second) // æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            db.maybeCompact()
        case <-db.stopCh:
            return
        }
    }
}
```

**å‹ç¼©ç­–ç•¥**ï¼š

1. **é€‰æ‹©å¾…å‹ç¼©æ®µ**ï¼š
   - é™¤äº†å½“å‰æ´»è·ƒæ®µï¼Œå…¶ä»–æ®µéƒ½å¯ä»¥å‹ç¼©
   - å¯ä»¥ä¸€æ¬¡å‹ç¼©å¤šä¸ªæ®µï¼ˆå¦‚æœ€æ—§çš„ 3 ä¸ªæ®µï¼‰

2. **åˆå¹¶æ®µ**ï¼š
   ```go
   func (db *DB) compactSegments(segments []*Segment) error {
       // 1. åˆ›å»ºä¸´æ—¶æ–°æ®µ
       // 2. éå†æ¯ä¸ªæ—§æ®µçš„è®°å½•
       // 3. å¯¹äºæ¯ä¸ª keyï¼Œåªä¿ç•™æœ€æ–°å€¼ï¼ˆé€šè¿‡ç´¢å¼•åˆ¤æ–­ï¼‰
       // 4. è·³è¿‡å¢“ç¢‘æ ‡è®°
       // 5. å†™å…¥æ–°æ®µ
       // 6. åŸå­æ›¿æ¢ï¼ˆæ›´æ–° db.segmentsï¼Œåˆ é™¤æ—§æ–‡ä»¶ï¼‰
   }
   ```

3. **å…³é”®ç‚¹**ï¼š
   - å‹ç¼©æ—¶éœ€è¦åŠ é”ï¼ˆ`compactionMu`ï¼‰
   - å‹ç¼©ä¸é˜»å¡è¯»å†™ï¼ˆCopy-on-Write æ€æƒ³ï¼‰
   - å‹ç¼©å®ŒæˆååŸå­æ›¿æ¢æ®µåˆ—è¡¨
   - åˆ é™¤æ—§æ®µæ–‡ä»¶å‰ç¡®ä¿æ²¡æœ‰è¯»æ“ä½œå¼•ç”¨

**åˆ¤æ–­è®°å½•æ˜¯å¦ä¿ç•™**ï¼š
```go
// åªä¿ç•™å½“å‰ç´¢å¼•æŒ‡å‘è¯¥æ®µçš„è®°å½•
func shouldKeep(key string, segmentID int, offset int64, index *HashIndex) bool {
    currentOffset, exists := index.Get(key)
    if !exists {
        return false // å·²è¢«åˆ é™¤
    }
    // åªæœ‰å½“å‰ç´¢å¼•æŒ‡å‘è¯¥ä½ç½®æ—¶æ‰ä¿ç•™
    return currentOffset.SegmentID == segmentID && currentOffset.Offset == offset
}
```

---

### Phase 4: å¯é æ€§ä¿éšœï¼ˆç¬¬ 7 å¤©ï¼‰

#### Step 4.1: å´©æºƒæ¢å¤

**æ–‡ä»¶**: `pkg/db/recovery.go`

```go
// RebuildIndex é‡å»ºå†…å­˜ç´¢å¼•
func (db *DB) RebuildIndex() error {
    // 1. åŠ è½½æ‰€æœ‰æ®µæ–‡ä»¶ï¼ˆæŒ‰ ID æ’åºï¼‰
    // 2. ä»æ—§åˆ°æ–°æ‰«ææ¯ä¸ªæ®µ
    // 3. è§£ææ¯æ¡è®°å½•ï¼Œæ›´æ–°ç´¢å¼•
    // 4. å¦‚æœé‡åˆ°å¢“ç¢‘ï¼Œåˆ é™¤ç´¢å¼•é¡¹
    // 5. å¦‚æœé‡åˆ°æŸåè®°å½•ï¼ˆCRC æ ¡éªŒå¤±è´¥ï¼‰ï¼Œè·³è¿‡æˆ–æˆªæ–­
}
```

**å¿«ç…§ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼š
- å®šæœŸä¿å­˜ç´¢å¼•å¿«ç…§åˆ°æ–‡ä»¶ï¼ˆ`index-snapshot.json`ï¼‰
- æ¢å¤æ—¶å…ˆåŠ è½½å¿«ç…§ï¼Œå†é‡æ”¾å¢é‡æ®µ
- åŠ å¿«å¯åŠ¨é€Ÿåº¦

---

#### Step 4.2: å¹¶å‘æ§åˆ¶

**é”çš„ä½¿ç”¨è§„åˆ™**ï¼š

1. **Segment çº§åˆ«**ï¼š
   - è¯»æ“ä½œï¼š`RLock`
   - å†™æ“ä½œï¼š`Lock`

2. **DB çº§åˆ«**ï¼š
   - è¯»å†™ segments åˆ—è¡¨ï¼š`db.mu`
   - å‹ç¼©æ“ä½œï¼š`db.compactionMu`ï¼ˆç‹¬ç«‹é”ï¼Œé¿å…é˜»å¡è¯»å†™ï¼‰

3. **HashIndex çº§åˆ«**ï¼š
   - è¯»ç´¢å¼•ï¼š`RLock`
   - æ›´æ–°ç´¢å¼•ï¼š`Lock`

**æ— é”ä¼˜åŒ–**ï¼ˆé«˜çº§ï¼‰ï¼š
- ä½¿ç”¨ `sync.Map` æ›¿ä»£ `map + RWMutex`
- æ´»è·ƒæ®µä½¿ç”¨å•ç‹¬çš„ channel åºåˆ—åŒ–å†™å…¥

---

### Phase 5: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆç¬¬ 8-9 å¤©ï¼‰

#### Step 5.1: å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `tests/db_test.go`

æµ‹è¯•ç”¨ä¾‹ï¼š
1. **åŸºæœ¬åŠŸèƒ½**ï¼š
   - `TestPutGet` - å†™å…¥åèƒ½è¯»å–
   - `TestDelete` - åˆ é™¤åè¿”å›é”™è¯¯
   - `TestUpdate` - æ›´æ–°å€¼

2. **è¾¹ç•Œæƒ…å†µ**ï¼š
   - `TestEmptyValue` - ç©ºå€¼
   - `TestLargeValue` - å¤§å€¼ï¼ˆ1MBï¼‰
   - `TestManyKeys` - å¤§é‡é”®ï¼ˆ100 ä¸‡ï¼‰

3. **å¹¶å‘æµ‹è¯•**ï¼š
   - `TestConcurrentWrites` - å¤šåç¨‹å†™å…¥
   - `TestConcurrentReads` - å¤šåç¨‹è¯»å–
   - `TestConcurrentReadWrite` - æ··åˆè¯»å†™

4. **å´©æºƒæ¢å¤**ï¼š
   - `TestRecovery` - é‡å¯åæ•°æ®ä¸ä¸¢å¤±
   - `TestPartialWrite` - éƒ¨åˆ†å†™å…¥æ£€æµ‹

---

#### Step 5.2: æ€§èƒ½åŸºå‡†æµ‹è¯•

**æ–‡ä»¶**: `tests/benchmark_test.go`

```go
// BenchmarkPut å†™å…¥æ€§èƒ½
func BenchmarkPut(b *testing.B) {
    db := setupDB(b)
    defer db.Close()

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        key := fmt.Sprintf("key-%d", i)
        value := fmt.Sprintf("value-%d", i)
        db.Put(key, value)
    }
}

// BenchmarkGet è¯»å–æ€§èƒ½
func BenchmarkGet(b *testing.B) {
    // é¢„å…ˆå†™å…¥æ•°æ®ï¼Œæµ‹è¯•éšæœºè¯»å–
}

// BenchmarkMixed æ··åˆè¯»å†™
func BenchmarkMixed(b *testing.B) {
    // 80% è¯»ï¼Œ20% å†™
}
```

**æ€§èƒ½ç›®æ ‡**ï¼š
- å†™å…¥ï¼š> 10,000 ops/s
- è¯»å–ï¼š> 50,000 ops/sï¼ˆå†…å­˜ç´¢å¼•ï¼ŒO(1) æŸ¥æ‰¾ï¼‰
- å‹ç¼©å¯¹å‰å°æ€§èƒ½å½±å“ < 10%

---

#### Step 5.3: æ€§èƒ½ä¼˜åŒ–ç‚¹

1. **æ‰¹é‡å†™å…¥**ï¼š
   - æä¾› `BatchPut([]KV)` æ¥å£
   - ä¸€æ¬¡æ€§è¿½åŠ å¤šæ¡è®°å½•ï¼Œå‡å°‘ I/O

2. **ç¼“å†²å†™å…¥**ï¼š
   - ä½¿ç”¨ `bufio.Writer` ç¼“å†²æ®µæ–‡ä»¶å†™å…¥
   - å®šæœŸ Flush

3. **Mmap ä¼˜åŒ–**ï¼ˆé«˜çº§ï¼‰ï¼š
   - ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶ä»£æ›¿ Read/Write
   - å‡å°‘ç³»ç»Ÿè°ƒç”¨

4. **Bloom Filter**ï¼ˆé«˜çº§ï¼‰ï¼š
   - ä¸ºæ¯ä¸ªæ®µç»´æŠ¤ Bloom Filter
   - å¿«é€Ÿåˆ¤æ–­ key æ˜¯å¦å¯èƒ½å­˜åœ¨

---

## é…ç½®é€‰é¡¹

```go
// Options æ•°æ®åº“é…ç½®
type Options struct {
    MaxSegmentSize  int64         // æ®µå¤§å°é˜ˆå€¼ï¼ˆé»˜è®¤ 1MBï¼‰
    CompactionInterval time.Duration // å‹ç¼©æ£€æŸ¥é—´éš”ï¼ˆé»˜è®¤ 30sï¼‰
    SyncWrites      bool          // æ˜¯å¦åŒæ­¥å†™å…¥ï¼ˆé»˜è®¤ falseï¼‰
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

```go
package main

import (
    "log"
    "github.com/rem/hash-index-db/pkg/db"
)

func main() {
    // æ‰“å¼€æ•°æ®åº“
    database, err := db.Open("./data", db.Options{
        MaxSegmentSize: 1 * 1024 * 1024, // 1MB
    })
    if err != nil {
        log.Fatal(err)
    }
    defer database.Close()

    // å†™å…¥
    database.Put("user:123", `{"name": "Alice", "age": 30}`)

    // è¯»å–
    value, err := database.Get("user:123")
    if err != nil {
        log.Fatal(err)
    }
    log.Println("Value:", value)

    // åˆ é™¤
    database.Delete("user:123")
}
```

---

## æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### 1. WALï¼ˆWrite-Ahead Logï¼‰
- å…ˆå†™ WALï¼Œå†æ›´æ–°æ®µ
- å´©æºƒæ¢å¤æ—¶é‡æ”¾ WAL

### 2. å¿«ç…§åŠŸèƒ½
- å®šæœŸä¿å­˜ç´¢å¼•å¿«ç…§
- åŠ å¿«å¯åŠ¨é€Ÿåº¦

### 3. èŒƒå›´æŸ¥è¯¢
- ç»´æŠ¤æœ‰åºè·³è¡¨ç´¢å¼•
- æ”¯æŒ `Scan(startKey, endKey)`

### 4. è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰
- Record æ·»åŠ  `ExpiresAt` å­—æ®µ
- åå°æ¸…ç†è¿‡æœŸé”®

### 5. ç»Ÿè®¡ä¿¡æ¯
- è®°å½•å‘½ä¸­ç‡ã€æ®µæ•°é‡ã€å‹ç¼©æ¬¡æ•°
- æä¾› `Stats()` æ¥å£

---

## å‚è€ƒèµ„æº

### DDIA ç›¸å…³ç« èŠ‚
- [Ch03_å­˜å‚¨ä¸æ£€ç´¢.md](../../notes/resources/books/DDIA/Ch03_å­˜å‚¨ä¸æ£€ç´¢.md)
  - å“ˆå¸Œç´¢å¼•åŸç†ï¼šç¬¬ 128-182 è¡Œ
  - æ®µå‹ç¼©ï¼šç¬¬ 184-291 è¡Œ
  - Bitcask æ¡ˆä¾‹ï¼šç¬¬ 167-181 è¡Œ

### çœŸå®é¡¹ç›®å‚è€ƒ
- [Bitcask](https://github.com/basho/bitcask) - Erlang å®ç°
- [Riak KV](https://github.com/basho/riak_kv) - ä½¿ç”¨ Bitcask ä½œä¸ºå­˜å‚¨å¼•æ“
- [BadgerDB](https://github.com/dgraph-io/badger) - Go å®ç°çš„ LSM-Treeï¼ˆæ›´å¤æ‚ï¼‰

### Go ç›¸å…³æŠ€æœ¯
- `encoding/binary` - äºŒè¿›åˆ¶ç¼–ç 
- `hash/crc32` - CRC æ ¡éªŒ
- `sync.RWMutex` - è¯»å†™é”
- `os.File` - æ–‡ä»¶æ“ä½œ

---

## éªŒæ”¶æ ‡å‡†

å®Œæˆä»¥ä¸‹æ£€æŸ¥æ¸…å•ï¼š

- [ ] **åŠŸèƒ½å®Œæ•´æ€§**
  - [ ] Put/Get/Delete æ­£å¸¸å·¥ä½œ
  - [ ] æ®µè‡ªåŠ¨æ»šåŠ¨
  - [ ] åå°å‹ç¼©è¿è¡Œ
  - [ ] å´©æºƒæ¢å¤æ­£ç¡®

- [ ] **ä»£ç è´¨é‡**
  - [ ] æ‰€æœ‰å…¬å…± API æœ‰æ–‡æ¡£æ³¨é‡Š
  - [ ] å…³é”®é€»è¾‘æœ‰ä»£ç æ³¨é‡Š
  - [ ] é”™è¯¯å¤„ç†å®Œå–„

- [ ] **æµ‹è¯•è¦†ç›–**
  - [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
  - [ ] å¹¶å‘æµ‹è¯•é€šè¿‡
  - [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ

- [ ] **æ€§èƒ½è¾¾æ ‡**
  - [ ] å†™å…¥ > 10,000 ops/s
  - [ ] è¯»å– > 50,000 ops/s
  - [ ] å†…å­˜å ç”¨åˆç†ï¼ˆç´¢å¼• < 100MB for 100 ä¸‡é”®ï¼‰

- [ ] **æ–‡æ¡£å®Œå–„**
  - [ ] README.md åŒ…å«ä½¿ç”¨è¯´æ˜
  - [ ] æ¶æ„å›¾æ¸…æ™°
  - [ ] æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

---

## å­¦ä¹ ç›®æ ‡

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œä½ åº”è¯¥æ·±å…¥ç†è§£ï¼š

1. **å­˜å‚¨å¼•æ“åŸç†**
   - è¿½åŠ æ—¥å¿—çš„ä¼˜åŠ¿ï¼ˆé¡ºåºå†™ï¼‰
   - å“ˆå¸Œç´¢å¼•çš„æƒè¡¡ï¼ˆå†…å­˜é™åˆ¶ã€æ— èŒƒå›´æŸ¥è¯¢ï¼‰

2. **å¹¶å‘æ§åˆ¶**
   - è¯»å†™é”çš„ä½¿ç”¨åœºæ™¯
   - æ— é”æ•°æ®ç»“æ„ï¼ˆsync.Mapï¼‰

3. **ç³»ç»Ÿè®¾è®¡æƒè¡¡**
   - æ€§èƒ½ vs å¯é æ€§ï¼ˆSyncWritesï¼‰
   - ç©ºé—´ vs æ—¶é—´ï¼ˆå‹ç¼©é¢‘ç‡ï¼‰
   - ä¸€è‡´æ€§ vs å¯ç”¨æ€§ï¼ˆå´©æºƒæ¢å¤ï¼‰

4. **Go å·¥ç¨‹å®è·µ**
   - é¡¹ç›®ç»“æ„ç»„ç»‡
   - é”™è¯¯å¤„ç†æ¨¡å¼
   - æ€§èƒ½æµ‹è¯•æ–¹æ³•

---

## é¢„è®¡æ—¶é—´åˆ†é…

| é˜¶æ®µ | ä»»åŠ¡ | æ—¶é—´ |
|-----|------|------|
| Phase 1 | åŸºç¡€ç»“æ„ï¼ˆRecord, Segment, HashIndexï¼‰ | 2 å¤© |
| Phase 2 | æ ¸å¿ƒåŠŸèƒ½ï¼ˆDB interface, Put/Get/Deleteï¼‰ | 2 å¤© |
| Phase 3 | æ®µå‹ç¼© | 2 å¤© |
| Phase 4 | å¯é æ€§ï¼ˆRecovery, Concurrencyï¼‰ | 1 å¤© |
| Phase 5 | æµ‹è¯•ä¸ä¼˜åŒ– | 2 å¤© |
| **æ€»è®¡** | | **9 å¤©** |

---

## è°ƒè¯•æŠ€å·§

1. **æ‰“å°æ—¥å¿—**ï¼š
   - åœ¨å…³é”®è·¯å¾„æ·»åŠ æ—¥å¿—ï¼ˆæ®µæ»šåŠ¨ã€å‹ç¼©è§¦å‘ï¼‰
   - ä½¿ç”¨ `log` åŒ…æˆ– `zerolog`

2. **å¯è§†åŒ–æ®µçŠ¶æ€**ï¼š
   ```go
   func (db *DB) DumpSegments() {
       for _, seg := range db.segments {
           fmt.Printf("Segment %d: size=%d, records=%d\n",
               seg.ID, seg.Size(), seg.RecordCount())
       }
   }
   ```

3. **å•æ­¥è°ƒè¯•**ï¼š
   - VSCode é…ç½® Go è°ƒè¯•
   - åœ¨å‹ç¼©é€»è¾‘å¤„è®¾ç½®æ–­ç‚¹

4. **Race Detector**ï¼š
   ```bash
   go test -race ./...
   ```

---

## å¸¸è§é—®é¢˜

### Q1: æ®µå‹ç¼©æ—¶å¦‚ä½•é¿å…é˜»å¡è¯»å†™ï¼Ÿ
**A**: å‹ç¼©æ“ä½œåˆ›å»ºæ–°æ®µï¼Œä¸ä¿®æ”¹æ—§æ®µã€‚å®ŒæˆååŸå­æ›¿æ¢ `db.segments` åˆ—è¡¨ã€‚è¯»å†™æ“ä½œé€šè¿‡ RLock è®¿é—®åˆ—è¡¨ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚

### Q2: å¦‚ä½•å¤„ç†éƒ¨åˆ†å†™å…¥ï¼ˆå´©æºƒæ—¶å†™äº†ä¸€åŠï¼‰ï¼Ÿ
**A**: é€šè¿‡ CRC æ ¡éªŒå’Œæ£€æµ‹ã€‚è¯»å–æ—¶éªŒè¯ CRCï¼Œå¤±è´¥åˆ™ä¸¢å¼ƒè¯¥è®°å½•ã€‚æ¢å¤æ—¶é‡åˆ°æŸåè®°å½•å¯ä»¥æˆªæ–­æ–‡ä»¶ã€‚

### Q3: å†…å­˜ç´¢å¼•å ç”¨å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ
**A**:
- çŸ­æœŸï¼šé™åˆ¶é”®çš„æ•°é‡ï¼ˆBitcask é™åˆ¶ï¼‰
- é•¿æœŸï¼šä½¿ç”¨ LSM-Treeï¼ˆSSTable + ç¨€ç–ç´¢å¼•ï¼‰

### Q4: å¦‚ä½•æ”¯æŒäº‹åŠ¡ï¼Ÿ
**A**: å½“å‰è®¾è®¡ä¸æ”¯æŒäº‹åŠ¡ã€‚è¦æ”¯æŒéœ€è¦ï¼š
- WAL + ä¸¤é˜¶æ®µæäº¤
- æˆ–ä½¿ç”¨ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆè¿™ä¸ªé¡¹ç›®åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1. **LSM-Tree å®ç°** (DDIA Ch03)
   - SSTable + å†…å­˜æ’åº
   - æ®µåˆå¹¶ç­–ç•¥ï¼ˆSize-Tiered, Leveledï¼‰
   - Bloom Filter ä¼˜åŒ–

2. **B-Tree å®ç°** (DDIA Ch03)
   - é¡µå¼å­˜å‚¨
   - èŠ‚ç‚¹åˆ†è£‚/åˆå¹¶
   - WAL æ—¥å¿—

3. **åˆ†å¸ƒå¼å­˜å‚¨** (DDIA Ch05-09)
   - æ•°æ®åˆ†ç‰‡
   - å‰¯æœ¬åŒæ­¥
   - ä¸€è‡´æ€§åè®®

ç¥ç¼–ç æ„‰å¿«ï¼ğŸš€
