# ä¸€è‡´æ€§å“ˆå¸Œç»å…¸è®ºæ–‡è¯¦è§£

> è®ºæ–‡: Consistent Hashing and Random Trees: Distributed Caching Protocols for Relieving Hot Spots on the World Wide Web
> ä½œè€…: David Karger, Eric Lehman, Tom Leighton, Rina Panigrahy, Matthew Levine, Daniel Lewin
> æœºæ„: MIT & Akamai
> å¹´ä»½: 1997

## èµ„æ–™
- [ä¸€æ–‡è®²é€ä¸€è‡´æ€§å“ˆå¸Œçš„åŸç†å’Œå®ç°](https://zhuanlan.zhihu.com/p/439268771)
- [Consistent Hashing and Random Treesç¬”è®°](https://zhenghe.gitbook.io/open-courses/papers-we-love/consistent-hashing-and-random-trees-1997)
- [å›¾è§£ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†ï¼](https://developer.aliyun.com/article/1082388)

## ç›®å½•

1. [è®ºæ–‡èƒŒæ™¯](#è®ºæ–‡èƒŒæ™¯)
2. [è¦è§£å†³çš„é—®é¢˜](#è¦è§£å†³çš„é—®é¢˜)
3. [ä¼ ç»Ÿå“ˆå¸Œçš„å±€é™](#ä¼ ç»Ÿå“ˆå¸Œçš„å±€é™)
4. [ä¸€è‡´æ€§å“ˆå¸ŒåŸç†](#ä¸€è‡´æ€§å“ˆå¸ŒåŸç†)
5. [è™šæ‹ŸèŠ‚ç‚¹](#è™šæ‹ŸèŠ‚ç‚¹)
6. [æ•°å­¦è¯æ˜](#æ•°å­¦è¯æ˜)
7. [å®é™…åº”ç”¨](#å®é™…åº”ç”¨)

---

## è®ºæ–‡èƒŒæ™¯

### æ—¶ä»£èƒŒæ™¯ (1997å¹´)

1997å¹´ï¼Œäº’è”ç½‘æ­£å¤„äºå¿«é€Ÿå‘å±•æœŸï¼š
- Webå†…å®¹çˆ†ç‚¸å¼å¢é•¿
- å•ä¸ªæœåŠ¡å™¨æ— æ³•å¤„ç†æµ·é‡è¯·æ±‚
- CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰åˆšåˆšå…´èµ·
- Akamaiå…¬å¸æ­£åœ¨è§£å†³å¦‚ä½•åˆ†å‘çƒ­ç‚¹å†…å®¹

### æ ¸å¿ƒæŒ‘æˆ˜

**é—®é¢˜**: å¦‚ä½•åœ¨å¤šå°ç¼“å­˜æœåŠ¡å™¨ä¹‹é—´åˆ†é…å†…å®¹ï¼Ÿ

**åœºæ™¯**: å‡è®¾æœ‰1000ä¸‡ä¸ªç½‘é¡µï¼Œ100å°ç¼“å­˜æœåŠ¡å™¨

**éœ€æ±‚**:
- âœ… è´Ÿè½½å‡è¡¡ï¼šæ¯å°æœåŠ¡å™¨å­˜å‚¨å¤§è‡´ç›¸åŒæ•°é‡çš„å†…å®¹
- âœ… æœ€å°è¿ç§»ï¼šæ·»åŠ /åˆ é™¤æœåŠ¡å™¨æ—¶ï¼Œå°½å¯èƒ½å°‘åœ°ç§»åŠ¨æ•°æ®
- âœ… é«˜æ•ˆæŸ¥æ‰¾ï¼šå¿«é€Ÿç¡®å®šæŸä¸ªå†…å®¹åœ¨å“ªå°æœåŠ¡å™¨ä¸Š

---

## è¦è§£å†³çš„é—®é¢˜

### åˆ†å¸ƒå¼ç¼“å­˜çš„æ ¸å¿ƒé—®é¢˜

**é—®é¢˜æè¿°**: ç»™å®šNä¸ªç¼“å­˜èŠ‚ç‚¹å’ŒMä¸ªå¯¹è±¡ï¼Œå¦‚ä½•åˆ†é…ï¼Ÿ

#### éœ€æ±‚1: è´Ÿè½½å‡è¡¡

æ¯ä¸ªèŠ‚ç‚¹åº”è¯¥å­˜å‚¨å¤§çº¦ M/N ä¸ªå¯¹è±¡

**åä¾‹**:
```
èŠ‚ç‚¹1: 90%çš„å¯¹è±¡ âŒ
èŠ‚ç‚¹2: 8%çš„å¯¹è±¡
èŠ‚ç‚¹3: 2%çš„å¯¹è±¡
```

#### éœ€æ±‚2: æœ€å°åŒ–é‡æ˜ å°„

**åœºæ™¯**: ä»Nä¸ªèŠ‚ç‚¹æ‰©å±•åˆ°N+1ä¸ªèŠ‚ç‚¹

**ç†æƒ³æƒ…å†µ**: åªç§»åŠ¨ M/(N+1) ä¸ªå¯¹è±¡ï¼ˆçº¦1/Nçš„æ•°æ®ï¼‰

**åæƒ…å†µ**: ç§»åŠ¨å¤§éƒ¨åˆ†æ•°æ® âŒ

#### éœ€æ±‚3: åˆ†æ•£æ€§ (Spread)

åŒä¸€ä¸ªå¯¹è±¡åº”è¯¥åªå­˜å‚¨åœ¨å°‘æ•°å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œä¸æ˜¯åˆ†æ•£åœ¨æ‰€æœ‰èŠ‚ç‚¹

---

## ä¼ ç»Ÿå“ˆå¸Œçš„å±€é™

### ç®€å•å“ˆå¸Œå–æ¨¡

**ç®—æ³•**:
```python
server_index = hash(object_key) % N
```

**ç¤ºä¾‹**: 10ä¸ªå¯¹è±¡ï¼Œ3å°æœåŠ¡å™¨

```
å¯¹è±¡ â†’ hashå€¼ â†’ æœåŠ¡å™¨
obj0 â†’ 12345 â†’ 12345 % 3 = 0 â†’ æœåŠ¡å™¨0
obj1 â†’ 67890 â†’ 67890 % 3 = 0 â†’ æœåŠ¡å™¨0
obj2 â†’ 11111 â†’ 11111 % 3 = 1 â†’ æœåŠ¡å™¨1
obj3 â†’ 22222 â†’ 22222 % 3 = 1 â†’ æœåŠ¡å™¨1
obj4 â†’ 33333 â†’ 33333 % 3 = 0 â†’ æœåŠ¡å™¨0
obj5 â†’ 44444 â†’ 44444 % 3 = 1 â†’ æœåŠ¡å™¨1
obj6 â†’ 55555 â†’ 55555 % 3 = 2 â†’ æœåŠ¡å™¨2
obj7 â†’ 66666 â†’ 66666 % 3 = 0 â†’ æœåŠ¡å™¨0
obj8 â†’ 77777 â†’ 77777 % 3 = 1 â†’ æœåŠ¡å™¨1
obj9 â†’ 88888 â†’ 88888 % 3 = 1 â†’ æœåŠ¡å™¨1
```

**ç»“æœ**:
```
æœåŠ¡å™¨0: obj0, obj1, obj4, obj7 (4ä¸ª)
æœåŠ¡å™¨1: obj2, obj3, obj5, obj8, obj9 (5ä¸ª)
æœåŠ¡å™¨2: obj6 (1ä¸ª)
```

### æ·»åŠ ä¸€å°æœåŠ¡å™¨ä¼šæ€æ ·ï¼Ÿ

ä»3å°å˜æˆ4å°:

```
å¯¹è±¡ â†’ åŸæœåŠ¡å™¨ â†’ æ–°æœåŠ¡å™¨
obj0 â†’ 0 â†’ 12345 % 4 = 1 âœ— éœ€è¦è¿ç§»
obj1 â†’ 0 â†’ 67890 % 4 = 2 âœ— éœ€è¦è¿ç§»
obj2 â†’ 1 â†’ 11111 % 4 = 3 âœ— éœ€è¦è¿ç§»
obj3 â†’ 1 â†’ 22222 % 4 = 2 âœ— éœ€è¦è¿ç§»
obj4 â†’ 0 â†’ 33333 % 4 = 1 âœ— éœ€è¦è¿ç§»
obj5 â†’ 1 â†’ 44444 % 4 = 0 âœ— éœ€è¦è¿ç§»
obj6 â†’ 2 â†’ 55555 % 4 = 3 âœ— éœ€è¦è¿ç§»
obj7 â†’ 0 â†’ 66666 % 4 = 2 âœ— éœ€è¦è¿ç§»
obj8 â†’ 1 â†’ 77777 % 4 = 1 âœ— éœ€è¦è¿ç§»
obj9 â†’ 1 â†’ 88888 % 4 = 0 âœ— éœ€è¦è¿ç§»
```

**ç»“æœ**: 10ä¸ªå¯¹è±¡ä¸­æœ‰9ä¸ªéœ€è¦è¿ç§»ï¼

**é—®é¢˜**: å‡ ä¹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦é‡æ–°åˆ†é… âŒ

### ä¼ ç»Ÿå“ˆå¸Œçš„ç¼ºé™·æ€»ç»“

| é—®é¢˜ | æè¿° | å½±å“ |
|------|------|------|
| **å¤§è§„æ¨¡é‡æ˜ å°„** | æ·»åŠ /åˆ é™¤èŠ‚ç‚¹å¯¼è‡´å¤§é‡æ•°æ®è¿ç§» | ç½‘ç»œæ‹¥å¡ã€æœåŠ¡ä¸­æ–­ |
| **ç¼“å­˜å¤±æ•ˆ** | æ‰€æœ‰ç¼“å­˜åŒæ—¶å¤±æ•ˆ | ç¼“å­˜é›ªå´© |
| **ä¸çµæ´»** | æ— æ³•å¹³æ»‘æ‰©å®¹ | è¿ç»´å›°éš¾ |

---

## ä¸€è‡´æ€§å“ˆå¸ŒåŸç†

### æ ¸å¿ƒæ€æƒ³

**å…³é”®åˆ›æ–°**: å°†èŠ‚ç‚¹å’Œå¯¹è±¡éƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªå“ˆå¸Œç¯ä¸Š

è€Œä¸”ç”±äºhashå‡½æ•°æ˜¯éšæœºå‡åŒ€çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¤ä¸ºèŠ‚ç‚¹å’Œå¯¹è±¡åœ¨ç¯ä¸Šæ˜¯å‡åŒ€åˆ†å¸ƒçš„

### å“ˆå¸Œç¯

**å®šä¹‰**: ä¸€ä¸ª0åˆ°2^32-1çš„ç¯å½¢ç©ºé—´

```
        0
        â†‘
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
2^32-1     1
â†         â†’
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜
        â†“
      2^32/2
```

### æ­¥éª¤è¯¦è§£

#### æ­¥éª¤1: å°†èŠ‚ç‚¹æ˜ å°„åˆ°ç¯ä¸Š

ä½¿ç”¨å“ˆå¸Œå‡½æ•°å°†èŠ‚ç‚¹æ˜ å°„åˆ°ç¯ä¸Šçš„æŸä¸ªä½ç½®ï¼š

```python
node_position = hash(node_id) % (2^32)
```

**ç¤ºä¾‹**: 3å°æœåŠ¡å™¨

```
hash("server0") = 1000 â†’ ä½ç½®1000
hash("server1") = 5000 â†’ ä½ç½®5000
hash("server2") = 9000 â†’ ä½ç½®9000
```

**ç¯ä¸Šçš„åˆ†å¸ƒ**:
```
        0
        â†‘
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â”‚       â”‚
1000 server0 â”‚
    â”‚       â”‚
    â”‚   5000â”‚
    â”‚ server1
    â”‚       â”‚
9000 server2 â”‚
    â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ­¥éª¤2: å°†å¯¹è±¡æ˜ å°„åˆ°ç¯ä¸Š

åŒæ ·ä½¿ç”¨å“ˆå¸Œå‡½æ•°ï¼š

```python
object_position = hash(object_key) % (2^32)
```

**ç¤ºä¾‹**: å‡ ä¸ªå¯¹è±¡

```
hash("obj_a") = 2000 â†’ ä½ç½®2000
hash("obj_b") = 7000 â†’ ä½ç½®7000
hash("obj_c") = 500  â†’ ä½ç½®500
```

#### æ­¥éª¤3: é¡ºæ—¶é’ˆæŸ¥æ‰¾æœ€è¿‘èŠ‚ç‚¹

**è§„åˆ™**: å¯¹è±¡å­˜å‚¨åœ¨å…¶é¡ºæ—¶é’ˆæ–¹å‘çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Š

```
ç¯ä¸Šä½ç½®: 0 â†’ 500(obj_c) â†’ 1000(server0) â†’ 2000(obj_a)
          â†’ 5000(server1) â†’ 7000(obj_b) â†’ 9000(server2) â†’ 0
```

**åˆ†é…ç»“æœ**:
```
obj_c (ä½ç½®500)  â†’ é¡ºæ—¶é’ˆ â†’ server0 (ä½ç½®1000)
obj_a (ä½ç½®2000) â†’ é¡ºæ—¶é’ˆ â†’ server1 (ä½ç½®5000)
obj_b (ä½ç½®7000) â†’ é¡ºæ—¶é’ˆ â†’ server2 (ä½ç½®9000)
```

### å¯è§†åŒ–

```
         0
         â†‘
     â”Œâ”€â”€â”€â”´â”€â”€â”€â”
     â”‚ obj_c â”‚
     â”‚  500  â”‚
  1000  â†â”€â”€â”˜â”‚
server0     â”‚
     â”‚      â”‚
     â”‚      â”‚
  2000      â”‚
  obj_a     â”‚
     â”‚      â”‚
     â”‚  5000â”‚
     â”‚ server1
     â”‚      â”‚
  7000      â”‚
  obj_b     â”‚
     â”‚      â”‚
     â”‚  9000â”‚
     â””â†’ server2
         â†“
```

### æ·»åŠ èŠ‚ç‚¹çš„æƒ…å†µ

**æ·»åŠ  server3**: `hash("server3") = 3000`

**æ–°ç¯**:
```
0 â†’ 500(obj_c) â†’ 1000(server0) â†’ 2000(obj_a)
â†’ 3000(server3) â†’ 5000(server1) â†’ 7000(obj_b)
â†’ 9000(server2) â†’ 0
```

**å˜åŒ–**:
```
obj_c: server0 â†’ server0 âœ“ ä¸å˜
obj_a: server1 â†’ server3 âœ— è¿ç§»åˆ°æ–°èŠ‚ç‚¹
obj_b: server2 â†’ server2 âœ“ ä¸å˜
```

**ç»“æœ**: åªæœ‰1/3çš„æ•°æ®éœ€è¦è¿ç§»ï¼

### åˆ é™¤èŠ‚ç‚¹çš„æƒ…å†µ

**åˆ é™¤ server1** (ä½ç½®5000)

**æ–°ç¯**:
```
0 â†’ 500(obj_c) â†’ 1000(server0) â†’ 2000(obj_a)
â†’ 7000(obj_b) â†’ 9000(server2) â†’ 0
```

**å˜åŒ–**:
```
obj_c: server0 â†’ server0 âœ“ ä¸å˜
obj_a: server1 â†’ server2 âœ— è¿ç§»åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
obj_b: server2 â†’ server2 âœ“ ä¸å˜
```

### ä¸€è‡´æ€§å“ˆå¸Œçš„ä¼˜åŠ¿

| ç‰¹æ€§ | ä¼ ç»Ÿå“ˆå¸Œ | ä¸€è‡´æ€§å“ˆå¸Œ |
|------|----------|-----------|
| **æ•°æ®è¿ç§»é‡** | å‡ ä¹å…¨éƒ¨ (K/N â†’ å…¨éƒ¨) | çº¦1/N |
| **å½±å“èŒƒå›´** | æ‰€æœ‰èŠ‚ç‚¹ | ç›¸é‚»èŠ‚ç‚¹ |
| **æ‰©å±•æ€§** | å·® | å¥½ |
| **çµæ´»æ€§** | ä½ | é«˜ |

---

## è™šæ‹ŸèŠ‚ç‚¹

### é—®é¢˜ï¼šèŠ‚ç‚¹åˆ†å¸ƒä¸å‡

**åœºæ™¯**: 3ä¸ªèŠ‚ç‚¹éšæœºåˆ†å¸ƒ

```
      0
      â†‘
  â”Œâ”€â”€â”€â”´â”€â”€â”€â”
100       â”‚
server0   â”‚
  â”‚       â”‚
200  â†â”€â”€â”€â”€â”˜
server1
  â”‚
250
server2
  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**:
- server0è´Ÿè´£ [250, 100) = çº¦85%çš„ç¯
- server1è´Ÿè´£ [100, 200) = çº¦10%çš„ç¯
- server2è´Ÿè´£ [200, 250) = çº¦5%çš„ç¯

**ä¸¥é‡ä¸å‡è¡¡ï¼** âŒ

### è§£å†³æ–¹æ¡ˆï¼šè™šæ‹ŸèŠ‚ç‚¹

**æ ¸å¿ƒæ€æƒ³**: æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹

#### å®ç°

**æ­¥éª¤1**: ä¸ºæ¯ä¸ªç‰©ç†èŠ‚ç‚¹åˆ›å»ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹

```python
def create_virtual_nodes(node_id, num_virtual):
    virtual_nodes = []
    for i in range(num_virtual):
        virtual_id = f"{node_id}#vnode{i}"
        position = hash(virtual_id) % (2^32)
        virtual_nodes.append((position, node_id))
    return virtual_nodes
```

**ç¤ºä¾‹**: server0åˆ›å»º3ä¸ªè™šæ‹ŸèŠ‚ç‚¹

```python
hash("server0#vnode0") = 1000
hash("server0#vnode1") = 5000
hash("server0#vnode2") = 8000
```

#### å®Œæ•´ç¤ºä¾‹

**3ä¸ªç‰©ç†èŠ‚ç‚¹ï¼Œæ¯ä¸ª3ä¸ªè™šæ‹ŸèŠ‚ç‚¹**:

```
server0:
  vnode0 â†’ 1000
  vnode1 â†’ 5000
  vnode2 â†’ 8000

server1:
  vnode0 â†’ 2000
  vnode1 â†’ 6000
  vnode2 â†’ 9000

server2:
  vnode0 â†’ 3000
  vnode1 â†’ 4000
  vnode2 â†’ 7000
```

**ç¯ä¸Šåˆ†å¸ƒ**:
```
0 â†’ 1000(s0#v0) â†’ 2000(s1#v0) â†’ 3000(s2#v0)
â†’ 4000(s2#v1) â†’ 5000(s0#v1) â†’ 6000(s1#v1)
â†’ 7000(s2#v2) â†’ 8000(s0#v2) â†’ 9000(s1#v2) â†’ 0
```

**æ•°æ®åˆ†å¸ƒ**:
```
[9000, 1000): server0 â†’ çº¦11%
[1000, 2000): server0 â†’ çº¦11%
[2000, 3000): server1 â†’ çº¦11%
[3000, 4000): server2 â†’ çº¦11%
[4000, 5000): server2 â†’ çº¦11%
[5000, 6000): server0 â†’ çº¦11%
[6000, 7000): server1 â†’ çº¦11%
[7000, 8000): server2 â†’ çº¦11%
[8000, 9000): server0 â†’ çº¦11%
```

**æ€»è®¡**:
- server0: 4ä¸ªåŒºé—´ = çº¦44%
- server1: 3ä¸ªåŒºé—´ = çº¦33%
- server2: 3ä¸ªåŒºé—´ = çº¦33%

**æ›´å‡è¡¡äº†ï¼** (è™½ç„¶ä¸å®Œç¾ï¼Œä½†æ¯”æ²¡æœ‰è™šæ‹ŸèŠ‚ç‚¹å¥½å¾ˆå¤š)

### è™šæ‹ŸèŠ‚ç‚¹æ•°é‡çš„å½±å“

è®ºæ–‡ä¸­çš„æ•°å­¦åˆ†æè¡¨æ˜ï¼š

| è™šæ‹ŸèŠ‚ç‚¹æ•° | è´Ÿè½½å‡è¡¡æ€§ | å†…å­˜å¼€é”€ |
|-----------|-----------|----------|
| **1ä¸ª** | å¾ˆå·® | å¾ˆä½ |
| **10ä¸ª** | è¾ƒå·® | ä½ |
| **100ä¸ª** | è‰¯å¥½ | ä¸­ç­‰ |
| **150ä¸ª** | å¾ˆå¥½ | ä¸­ç­‰ |
| **1000ä¸ª** | ä¼˜ç§€ | è¾ƒé«˜ |

**è®ºæ–‡å»ºè®®**: æ¯ä¸ªèŠ‚ç‚¹100-200ä¸ªè™šæ‹ŸèŠ‚ç‚¹

### è™šæ‹ŸèŠ‚ç‚¹çš„æ•°å­¦åŸç†

**å®šç†**: å½“è™šæ‹ŸèŠ‚ç‚¹æ•°ä¸ºKæ—¶ï¼Œæœ€å¤§è´Ÿè½½ä¸è¶…è¿‡å¹³å‡è´Ÿè½½çš„ O(log(N)/K) å€

**å«ä¹‰**: è™šæ‹ŸèŠ‚ç‚¹è¶Šå¤šï¼Œè´Ÿè½½è¶Šå‡è¡¡

**è¯æ˜æ€è·¯** (ç®€åŒ–):

1. å°†ç¯åˆ†æˆK*Nä¸ªå°æ®µ
2. æ¯ä¸ªå°æ®µè¢«éšæœºåˆ†é…åˆ°æŸä¸ªèŠ‚ç‚¹
3. ä½¿ç”¨Chernoffç•Œé™è¯æ˜åå·®å¾ˆå°

---

## æ•°å­¦è¯æ˜

### å®šç†1: æœ€å°è¿ç§»

**å®šç†**: å½“æ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒæœŸæœ›çš„æ•°æ®è¿ç§»é‡ä¸º O(K/N)ï¼Œå…¶ä¸­Kæ˜¯å¯¹è±¡æ€»æ•°ï¼ŒNæ˜¯èŠ‚ç‚¹æ€»æ•°ã€‚

**è¯æ˜** (ç›´è§‚ç†è§£):

1. **ç¯çš„æ€»é•¿åº¦**: 2^32
2. **æ¯ä¸ªèŠ‚ç‚¹çš„å¹³å‡è´Ÿè´£åŒºåŸŸ**: 2^32 / N
3. **æ·»åŠ æ–°èŠ‚ç‚¹**:
   - æ–°èŠ‚ç‚¹å æ®ç¯ä¸Šçš„ä¸€ä¸ªä½ç½®
   - å¹³å‡ä»æ¯ä¸ªå·²æœ‰èŠ‚ç‚¹"æŠ¢èµ°"ä¸€éƒ¨åˆ†æ•°æ®
   - æ€»å…±æŠ¢èµ° 2^32 / (N+1) çš„åŒºåŸŸ
   - è¿™ä¸ªåŒºåŸŸå†…çš„å¯¹è±¡æ•°çº¦ä¸º K / (N+1) â‰ˆ K/N

**ç»“è®º**: æ•°æ®è¿ç§»é‡ = O(K/N) = O(1/N) çš„æ•°æ®æ¯”ä¾‹

### å®šç†2: è´Ÿè½½å‡è¡¡

**å®šç†**: ä½¿ç”¨Kä¸ªè™šæ‹ŸèŠ‚ç‚¹æ—¶ï¼Œæ¯ä¸ªç‰©ç†èŠ‚ç‚¹çš„è´Ÿè½½åœ¨ (1 - Îµ) * M/N åˆ° (1 + Îµ) * M/N ä¹‹é—´çš„æ¦‚ç‡å¾ˆé«˜ï¼Œå…¶ä¸­ Îµ = O(âˆš(log N / K))

**å«ä¹‰**: è™šæ‹ŸèŠ‚ç‚¹è¶Šå¤šï¼Œè´Ÿè½½è¶Šå‡è¡¡

### å®šç†3: å•è°ƒæ€§

**å•è°ƒæ€§**: æ·»åŠ èŠ‚ç‚¹æ—¶ï¼Œä¸ä¼šå¯¼è‡´å·²æœ‰çš„æ˜ å°„å…³ç³»å¤±æ•ˆï¼ˆé™¤éè¢«æ–°èŠ‚ç‚¹æ¥ç®¡ï¼‰

**è¯æ˜**:
- å¯¹è±¡objæ˜ å°„åˆ°èŠ‚ç‚¹A
- æ·»åŠ æ–°èŠ‚ç‚¹B
- å¦‚æœBä¸åœ¨objå’ŒAä¹‹é—´ï¼Œobjä»ç„¶æ˜ å°„åˆ°A
- å¦‚æœBåœ¨objå’ŒAä¹‹é—´ï¼Œobjæ˜ å°„åˆ°Bï¼ˆè¿™æ˜¯å¿…è¦çš„è¿ç§»ï¼‰

---

## å®é™…åº”ç”¨

### è®ºæ–‡æå‡ºçš„åº”ç”¨åœºæ™¯

#### 1. Webç¼“å­˜

**é—®é¢˜**: 1000ä¸‡ç½‘é¡µï¼Œ100å°ç¼“å­˜æœåŠ¡å™¨

**ä¼ ç»Ÿæ–¹æ¡ˆ**:
```
cache_server = hash(url) % 100
```
- æ·»åŠ 1å°æœåŠ¡å™¨ â†’ 99%çš„ç¼“å­˜å¤±æ•ˆ âŒ

**ä¸€è‡´æ€§å“ˆå¸Œæ–¹æ¡ˆ**:
```
cache_server = consistent_hash(url, servers)
```
- æ·»åŠ 1å°æœåŠ¡å™¨ â†’ 1%çš„ç¼“å­˜å¤±æ•ˆ âœ…

#### 2. è´Ÿè½½å‡è¡¡

**åœºæ™¯**: å°†ç”¨æˆ·è¯·æ±‚åˆ†é…åˆ°åº”ç”¨æœåŠ¡å™¨

**ä¼˜åŠ¿**:
- åŒä¸€ç”¨æˆ·æ€»æ˜¯è·¯ç”±åˆ°åŒä¸€æœåŠ¡å™¨ï¼ˆä¼šè¯ä¿æŒï¼‰
- æ·»åŠ æœåŠ¡å™¨åªå½±å“å°‘é‡ç”¨æˆ·

#### 3. åˆ†å¸ƒå¼å­˜å‚¨

**åœºæ™¯**: å°†æ–‡ä»¶åˆ†å¸ƒåœ¨å¤šä¸ªå­˜å‚¨èŠ‚ç‚¹

**ä¼˜åŠ¿**:
- æ·»åŠ å­˜å‚¨èŠ‚ç‚¹æ—¶æœ€å°åŒ–æ•°æ®è¿ç§»
- èŠ‚ç‚¹æ•…éšœæ—¶å½±å“èŒƒå›´å°

### ç°ä»£åº”ç”¨å®ä¾‹

#### Amazon DynamoDB

**ä½¿ç”¨åœºæ™¯**: åˆ†åŒºé”®çš„åˆ†å¸ƒ

```python
partition = consistent_hash(partition_key, partitions)
```

**ä¼˜åŠ¿**: åŠ¨æ€æ‰©å®¹æ—¶æ•°æ®è¿ç§»æœ€å°

#### Cassandra

**ä½¿ç”¨åœºæ™¯**: æ•°æ®åœ¨èŠ‚ç‚¹é—´çš„åˆ†å¸ƒ

```
æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç¯ä¸Šçš„ä¸€æ®µåŒºåŸŸ
ä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹(é»˜è®¤256ä¸ª)æé«˜å‡è¡¡æ€§
```

#### Memcached / Redis Cluster

**ä½¿ç”¨åœºæ™¯**: ç¼“å­˜é”®çš„åˆ†å¸ƒ

```python
cache_node = consistent_hash(cache_key, nodes)
```

#### CDN (Akamai)

**ä½¿ç”¨åœºæ™¯**: å†…å®¹åˆ†å‘åˆ°è¾¹ç¼˜èŠ‚ç‚¹

```
åŸå§‹è®ºæ–‡çš„ç›´æ¥åº”ç”¨
æ¯ä¸ªå†…å®¹è¢«ç¼“å­˜åœ¨å¤šä¸ªè¾¹ç¼˜èŠ‚ç‚¹
```

### å®ç°ç¤ºä¾‹ (Python)

```python
import hashlib
import bisect

class ConsistentHash:
    def __init__(self, nodes=None, virtual_nodes=150):
        """
        nodes: ç‰©ç†èŠ‚ç‚¹åˆ—è¡¨
        virtual_nodes: æ¯ä¸ªç‰©ç†èŠ‚ç‚¹çš„è™šæ‹ŸèŠ‚ç‚¹æ•°
        """
        self.virtual_nodes = virtual_nodes
        self.ring = {}  # å“ˆå¸Œç¯: {hashå€¼: ç‰©ç†èŠ‚ç‚¹}
        self.sorted_keys = []  # æ’åºçš„å“ˆå¸Œå€¼åˆ—è¡¨

        if nodes:
            for node in nodes:
                self.add_node(node)

    def _hash(self, key):
        """è®¡ç®—å“ˆå¸Œå€¼"""
        return int(hashlib.md5(key.encode()).hexdigest(), 16)

    def add_node(self, node):
        """æ·»åŠ ç‰©ç†èŠ‚ç‚¹ï¼ˆåˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼‰"""
        for i in range(self.virtual_nodes):
            virtual_key = f"{node}#vnode{i}"
            hash_value = self._hash(virtual_key)
            self.ring[hash_value] = node
            # æ’å…¥åˆ°æ’åºåˆ—è¡¨ä¸­
            bisect.insort(self.sorted_keys, hash_value)

    def remove_node(self, node):
        """åˆ é™¤ç‰©ç†èŠ‚ç‚¹ï¼ˆåˆ é™¤æ‰€æœ‰è™šæ‹ŸèŠ‚ç‚¹ï¼‰"""
        for i in range(self.virtual_nodes):
            virtual_key = f"{node}#vnode{i}"
            hash_value = self._hash(virtual_key)
            del self.ring[hash_value]
            self.sorted_keys.remove(hash_value)

    def get_node(self, key):
        """è·å–å¯¹è±¡åº”è¯¥å­˜å‚¨çš„èŠ‚ç‚¹"""
        if not self.ring:
            return None

        hash_value = self._hash(key)

        # äºŒåˆ†æŸ¥æ‰¾: æ‰¾åˆ°ç¬¬ä¸€ä¸ª >= hash_value çš„èŠ‚ç‚¹
        idx = bisect.bisect_right(self.sorted_keys, hash_value)

        # ç¯å½¢: å¦‚æœè¶…å‡ºèŒƒå›´ï¼Œå›åˆ°å¼€å¤´
        if idx == len(self.sorted_keys):
            idx = 0

        return self.ring[self.sorted_keys[idx]]

# ä½¿ç”¨ç¤ºä¾‹
ch = ConsistentHash()
ch.add_node("server0")
ch.add_node("server1")
ch.add_node("server2")

# æŸ¥è¯¢å¯¹è±¡åº”è¯¥åœ¨å“ªä¸ªèŠ‚ç‚¹
print(ch.get_node("object_a"))  # å¯èƒ½è¾“å‡º: server1
print(ch.get_node("object_b"))  # å¯èƒ½è¾“å‡º: server0

# æ·»åŠ æ–°èŠ‚ç‚¹
ch.add_node("server3")
# åªæœ‰å°‘é‡å¯¹è±¡çš„æ˜ å°„ä¼šæ”¹å˜
```

### æ€§èƒ½æµ‹è¯•

```python
def test_balance():
    """æµ‹è¯•è´Ÿè½½å‡è¡¡æ€§"""
    ch = ConsistentHash(virtual_nodes=150)
    nodes = ["server0", "server1", "server2"]
    for node in nodes:
        ch.add_node(node)

    # æ¨¡æ‹Ÿ100ä¸‡ä¸ªå¯¹è±¡
    distribution = {node: 0 for node in nodes}
    for i in range(1000000):
        key = f"object_{i}"
        node = ch.get_node(key)
        distribution[node] += 1

    # æ‰“å°åˆ†å¸ƒ
    for node, count in distribution.items():
        print(f"{node}: {count} ({count/10000:.2f}%)")

    # æœŸæœ›ç»“æœ: æ¯ä¸ªèŠ‚ç‚¹çº¦33.33%

test_balance()
```

**å¯èƒ½è¾“å‡º**:
```
server0: 334521 (33.45%)
server1: 332890 (33.29%)
server2: 332589 (33.26%)
```

**éå¸¸å‡è¡¡ï¼** âœ…

---

## è®ºæ–‡çš„å½±å“ä¸è´¡çŒ®

### ç†è®ºè´¡çŒ®

1. **é¦–æ¬¡æå‡ºä¸€è‡´æ€§å“ˆå¸Œæ¦‚å¿µ**
2. **ä¸¥æ ¼çš„æ•°å­¦è¯æ˜**:
   - è´Ÿè½½å‡è¡¡æ€§
   - æœ€å°è¿ç§»é‡
   - å•è°ƒæ€§

3. **è™šæ‹ŸèŠ‚ç‚¹æŠ€æœ¯**:
   - è§£å†³èŠ‚ç‚¹åˆ†å¸ƒä¸å‡é—®é¢˜
   - åˆ†æäº†è™šæ‹ŸèŠ‚ç‚¹æ•°é‡çš„æƒè¡¡

### å®è·µå½±å“

**Akamai CDN**:
- è®ºæ–‡ä½œè€…åˆ›ç«‹äº†Akamaiå…¬å¸
- ä¸€è‡´æ€§å“ˆå¸Œæˆä¸ºCDNçš„æ ¸å¿ƒæŠ€æœ¯

**åˆ†å¸ƒå¼ç³»ç»Ÿ**:
- Amazon DynamoDB
- Apache Cassandra
- Riak
- Memcached clients

**è´Ÿè½½å‡è¡¡**:
- Nginx upstreamæ¨¡å—
- HAProxy consistent hash

### åç»­ç ”ç©¶

1. **Jump Consistent Hash** (Google, 2014)
   - æ›´ç®€å•çš„å®ç°
   - O(1)ç©ºé—´å¤æ‚åº¦

2. **Rendezvous Hashing** (HRW)
   - å¦ä¸€ç§ä¸€è‡´æ€§å“ˆå¸Œå˜ä½“
   - ä¸éœ€è¦ç¯ç»“æ„

3. **Bounded-Load Consistent Hashing**
   - é™åˆ¶å•ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è´Ÿè½½
   - è°·æ­Œåœ¨è´Ÿè½½å‡è¡¡ä¸­ä½¿ç”¨

---

## æ€»ç»“ä¸è¦ç‚¹

### æ ¸å¿ƒæ€æƒ³

1. **å“ˆå¸Œç¯**: å°†èŠ‚ç‚¹å’Œå¯¹è±¡æ˜ å°„åˆ°åŒä¸€ä¸ªç¯ä¸Š
2. **é¡ºæ—¶é’ˆæŸ¥æ‰¾**: å¯¹è±¡å­˜å‚¨åœ¨é¡ºæ—¶é’ˆæ–¹å‘çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
3. **è™šæ‹ŸèŠ‚ç‚¹**: æé«˜è´Ÿè½½å‡è¡¡æ€§
4. **æœ€å°è¿ç§»**: æ·»åŠ /åˆ é™¤èŠ‚ç‚¹åªå½±å“ç›¸é‚»èŠ‚ç‚¹

### å…³é”®ä¼˜åŠ¿

| ç‰¹æ€§ | ä¼˜åŠ¿ |
|------|------|
| **æœ€å°è¿ç§»** | åªéœ€è¿ç§» 1/N çš„æ•°æ® |
| **è´Ÿè½½å‡è¡¡** | è™šæ‹ŸèŠ‚ç‚¹ä¿è¯å‡è¡¡æ€§ |
| **å•è°ƒæ€§** | æ·»åŠ èŠ‚ç‚¹ä¸å½±å“å·²æœ‰æ˜ å°„ |
| **å¯æ‰©å±•** | æ˜“äºåŠ¨æ€æ‰©ç¼©å®¹ |

### é€‚ç”¨åœºæ™¯

âœ… åˆ†å¸ƒå¼ç¼“å­˜
âœ… CDNå†…å®¹åˆ†å‘
âœ… è´Ÿè½½å‡è¡¡ï¼ˆä¼šè¯ä¿æŒï¼‰
âœ… åˆ†å¸ƒå¼å­˜å‚¨
âœ… P2Pç½‘ç»œï¼ˆDHTï¼‰

### ä¸é€‚ç”¨åœºæ™¯

âŒ éœ€è¦ä¸¥æ ¼å‡è¡¡ï¼ˆä½¿ç”¨èŒƒå›´åˆ†åŒºï¼‰
âŒ èŠ‚ç‚¹æ€§èƒ½å·®å¼‚å¤§ï¼ˆéœ€è¦åŠ æƒæ–¹æ¡ˆï¼‰
âŒ éœ€è¦å¤šå‰¯æœ¬å¤åˆ¶ï¼ˆéœ€è¦é¢å¤–æœºåˆ¶ï¼‰

### å­¦ä¹ è¦ç‚¹

1. **ç†è§£ç¯ç»“æ„**: ä¸ºä»€ä¹ˆæ˜¯ç¯è€Œä¸æ˜¯ç›´çº¿ï¼Ÿ
2. **ç†è§£è™šæ‹ŸèŠ‚ç‚¹**: ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿå¦‚ä½•é€‰æ‹©æ•°é‡ï¼Ÿ
3. **ç†è§£æœ€å°è¿ç§»**: ä¸ºä»€ä¹ˆåªæœ‰1/Nçš„æ•°æ®ç§»åŠ¨ï¼Ÿ
4. **åŠ¨æ‰‹å®ç°**: åŠ æ·±ç†è§£

---

## æ‰©å±•é˜…è¯»

1. **åŸå§‹è®ºæ–‡**:
   - [Consistent Hashing and Random Trees (1997)](https://www.akamai.com/us/en/multimedia/documents/technical-publication/consistent-hashing-and-random-trees-distributed-caching-protocols-for-relieving-hot-spots-on-the-world-wide-web-technical-publication.pdf)

2. **åç»­è®ºæ–‡**:
   - [A Fast, Minimal Memory, Consistent Hash Algorithm (Jump Hash, 2014)](https://arxiv.org/abs/1406.2294)
   - [Rendezvous Hashing](https://www.eecs.umich.edu/techreports/cse/96/CSE-TR-316-96.pdf)

3. **å®è·µæ–‡ç« **:
   - [Consistent Hashing in Cassandra](https://cassandra.apache.org/doc/latest/architecture/dynamo.html)
   - [DynamoDB Partitioning](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.Partitions.html)

4. **å¼€æºå®ç°**:
   - [libketama](https://github.com/RJ/ketama) - Cå®ç°
   - [hash_ring](https://github.com/Doist/hash_ring) - Pythonå®ç°

---

**è¿™ç¯‡1997å¹´çš„è®ºæ–‡å¥ å®šäº†ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€ï¼Œè‡³ä»Šä»åœ¨å¹¿æ³›åº”ç”¨ï¼**

ğŸ’¡ **å»ºè®®**: å…ˆç†è§£åŸºæœ¬åŸç†ï¼Œå†æ·±å…¥æ•°å­¦è¯æ˜ï¼Œæœ€ååŠ¨æ‰‹å®ç°åŠ æ·±ç†è§£ã€‚
