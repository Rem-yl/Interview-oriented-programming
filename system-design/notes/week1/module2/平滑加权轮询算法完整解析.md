# å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•å®Œæ•´è§£æï¼ˆNGINX Smooth Weighted Round-Robinï¼‰

> **æ ¸å¿ƒç‰¹ç‚¹**ï¼šé€šè¿‡åŠ¨æ€è°ƒæ•´ curWeight å®ç°å¹³æ»‘çš„æƒé‡åˆ†å¸ƒï¼Œé¿å…é«˜æƒé‡æœåŠ¡å™¨è¿ç»­è¢«é€‰ä¸­

---

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#1-ç®—æ³•æ¦‚è¿°)
2. [ä¸‰å¤§æ•°å­¦å®šç†](#2-ä¸‰å¤§æ•°å­¦å®šç†)
3. [ä¸ºä»€ä¹ˆå……æ”¾ç”µèƒ½ä¿è¯æ¯”ä¾‹](#3-ä¸ºä»€ä¹ˆå……æ”¾ç”µèƒ½ä¿è¯æ¯”ä¾‹)
4. [ä¸ºä»€ä¹ˆå¿…é¡»æ¯”è¾ƒcurWeight](#4-ä¸ºä»€ä¹ˆå¿…é¡»æ¯”è¾ƒcurweight)
5. [å®Œæ•´ä»£ç å®ç°](#5-å®Œæ•´ä»£ç å®ç°)
6. [æ€»ç»“](#6-æ€»ç»“)

---

## 1. ç®—æ³•æ¦‚è¿°

### 1.1 åŸºæœ¬æ€æƒ³

æ¯ä¸ªæœåŠ¡å™¨ç»´æŠ¤ä¸€ä¸ª**åŠ¨æ€æƒé‡** `curWeight`ï¼Œé€šè¿‡å……ç”µå’Œæ”¾ç”µæœºåˆ¶å®ç°å¹³æ»‘åˆ†å¸ƒï¼š

```
æ¯æ¬¡è¯·æ±‚ï¼š
1. æ‰€æœ‰æœåŠ¡å™¨ curWeight += weight  (å……ç”µ)
2. é€‰æ‹© curWeight æœ€å¤§çš„æœåŠ¡å™¨   (ç«äº‰é€‰æ‹©)
3. è¢«é€‰ä¸­çš„ curWeight -= totalWeight (æ”¾ç”µ)
```

### 1.2 æ‰§è¡Œç¤ºä¾‹

**æƒé‡é…ç½®**ï¼šA:5, B:1, C:1, totalWeight=7

| è¯·æ±‚ | å……ç”µå | é€‰ä¸­ | æ”¾ç”µå | è¯´æ˜ |
|------|--------|------|--------|------|
| - | A:0 B:0 C:0 | - | - | åˆå§‹çŠ¶æ€ |
| #1 | A:5 B:1 C:1 | A | A:-2 B:1 C:1 | Aæœ€å¤§ |
| #2 | A:3 B:2 C:2 | A | A:-4 B:2 C:2 | Aæœ€å¤§ |
| #3 | A:1 B:3 C:3 | B | A:1 B:-4 C:3 | Bæœ€å¤§(å…ˆéå†åˆ°) |
| #4 | A:6 B:-3 C:4 | A | A:-1 B:-3 C:4 | Aæœ€å¤§ |
| #5 | A:4 B:-2 C:5 | C | A:4 B:-2 C:-2 | Cæœ€å¤§ |
| #6 | A:9 B:-1 C:-1 | A | A:2 B:-1 C:-1 | Aæœ€å¤§ |
| #7 | A:7 B:0 C:0 | A | A:0 B:0 C:0 | âœ“ å›åˆ°åˆå§‹ |

**é€‰æ‹©åºåˆ—**ï¼šA A B A C A A â†’ å¹³æ»‘åˆ†å¸ƒï¼

**ç»Ÿè®¡**ï¼šAé€‰ä¸­5æ¬¡ï¼ŒBé€‰ä¸­1æ¬¡ï¼ŒCé€‰ä¸­1æ¬¡ â†’ 5:1:1 âœ“

---

## 2. ä¸‰å¤§æ•°å­¦å®šç†

### 2.1 å®šç†1ï¼šæƒé‡å®ˆæ’å®šå¾‹

**å‘½é¢˜**ï¼šåœ¨ä»»ä½•æ—¶åˆ»ï¼Œæ‰€æœ‰æœåŠ¡å™¨çš„ curWeight ä¹‹å’Œæ’ä¸º 0

**æ•°å­¦è¡¨è¾¾**ï¼š
```
âˆ‘cáµ¢(t) = 0  (å¯¹æ‰€æœ‰ t æ’æˆç«‹)
```

**è¯æ˜**ï¼š
```
åˆå§‹ï¼šâˆ‘cáµ¢(0) = 0

æ¯æ¬¡è¯·æ±‚ï¼š
  å……ç”µï¼šâˆ‘cáµ¢' = âˆ‘(cáµ¢ + wáµ¢) = âˆ‘cáµ¢ + W
  æ”¾ç”µï¼šâˆ‘cáµ¢'' = (âˆ‘cáµ¢ + W) - W = âˆ‘cáµ¢

â†’ æ¯æ¬¡è¯·æ±‚å‰åï¼Œæ€»å’Œä¸å˜
â†’ å§‹ç»ˆ âˆ‘cáµ¢ = 0
```

**æ„ä¹‰**ï¼šè¿™æ˜¯çº¿æ€§ä»£æ•°çš„å¿…ç„¶ç»“æœï¼Œä¿è¯äº†ç³»ç»Ÿçš„æ€»ä½“å¹³è¡¡ã€‚

---

### 2.2 å®šç†2ï¼šå‘¨æœŸå¹³è¡¡å®šç†

**å‘½é¢˜**ï¼šç»è¿‡æ°å¥½ W æ¬¡è¯·æ±‚åï¼Œç³»ç»Ÿå›åˆ°åˆå§‹çŠ¶æ€ï¼Œä¸”æ¯ä¸ªæœåŠ¡å™¨è¢«é€‰ä¸­æ¬¡æ•°ç­‰äºå…¶æƒé‡

**æ•°å­¦è¡¨è¾¾**ï¼š
```
náµ¢(W) = wáµ¢
cáµ¢(W) = 0
```

**å…³é”®æ–¹ç¨‹**ï¼š
```
cáµ¢(t) = tÃ—wáµ¢ - náµ¢(t)Ã—W
```

**è¯æ˜**ï¼š

**æ­¥éª¤1**ï¼šéªŒè¯æ€»é€‰ä¸­æ¬¡æ•°
```
ç”±å®ˆæ’å®šå¾‹ï¼šâˆ‘cáµ¢(W) = 0

ä»£å…¥çŠ¶æ€æ–¹ç¨‹ï¼š
âˆ‘[WÃ—wáµ¢ - náµ¢(W)Ã—W] = 0
WÃ—âˆ‘wáµ¢ - WÃ—âˆ‘náµ¢(W) = 0
WÃ—W - WÃ—âˆ‘náµ¢(W) = 0  (å› ä¸º âˆ‘wáµ¢ = W)
â†’ âˆ‘náµ¢(W) = W  âœ“
```

**æ­¥éª¤2**ï¼šè¯æ˜æ¯ä¸ª cáµ¢(W) = 0

å…³é”®æ´å¯Ÿï¼šè¿™ä¸æ˜¯è‡ªç„¶å‘ç”Ÿçš„ï¼Œè€Œæ˜¯**ç®—æ³•çš„è®¾è®¡ç›®æ ‡**ï¼

```
è¦æ±‚å›åˆ°åˆå§‹çŠ¶æ€ï¼šcáµ¢(W) = 0

ç”±çŠ¶æ€æ–¹ç¨‹ï¼š
cáµ¢(W) = WÃ—wáµ¢ - náµ¢(W)Ã—W = 0
WÃ—(wáµ¢ - náµ¢(W)) = 0
â†’ náµ¢(W) = wáµ¢  âœ“
```

**åå‘éªŒè¯**ï¼šå¦‚æœ náµ¢(W) = wáµ¢ï¼Œæ˜¯å¦ä¿è¯ cáµ¢(W) = 0ï¼Ÿ

```
cáµ¢(W) = WÃ—wáµ¢ - wáµ¢Ã—W = 0  âœ“
```

**ç­‰ä»·å…³ç³»**ï¼š
```
cáµ¢(W) = 0  âŸº  náµ¢(W) = wáµ¢
```

---

### 2.3 å®šç†3ï¼šå‡æ•°å”¯ä¸€æ€§

**å‘½é¢˜**ï¼šåªæœ‰å‡å» totalWeight æ‰èƒ½ä¿è¯å‘¨æœŸå¹³è¡¡ï¼Œå…¶ä»–ä»»ä½•å€¼éƒ½ä¼šç ´åæ¯”ä¾‹

**è¯æ˜**ï¼š

è®¾å‡æ•°ä¸º Dï¼Œä¸€ä¸ªå‘¨æœŸå†…ï¼š
```
æ€»å……ç”µ = W Ã— wáµ¢
æ€»æ”¾ç”µ = náµ¢(W) Ã— D

è¦è¾¾åˆ°å¹³è¡¡ï¼ˆå›åˆ°åˆå§‹çŠ¶æ€ï¼‰ï¼š
W Ã— wáµ¢ = náµ¢(W) Ã— D

æˆ‘ä»¬å¸Œæœ›ï¼šnáµ¢(W) = wáµ¢ ï¼ˆæŒ‰æƒé‡æ¯”ä¾‹ï¼‰

ä»£å…¥ï¼š
W Ã— wáµ¢ = wáµ¢ Ã— D
â†’ D = W = totalWeight
```

**å”¯ä¸€æ€§**ï¼šD æ˜¯æ–¹ç¨‹ç»„çš„å”¯ä¸€è§£ï¼

**åä¾‹**ï¼šå¦‚æœ D = 10ï¼ˆæƒé‡ 5:1:1, W=7ï¼‰
```
câ‚(7) = 7Ã—5 - 5Ã—10 = -15 â‰  0 âŒ
cáµ¦(7) = 7Ã—1 - 1Ã—10 = -3 â‰  0 âŒ
ç³»ç»Ÿæ— æ³•å›åˆ°åˆå§‹çŠ¶æ€ï¼
```

---

## 3. ä¸ºä»€ä¹ˆå……æ”¾ç”µèƒ½ä¿è¯æ¯”ä¾‹ï¼Ÿ

### 3.1 æ ¸å¿ƒç–‘é—®

**é—®é¢˜**ï¼šæˆ‘åªæ˜¯æŒ‰è§„åˆ™å……æ”¾ç”µï¼Œä¸ºä»€ä¹ˆæœ€ç»ˆæ¯ä¸ªæœåŠ¡å™¨çš„é€‰ä¸­æ¬¡æ•°ä¼šä¸¥æ ¼æŒ‰ç…§æƒé‡æ¯”ä¾‹åˆ†é…ï¼Ÿ

**ç­”æ¡ˆ**ï¼šæ¯”ä¾‹ä¸æ˜¯"è®¾è®¡"å‡ºæ¥çš„ï¼Œè€Œæ˜¯ä¸‰ä¸ªæ•°å­¦æœºåˆ¶è‡ªåŠ¨"æ¶Œç°"çš„ç»“æœï¼

---

### 3.2 ä¸‰å±‚æœºåˆ¶

#### ç¬¬1å±‚ï¼šå¾®è§‚å±‚é¢ - å……ç”µé€Ÿåº¦å†³å®šé¢‘ç‡

**æ ¸å¿ƒæœºåˆ¶**ï¼šæƒé‡å¤§çš„æœåŠ¡å™¨å……ç”µå¿«ï¼Œæ›´å®¹æ˜“æˆä¸ºæœ€å¤§å€¼

```
æƒé‡ wâ‚=5, wáµ¦=1

è¿ç»­5æ¬¡æœªè¢«é€‰ï¼š
câ‚ = 0 + 5Ã—5 = 25
cáµ¦ = 0 + 5Ã—1 = 5

A å¢é•¿å¿« â†’ A æ›´å¯èƒ½è¢«é€‰ â†’ é¢‘ç‡ âˆ æƒé‡
```

**æ•°å­¦è¡¨è¾¾**ï¼š
```
P(é€‰ä¸­ i) âˆ wáµ¢  (é•¿æœŸé¢‘ç‡æ­£æ¯”äºæƒé‡)
```

---

#### ç¬¬2å±‚ï¼šå®è§‚å±‚é¢ - å¹³è¡¡æ–¹ç¨‹çš„å”¯ä¸€è§£

**å¹³è¡¡æ¡ä»¶**ï¼š
```
å……ç”µæ€»é‡ = æ”¾ç”µæ€»é‡
W Ã— wáµ¢ = náµ¢(W) Ã— W

å”¯ä¸€è§£ï¼šnáµ¢(W) = wáµ¢
```

è¿™ä¸æ˜¯è®¾è®¡çš„ï¼Œæ˜¯**æ•°å­¦å¿…ç„¶**ï¼

---

#### ç¬¬3å±‚ï¼šåŠ¨æ€å±‚é¢ - è´Ÿåé¦ˆè‡ªåŠ¨è°ƒèŠ‚

**åå·®æ£€æµ‹**ï¼š
```
cáµ¢(t) = tÃ—wáµ¢ - náµ¢(t)Ã—W
```

**è‡ªåŠ¨ä¿®æ­£**ï¼š
```
é€‰å¤šäº†ï¼ˆnáµ¢ > wáµ¢ï¼‰:
â†’ cáµ¢ < 0 (è´Ÿæ•°)
â†’ ä¸æ˜“è¢«é€‰ (è´Ÿåé¦ˆ)
â†’ é¢‘ç‡è‡ªåŠ¨é™ä½ â†“

é€‰å°‘äº†ï¼ˆnáµ¢ < wáµ¢ï¼‰:
â†’ cáµ¢ > 0 (æ­£æ•°)
â†’ å®¹æ˜“è¢«é€‰ (æ­£åé¦ˆ)
â†’ é¢‘ç‡è‡ªåŠ¨å¢åŠ  â†‘
```

**æ”¶æ•›æ€§**ï¼šç³»ç»Ÿè‡ªåŠ¨æ”¶æ•›åˆ° náµ¢ = wáµ¢

---

### 3.3 æ¶Œç°æœºåˆ¶æ€»ç»“

| å±‚æ¬¡ | æœºåˆ¶ | ä½œç”¨ | æ•°å­¦åŸºç¡€ |
|------|------|------|---------|
| **å¾®è§‚** | å……ç”µé€Ÿåº¦å·®å¼‚ | äº§ç”Ÿé¢‘ç‡åå‘ | wáµ¢ å†³å®šå¢é•¿ç‡ |
| **å®è§‚** | å¹³è¡¡æ–¹ç¨‹ | ç¡®å®šå”¯ä¸€å¹³è¡¡ç‚¹ | çº¿æ€§æ–¹ç¨‹ç»„ |
| **åŠ¨æ€** | è´Ÿåé¦ˆ | è‡ªåŠ¨æ”¶æ•›åˆ°å¹³è¡¡ç‚¹ | åŠ¨æ€ç³»ç»Ÿç¨³å®šæ€§ |

**æ ¸å¿ƒæ´å¯Ÿ**ï¼š
```
ä½ ä¸éœ€è¦"è®¡ç®—"æ¯”ä¾‹ï¼Œåªéœ€è¦"æ‰§è¡Œ"è§„åˆ™
æ¯”ä¾‹ä¼šé€šè¿‡æ•°å­¦æœºåˆ¶è‡ªåŠ¨æ¶Œç°ï¼

å±€éƒ¨è§„åˆ™ â†’ å…¨å±€æ¨¡å¼ï¼ˆæ¶Œç°ï¼‰
```

---

## 4. ä¸ºä»€ä¹ˆå¿…é¡»æ¯”è¾ƒcurWeightï¼Ÿ

### 4.1 æ ¸å¿ƒç–‘é—®

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆè¦æ¯”è¾ƒæ‰€æœ‰æœåŠ¡å™¨çš„ curWeight å¤§å°ï¼Œè€Œä¸æ˜¯ä¸å›ºå®šé˜ˆå€¼æ¯”è¾ƒï¼Ÿ

---

### 4.2 ä¸¤ç§æ–¹æ³•å¯¹æ¯”

#### æ–¹æ³•Aï¼šæ¯”è¾ƒ curWeightï¼ˆæ­£ç¡® âœ…ï¼‰

```go
selectServer := servers[0]
for _, server := range servers {
    if server.curWeight > selectServer.curWeight {
        selectServer = server
    }
}
```

**ç‰¹ç‚¹**ï¼šç«äº‰é€‰æ‹©ï¼Œæ€»èƒ½é€‰å‡ºå”¯ä¸€æœ€å¤§å€¼

---

#### æ–¹æ³•Bï¼šä¸é˜ˆå€¼æ¯”è¾ƒï¼ˆé”™è¯¯ âŒï¼‰

```go
threshold := T  // å›ºå®šå€¼
for _, server := range servers {
    if server.curWeight >= threshold {
        selectServer = server
        break
    }
}
```

**é—®é¢˜**ï¼šæ¡ä»¶ç­›é€‰ï¼Œå¯èƒ½0ä¸ªæˆ–å¤šä¸ªæ»¡è¶³

---

### 4.3 ä¸‰ä¸ªå¿…é¡»æ»¡è¶³çš„æ•°å­¦çº¦æŸ

```
çº¦æŸ1: âˆ‘Î´áµ¢(t) = 1    (æ¯æ¬¡æ°å¥½é€‰1ä¸ª)
çº¦æŸ2: cáµ¢(W) = 0      (å‘¨æœŸåå›åˆ°åˆå§‹çŠ¶æ€)
çº¦æŸ3: náµ¢(W) = wáµ¢     (é€‰ä¸­æ¬¡æ•° = æƒé‡)
```

**å¯¹æ¯”åˆ†æ**ï¼š

| æ–¹æ³• | çº¦æŸ1 | çº¦æŸ2 | çº¦æŸ3 | ç»“è®º |
|------|-------|-------|-------|------|
| æ¯”è¾ƒ curWeight | âœ… argmaxå”¯ä¸€ | âœ… è‡ªåŠ¨æ»¡è¶³ | âœ… è‡ªåŠ¨æ”¶æ•› | å®Œç¾è§£ |
| ä¸é˜ˆå€¼æ¯”è¾ƒ | âŒ 0ä¸ªæˆ–å¤šä¸ª | âš ï¸ ç‰¹æ®Šå€¼å¯èƒ½ | âŒ æ— æ³•ä¿è¯ | éé€šç”¨è§£ |

---

### 4.4 é˜ˆå€¼æ–¹æ³•çš„å…·ä½“é—®é¢˜

#### é—®é¢˜1ï¼šå¯èƒ½æ²¡æœ‰æœåŠ¡å™¨æ»¡è¶³æ¡ä»¶

```
æƒé‡ 5:1:1, W=7, é˜ˆå€¼ T=10

æŸæ—¶åˆ»ï¼š
câ‚ + wâ‚ = 3 + 5 = 8  < 10 âœ—
cáµ¦ + wáµ¦ = -1 + 1 = 0 < 10 âœ—
cá´„ + wá´„ = -2 + 1 = -1 < 10 âœ—

â†’ ç®—æ³•æ­»é”ï¼
```

---

#### é—®é¢˜2ï¼šå¤šä¸ªæœåŠ¡å™¨åŒæ—¶æ»¡è¶³

```
æƒé‡ 5:1:1, W=7, é˜ˆå€¼ T=3

æŸæ—¶åˆ»ï¼š
câ‚ + wâ‚ = 3 + 5 = 8  >= 3 âœ“
cáµ¦ + wáµ¦ = 2 + 1 = 3  >= 3 âœ“
cá´„ + wá´„ = 2 + 1 = 3  >= 3 âœ“

â†’ ä¸‰ä¸ªéƒ½æ»¡è¶³ï¼Œé€‰å“ªä¸ªï¼Ÿéœ€è¦é¢å¤–é€»è¾‘
```

---

#### é—®é¢˜3ï¼šæ— æ³•ä¿è¯æ¯”ä¾‹å¹³è¡¡

**åä¾‹**ï¼šT = 5ï¼ˆæƒé‡ 5:1:1ï¼‰

```
æœåŠ¡å™¨ A: câ‚ + wâ‚ >= 5 â†’ câ‚ >= 0 (æ¡ä»¶å®½æ¾)
æœåŠ¡å™¨ B: cáµ¦ + wáµ¦ >= 5 â†’ cáµ¦ >= 4 (æ¡ä»¶ä¸¥æ ¼ï¼)

cáµ¦ å¾ˆéš¾è¾¾åˆ° 4:
cáµ¦(t) = tÃ—1 - náµ¦(t)Ã—7

å¦‚æœ t=7: cáµ¦ = 7 - 7Ã—náµ¦ >= 4
         â†’ náµ¦ <= 3/7 < 1

B å¯èƒ½ä¸€æ¬¡éƒ½é€‰ä¸ä¸Šï¼è¿åäº† náµ¦=1 çš„è¦æ±‚ âŒ
```

---

### 4.5 æ•°å­¦æœ¬è´¨å¯¹æ¯”

| ç»´åº¦ | ç«äº‰é€‰æ‹© | æ¡ä»¶ç­›é€‰ |
|------|---------|---------|
| **æ•°å­¦æ€§è´¨** | ä¼˜åŒ–é—®é¢˜ (argmax) | çº¦æŸæ»¡è¶³é—®é¢˜ (CSP) |
| **é€‰æ‹©æ•°é‡** | æ°å¥½1ä¸ª | 0ä¸ªæˆ–å¤šä¸ª |
| **ç¡®å®šæ€§** | å®Œå…¨ç¡®å®š | å¯èƒ½ä¸ç¡®å®š |
| **å‚æ•°ä¾èµ–** | æ— éœ€å‚æ•° | éœ€è¦é˜ˆå€¼T |
| **å¹³è¡¡ä¿è¯** | æ•°å­¦å¿…ç„¶ | æ— æ³•ä¿è¯ |

**æœ¬è´¨åŒºåˆ«**ï¼š
```
ç«äº‰ç³»ç»Ÿï¼šé€‰æœ€ä¼˜ â†’ æ¯æ¬¡é€‰1ä¸ª â†’ è‡ªåŠ¨å¹³è¡¡
ç­›é€‰ç³»ç»Ÿï¼šè¿‡é—¨æ§› â†’ å¯èƒ½å¤šè§£ â†’ æ— æ³•å¹³è¡¡
```

---

## 5. å®Œæ•´ä»£ç å®ç°

```go
package main

import (
	"errors"
	"fmt"
	"sync"
)

// SwrrServer å¹³æ»‘åŠ æƒè½®è¯¢æœåŠ¡å™¨
type SwrrServer struct {
	URL       string
	Name      string
	weight    int // å›ºå®šæƒé‡ï¼ˆé…ç½®ï¼‰
	curWeight int // å½“å‰åŠ¨æ€æƒé‡
}

// SwrrBalancer å¹³æ»‘åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡å™¨
type SwrrBalancer struct {
	servers     []*SwrrServer
	totalWeight int
	mu          sync.Mutex
}

// NewSwrrBalancer åˆ›å»ºå¹³æ»‘åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡å™¨
func NewSwrrBalancer(configs []struct{ Name, URL string; Weight int }) *SwrrBalancer {
	servers := make([]*SwrrServer, 0, len(configs))
	totalWeight := 0

	for _, cfg := range configs {
		servers = append(servers, &SwrrServer{
			URL:       cfg.URL,
			Name:      cfg.Name,
			weight:    cfg.Weight,
			curWeight: 0, // åˆå§‹ä¸º0
		})
		totalWeight += cfg.Weight
	}

	return &SwrrBalancer{
		servers:     servers,
		totalWeight: totalWeight,
	}
}

// GetServer è·å–ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
func (b *SwrrBalancer) GetServer() (*SwrrServer, error) {
	if len(b.servers) == 0 {
		return nil, errors.New("no server available")
	}

	b.mu.Lock()
	defer b.mu.Unlock()

	// æ­¥éª¤1: æ‰€æœ‰æœåŠ¡å™¨ curWeight += weight (å……ç”µ)
	for _, server := range b.servers {
		server.curWeight += server.weight
	}

	// æ­¥éª¤2: é€‰æ‹© curWeight æœ€å¤§çš„æœåŠ¡å™¨ (ç«äº‰é€‰æ‹©)
	maxServer := b.servers[0]
	for _, server := range b.servers[1:] {
		if server.curWeight > maxServer.curWeight {
			maxServer = server
		}
	}

	// æ­¥éª¤3: è¢«é€‰ä¸­çš„ curWeight -= totalWeight (æ”¾ç”µ)
	maxServer.curWeight -= b.totalWeight

	return maxServer, nil
}

// GetStats è·å–å½“å‰çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰
func (b *SwrrBalancer) GetStats() string {
	b.mu.Lock()
	defer b.mu.Unlock()

	result := "Current State: "
	for _, server := range b.servers {
		result += fmt.Sprintf("%s:%d ", server.Name, server.curWeight)
	}
	return result
}

// ç¤ºä¾‹ä½¿ç”¨
func main() {
	// åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ï¼ˆæƒé‡ 5:1:1ï¼‰
	balancer := NewSwrrBalancer([]struct{ Name, URL string; Weight int }{
		{"Server-A", "http://192.168.1.1:8080", 5},
		{"Server-B", "http://192.168.1.2:8080", 1},
		{"Server-C", "http://192.168.1.3:8080", 1},
	})

	fmt.Println("å¹³æ»‘åŠ æƒè½®è¯¢æ¼”ç¤ºï¼ˆæƒé‡ 5:1:1ï¼‰\n")

	// æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´å‘¨æœŸï¼ˆ7æ¬¡è¯·æ±‚ï¼‰
	stats := make(map[string]int)
	sequence := ""

	for i := 1; i <= 7; i++ {
		server, _ := balancer.GetServer()
		stats[server.Name]++
		sequence += server.Name[7:8] + " " // æå– A/B/C

		fmt.Printf("è¯·æ±‚ #%d â†’ %s | %s\n",
			i, server.Name, balancer.GetStats())
	}

	fmt.Printf("\né€‰æ‹©åºåˆ—: %s\n", sequence)
	fmt.Println("\nç»Ÿè®¡ç»“æœ:")
	for name, count := range stats {
		fmt.Printf("  %s: %d æ¬¡\n", name, count)
	}

	fmt.Println("\nâœ“ å¹³æ»‘åˆ†å¸ƒï¼Œæ¯”ä¾‹æ­£ç¡®ï¼")
}

/*
è¾“å‡º:
å¹³æ»‘åŠ æƒè½®è¯¢æ¼”ç¤ºï¼ˆæƒé‡ 5:1:1ï¼‰

è¯·æ±‚ #1 â†’ Server-A | Current State: Server-A:-2 Server-B:1 Server-C:1
è¯·æ±‚ #2 â†’ Server-A | Current State: Server-A:-4 Server-B:2 Server-C:2
è¯·æ±‚ #3 â†’ Server-B | Current State: Server-A:1 Server-B:-4 Server-C:3
è¯·æ±‚ #4 â†’ Server-A | Current State: Server-A:-1 Server-B:-3 Server-C:4
è¯·æ±‚ #5 â†’ Server-C | Current State: Server-A:4 Server-B:-2 Server-C:-2
è¯·æ±‚ #6 â†’ Server-A | Current State: Server-A:2 Server-B:-1 Server-C:-1
è¯·æ±‚ #7 â†’ Server-A | Current State: Server-A:0 Server-B:0 Server-C:0

é€‰æ‹©åºåˆ—: A A B A C A A

ç»Ÿè®¡ç»“æœ:
  Server-A: 5 æ¬¡
  Server-B: 1 æ¬¡
  Server-C: 1 æ¬¡

âœ“ å¹³æ»‘åˆ†å¸ƒï¼Œæ¯”ä¾‹æ­£ç¡®ï¼
*/
```

---

## 6. æ€»ç»“

### 6.1 æ ¸å¿ƒæœºåˆ¶

```
ä¸‰æ­¥æ“ä½œï¼š
1. curWeight += weight        (å……ç”µ - å·®å¼‚åŒ–ç´¯ç§¯)
2. é€‰ max(curWeight)          (é€‰æ‹© - ç«äº‰æœºåˆ¶)
3. curWeight -= totalWeight   (æ”¾ç”µ - å¹³è¡¡çº¦æŸ)
```

### 6.2 ä¸‰å¤§æ•°å­¦ä¿è¯

| å®šç† | æ•°å­¦è¡¨è¾¾ | ä½œç”¨ |
|------|---------|------|
| **æƒé‡å®ˆæ’** | âˆ‘cáµ¢ = 0 (æ’æˆç«‹) | ç³»ç»Ÿæ€»ä½“å¹³è¡¡ |
| **å‘¨æœŸå¹³è¡¡** | náµ¢(W) = wáµ¢ | ç²¾ç¡®æ¯”ä¾‹åˆ†é… |
| **å‡æ•°å”¯ä¸€** | D = totalWeight (å”¯ä¸€è§£) | ä¿è¯å¹³è¡¡ |

### 6.3 ä¸‰ä¸ª"ä¸ºä»€ä¹ˆ"

1. **ä¸ºä»€ä¹ˆå……ç”µèƒ½ä¿è¯æ¯”ä¾‹ï¼Ÿ**
   - å¾®è§‚ï¼šå……ç”µé€Ÿåº¦ â†’ é€‰æ‹©é¢‘ç‡
   - å®è§‚ï¼šå¹³è¡¡æ–¹ç¨‹ â†’ å”¯ä¸€è§£
   - åŠ¨æ€ï¼šè´Ÿåé¦ˆ â†’ è‡ªç¨³å®š

2. **ä¸ºä»€ä¹ˆå‡ totalWeightï¼Ÿ**
   - å”¯ä¸€èƒ½æ»¡è¶³ náµ¢(W) = wáµ¢ çš„å€¼
   - å¹³è¡¡æ–¹ç¨‹çš„æ•°å­¦å¿…ç„¶

3. **ä¸ºä»€ä¹ˆæ¯”è¾ƒ curWeightï¼Ÿ**
   - ç«äº‰é€‰æ‹©ä¿è¯å”¯ä¸€æ€§
   - é˜ˆå€¼ç­›é€‰æ— æ³•ä¿è¯å¹³è¡¡

### 6.4 ç®—æ³•ä¼˜åŠ¿

âœ… **å¹³æ»‘æ€§ä¼˜ç§€** - Bå’ŒCç©¿æ’åœ¨Aä¹‹é—´ï¼Œé¿å…è¿ç»­é€‰æ‹©
âœ… **æ•°å­¦ä¸¥å¯†** - ä¸‰å¤§å®šç†ä¿è¯ï¼Œä¸¥æ ¼è¯æ˜
âœ… **å®ç°ç®€æ´** - O(n)å¤æ‚åº¦ï¼Œæ— éœ€é¢å¤–å‚æ•°
âœ… **å·¥ç¨‹ä¼˜é›…** - NGINXå®˜æ–¹å®ç°ï¼Œä¹…ç»è€ƒéªŒ

### 6.5 é€‚ç”¨åœºæ™¯

- âœ… æœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¤§
- âœ… è¦æ±‚æµé‡å¹³æ»‘åˆ†å¸ƒ
- âœ… å¯¹ç”¨æˆ·ä½“éªŒè¦æ±‚é«˜
- âœ… é€šç”¨åœºæ™¯æ¨èä½¿ç”¨

---

**æ•°å­¦ä¹‹ç¾**ï¼šç®€å•çš„å……æ”¾ç”µè§„åˆ™ï¼Œé€šè¿‡æ¶Œç°æœºåˆ¶ï¼Œè‡ªåŠ¨äº§ç”Ÿç²¾ç¡®çš„æƒé‡æ¯”ä¾‹ï¼

**è¿™å°±æ˜¯ NGINX å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•çš„å®Œæ•´è§£æã€‚** ğŸ¯
