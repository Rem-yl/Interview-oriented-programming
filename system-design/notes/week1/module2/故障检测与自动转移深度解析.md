# æ•…éšœæ£€æµ‹ä¸è‡ªåŠ¨è½¬ç§»æ·±åº¦è§£æ

> ä»é›ªå´©æ•ˆåº”å‡ºå‘ï¼Œç†è§£ç†”æ–­å™¨ã€æ•…éšœæ£€æµ‹ä¸è‡ªåŠ¨è½¬ç§»çš„è®¾è®¡åŸç†

---

## ç›®å½•

- [1. ä¸ºä»€ä¹ˆéœ€è¦æ•…éšœæ£€æµ‹ä¸è‡ªåŠ¨è½¬ç§»ï¼Ÿ](#1-ä¸ºä»€ä¹ˆéœ€è¦æ•…éšœæ£€æµ‹ä¸è‡ªåŠ¨è½¬ç§»)
- [2. ç†”æ–­å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰](#2-ç†”æ–­å™¨æ¨¡å¼circuit-breaker)
- [3. æ•…éšœæ£€æµ‹ç®—æ³•](#3-æ•…éšœæ£€æµ‹ç®—æ³•)
- [4. è‡ªåŠ¨è½¬ç§»æœºåˆ¶ï¼ˆFailoverï¼‰](#4-è‡ªåŠ¨è½¬ç§»æœºåˆ¶failover)
- [5. å®è·µï¼šGo å®ç°å®Œæ•´çš„æ•…éšœæ£€æµ‹ä¸è½¬ç§»ç³»ç»Ÿ](#5-å®è·µgo-å®ç°å®Œæ•´çš„æ•…éšœæ£€æµ‹ä¸è½¬ç§»ç³»ç»Ÿ)
- [6. ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹åˆ†æ](#6-ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹åˆ†æ)
- [7. æœ€ä½³å®è·µä¸é™·é˜±](#7-æœ€ä½³å®è·µä¸é™·é˜±)

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦æ•…éšœæ£€æµ‹ä¸è‡ªåŠ¨è½¬ç§»ï¼Ÿ

### 1.1 é›ªå´©æ•ˆåº”ï¼ˆCascading Failureï¼‰

#### åœºæ™¯ï¼šå¾®æœåŠ¡è°ƒç”¨é“¾

å‡è®¾ä½ æœ‰ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œè°ƒç”¨é“¾å¦‚ä¸‹ï¼š

```
å®¢æˆ·ç«¯ â†’ API ç½‘å…³ â†’ è®¢å•æœåŠ¡ â†’ [åº“å­˜æœåŠ¡, æ”¯ä»˜æœåŠ¡, ç‰©æµæœåŠ¡]
                                      â†“
                                  æ•°æ®åº“ï¼ˆæ…¢æŸ¥è¯¢ï¼‰
```

**é—®é¢˜å‘ç”Ÿ**ï¼š

```
æ—¶åˆ» T=0: åº“å­˜æœåŠ¡çš„æ•°æ®åº“å‡ºç°æ…¢æŸ¥è¯¢ï¼ˆ10ç§’å“åº”ï¼‰

T=1s: è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡
      â†’ ç­‰å¾… 10 ç§’ â³
      â†’ è®¢å•æœåŠ¡çš„çº¿ç¨‹è¢«é˜»å¡

T=2s: åˆæœ‰ 10 ä¸ªè¯·æ±‚è¿›æ¥
      â†’ æ¯ä¸ªéƒ½é˜»å¡ 10 ç§’
      â†’ è®¢å•æœåŠ¡çº¿ç¨‹æ± è€—å°½ï¼ˆå‡è®¾æœ€å¤§ 100 çº¿ç¨‹ï¼‰

T=10s: è®¢å•æœåŠ¡ 100 ä¸ªçº¿ç¨‹å…¨éƒ¨é˜»å¡
       â†’ æ— æ³•å¤„ç†æ–°è¯·æ±‚
       â†’ è®¢å•æœåŠ¡å´©æºƒ ğŸ’¥

T=11s: API ç½‘å…³è°ƒç”¨è®¢å•æœåŠ¡å¤±è´¥
       â†’ API ç½‘å…³çš„çº¿ç¨‹ä¹Ÿå¼€å§‹é˜»å¡
       â†’ API ç½‘å…³å´©æºƒ ğŸ’¥

T=12s: æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ âŒ
```

**é›ªå´©æ•ˆåº”ç¤ºæ„å›¾**ï¼š

```
åº“å­˜æœåŠ¡ï¼ˆæ…¢ï¼‰ â†’ è®¢å•æœåŠ¡å´©æºƒ â†’ API ç½‘å…³å´©æºƒ â†’ æ•´ä¸ªç³»ç»Ÿå´©æºƒ
   ğŸŒ              ğŸ’¥              ğŸ’¥              âŒ
```

#### æ ¸å¿ƒé—®é¢˜

1. **çº§è”æ•…éšœ**ï¼šä¸€ä¸ªæœåŠ¡çš„æ•…éšœå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ
2. **èµ„æºè€—å°½**ï¼šçº¿ç¨‹ã€è¿æ¥ã€å†…å­˜è¢«æ•…éšœæœåŠ¡å ç”¨
3. **æ¢å¤å›°éš¾**ï¼šå³ä½¿æ•…éšœæœåŠ¡æ¢å¤ï¼Œç³»ç»Ÿä»å¯èƒ½å¤„äºä¸ç¨³å®šçŠ¶æ€
4. **ç”¨æˆ·ä½“éªŒç³Ÿç³•**ï¼šé•¿æ—¶é—´ç­‰å¾…ã€è¶…æ—¶ã€é”™è¯¯

### 1.2 ä¼ ç»Ÿå¥åº·æ£€æŸ¥çš„ä¸è¶³

ä¼ ç»Ÿå¥åº·æ£€æŸ¥ï¼ˆå¦‚æˆ‘ä»¬ä¹‹å‰å­¦çš„ï¼‰æœ‰å±€é™æ€§ï¼š

| é—®é¢˜åœºæ™¯ | å¥åº·æ£€æŸ¥çš„è¡¨ç° | å®é™…å½±å“ |
|---------|---------------|---------|
| **æœåŠ¡å“åº”æ…¢** | å¥åº·æ£€æŸ¥å¯èƒ½é€šè¿‡ï¼ˆ/health å¾ˆå¿«ï¼‰ | å®é™…è¯·æ±‚è¶…æ—¶ |
| **é—´æ­‡æ€§æ•…éšœ** | å¯èƒ½åˆšå¥½æ£€æŸ¥æ—¶æ­£å¸¸ | ç”¨æˆ·è¯·æ±‚æ—¶æ•…éšœ |
| **èµ„æºè€—å°½** | æœåŠ¡æœªå´©æºƒï¼Œå¥åº·æ£€æŸ¥é€šè¿‡ | è¯·æ±‚é˜»å¡ |
| **ä¾èµ–æœåŠ¡æ•…éšœ** | æœ¬æœåŠ¡å¥åº·ï¼Œä½†æ— æ³•å·¥ä½œ | è°ƒç”¨å¤±è´¥ |

**ç¤ºä¾‹**ï¼š

```
è®¢å•æœåŠ¡çš„ /health ç«¯ç‚¹ï¼š
âœ… HTTP 200 OK

ä½†æ˜¯ï¼š
- æ•°æ®åº“è¿æ¥æ± å·²æ»¡
- æ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ•°æ®åº“
- æ–°è¯·æ±‚æ— æ³•å¤„ç†

å¥åº·æ£€æŸ¥ï¼šé€šè¿‡ âœ…
å®é™…çŠ¶æ€ï¼šä¸å¯ç”¨ âŒ
```

### 1.3 éœ€è¦çš„è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬éœ€è¦æ›´æ™ºèƒ½çš„æœºåˆ¶ï¼š

1. **å¿«é€Ÿå¤±è´¥ï¼ˆFail Fastï¼‰**
   - æ£€æµ‹åˆ°æ•…éšœç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…è¶…æ—¶
   - é¿å…èµ„æºè€—å°½

2. **è‡ªåŠ¨ç†”æ–­ï¼ˆCircuit Breakingï¼‰**
   - è‡ªåŠ¨éš”ç¦»æ•…éšœæœåŠ¡
   - ç»™æ•…éšœæœåŠ¡æ¢å¤æ—¶é—´

3. **é™çº§ç­–ç•¥ï¼ˆGraceful Degradationï¼‰**
   - æä¾›å¤‡ç”¨æ–¹æ¡ˆ
   - éƒ¨åˆ†åŠŸèƒ½å¯ç”¨æ€»æ¯”å®Œå…¨ä¸å¯ç”¨å¥½

4. **è‡ªåŠ¨è½¬ç§»ï¼ˆAutomatic Failoverï¼‰**
   - è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡/èŠ‚ç‚¹
   - æ— éœ€äººå·¥å¹²é¢„

---

## 2. ç†”æ–­å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰

### 2.1 æ ¸å¿ƒæ€æƒ³

**çµæ„Ÿæ¥æº**ï¼šå®¶ç”¨ç”µè·¯çš„æ–­è·¯å™¨ï¼ˆä¿é™©ä¸ï¼‰

```
æ­£å¸¸æƒ…å†µï¼š
ç”µè·¯ â†’ ç”µå™¨ â†’ æ­£å¸¸å·¥ä½œ âœ…

è¿‡è½½æƒ…å†µï¼š
ç”µè·¯ â†’ ç”µå™¨ â†’ ç”µæµè¿‡å¤§ âš¡ â†’ æ–­è·¯å™¨è·³é—¸ ğŸ”´ â†’ ä¿æŠ¤ç”µè·¯

ç±»æ¯”åˆ°è½¯ä»¶ï¼š
è°ƒç”¨æ–¹ â†’ æœåŠ¡ â†’ æ•…éšœé¢‘å‘ ğŸ’¥ â†’ ç†”æ–­å™¨æ‰“å¼€ ğŸ”´ â†’ ä¿æŠ¤è°ƒç”¨æ–¹
```

**æ ¸å¿ƒç›®æ ‡**ï¼š
1. é˜²æ­¢æ•…éšœæ‰©æ•£
2. å¿«é€Ÿå¤±è´¥ï¼Œé‡Šæ”¾èµ„æº
3. è‡ªåŠ¨æ¢å¤æ£€æµ‹

### 2.2 ä¸‰ç§çŠ¶æ€

ç†”æ–­å™¨æœ‰ä¸‰ç§çŠ¶æ€ï¼Œç±»ä¼¼æœ‰é™çŠ¶æ€æœºï¼š

```
       å…³é—­ï¼ˆClosedï¼‰
       æ­£å¸¸è½¬å‘è¯·æ±‚
            â†“
       ç›‘æ§å¤±è´¥ç‡
            â†“
       è¾¾åˆ°é˜ˆå€¼ï¼Ÿ
         /    \
       æ˜¯      å¦
        â†“       â†“
    æ‰“å¼€      ç»§ç»­å…³é—­
   (Open)
   æ‹’ç»è¯·æ±‚
        â†“
    ç­‰å¾…è¶…æ—¶
        â†“
   åŠå¼€ï¼ˆHalf-Openï¼‰
   å°è¯•å°‘é‡è¯·æ±‚
      /        \
    æˆåŠŸ        å¤±è´¥
     â†“           â†“
   å…³é—­        æ‰“å¼€
```

#### çŠ¶æ€ 1ï¼šå…³é—­ï¼ˆClosedï¼‰

**è¡Œä¸º**ï¼š
- æ­£å¸¸è½¬å‘æ‰€æœ‰è¯·æ±‚åˆ°ä¸‹æ¸¸æœåŠ¡
- ç»Ÿè®¡è¯·æ±‚æˆåŠŸ/å¤±è´¥æ¬¡æ•°
- ç›‘æ§å¤±è´¥ç‡

**è§¦å‘æ¡ä»¶**ï¼š
- å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 50%ï¼‰
- æˆ–è¿ç»­å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 5 æ¬¡ï¼‰

**è½¬æ¢**ï¼šClosed â†’ Open

**ç¤ºä¾‹**ï¼š
```
æ—¶é—´    è¯·æ±‚    ç»“æœ    å¤±è´¥ç‡    çŠ¶æ€
T1      è¯·æ±‚1   æˆåŠŸ    0%       Closed
T2      è¯·æ±‚2   æˆåŠŸ    0%       Closed
T3      è¯·æ±‚3   å¤±è´¥    33%      Closed
T4      è¯·æ±‚4   å¤±è´¥    50%      Closed
T5      è¯·æ±‚5   å¤±è´¥    60%      Closed â†’ Open âš ï¸
```

#### çŠ¶æ€ 2ï¼šæ‰“å¼€ï¼ˆOpenï¼‰

**è¡Œä¸º**ï¼š
- **ç›´æ¥æ‹’ç»**æ‰€æœ‰è¯·æ±‚ï¼Œä¸è°ƒç”¨ä¸‹æ¸¸æœåŠ¡
- ç«‹å³è¿”å›é”™è¯¯æˆ–é™çº§å“åº”
- å¯åŠ¨å®šæ—¶å™¨ï¼Œç­‰å¾…æ¢å¤çª—å£

**ç›®çš„**ï¼š
- å¿«é€Ÿå¤±è´¥ï¼Œé¿å…èµ„æºè€—å°½
- ç»™ä¸‹æ¸¸æœåŠ¡æ¢å¤æ—¶é—´

**æŒç»­æ—¶é—´**ï¼š
- é€šå¸¸ 30-60 ç§’ï¼ˆå¯é…ç½®ï¼‰

**è½¬æ¢**ï¼šOpen â†’ Half-Open

**ç¤ºä¾‹**ï¼š
```
çŠ¶æ€ï¼šOpen
è¯·æ±‚1 â†’ âŒ ç«‹å³è¿”å›é”™è¯¯ï¼ˆä¸è°ƒç”¨ä¸‹æ¸¸ï¼‰
è¯·æ±‚2 â†’ âŒ ç«‹å³è¿”å›é”™è¯¯
...
ï¼ˆç­‰å¾… 30 ç§’ï¼‰
çŠ¶æ€ï¼šHalf-Open
```

#### çŠ¶æ€ 3ï¼šåŠå¼€ï¼ˆHalf-Openï¼‰

**è¡Œä¸º**ï¼š
- å…è®¸**å°‘é‡è¯·æ±‚**é€šè¿‡ï¼ˆå¦‚ 3-5 ä¸ªï¼‰
- æµ‹è¯•ä¸‹æ¸¸æœåŠ¡æ˜¯å¦æ¢å¤
- å…¶ä»–è¯·æ±‚ä»ç„¶è¢«æ‹’ç»

**ç›®çš„**ï¼š
- è°¨æ…éªŒè¯æœåŠ¡æ˜¯å¦æ¢å¤
- é¿å…ä¸€æ¢å¤å°±å¤§é‡æµé‡å†²å‡»

**è½¬æ¢è§„åˆ™**ï¼š
- å¦‚æœæµ‹è¯•è¯·æ±‚**å…¨éƒ¨æˆåŠŸ** â†’ Half-Open â†’ Closed âœ…
- å¦‚æœæœ‰**ä»»ä½•å¤±è´¥** â†’ Half-Open â†’ Open âŒ

**ç¤ºä¾‹**ï¼š
```
çŠ¶æ€ï¼šHalf-Open

æµ‹è¯•è¯·æ±‚1 â†’ æˆåŠŸ âœ…
æµ‹è¯•è¯·æ±‚2 â†’ æˆåŠŸ âœ…
æµ‹è¯•è¯·æ±‚3 â†’ æˆåŠŸ âœ…

â†’ æ‰€æœ‰æµ‹è¯•æˆåŠŸï¼Œè½¬æ¢åˆ° Closed çŠ¶æ€

æ­£å¸¸è¯·æ±‚4 â†’ æˆåŠŸ
æ­£å¸¸è¯·æ±‚5 â†’ æˆåŠŸ
...
```

### 2.3 å®Œæ•´çŠ¶æ€è½¬æ¢å›¾

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Closed    â”‚
                  â”‚ (å…³é—­-æ­£å¸¸)  â”‚
                  â”‚             â”‚
                  â”‚ è½¬å‘æ‰€æœ‰è¯·æ±‚ â”‚
                  â”‚ ç›‘æ§å¤±è´¥ç‡   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  å¤±è´¥ç‡ > é˜ˆå€¼
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”Œâ”€â”€â”€â–¶â”‚    Open     â”‚
             â”‚    â”‚  (æ‰“å¼€-ç†”æ–­) â”‚
             â”‚    â”‚             â”‚
             â”‚    â”‚ æ‹’ç»æ‰€æœ‰è¯·æ±‚ â”‚
             â”‚    â”‚ å¿«é€Ÿå¤±è´¥     â”‚
             â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚           â”‚
             â”‚      ç­‰å¾…è¶…æ—¶æœŸ
             â”‚           â”‚
             â”‚           â–¼
             â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚    â”‚ Half-Open   â”‚
             â”‚    â”‚(åŠå¼€-è¯•æ¢)   â”‚
             â”‚    â”‚             â”‚
             â””â”€â”€â”€â”€â”¤ å…è®¸å°‘é‡è¯·æ±‚ â”‚
      ä»»æ„å¤±è´¥     â”‚ æµ‹è¯•æ¢å¤     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                   å…¨éƒ¨æˆåŠŸ
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Closed    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 å…³é”®å‚æ•°è®¾è®¡

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ | æƒè¡¡ |
|------|------|--------|------|
| **failureThreshold** | è§¦å‘ç†”æ–­çš„å¤±è´¥é˜ˆå€¼ | 50% å¤±è´¥ç‡æˆ–è¿ç»­ 5 æ¬¡å¤±è´¥ | å¤ªä½ï¼šè¿‡åº¦æ•æ„Ÿ<br>å¤ªé«˜ï¼šä¿æŠ¤ä¸åŠæ—¶ |
| **successThreshold** | æ¢å¤éœ€è¦çš„æˆåŠŸæ¬¡æ•° | 3-5 æ¬¡ | å¤ªä½ï¼šå¯èƒ½è¿‡æ—©æ¢å¤<br>å¤ªé«˜ï¼šæ¢å¤å¤ªæ…¢ |
| **timeout** | Open çŠ¶æ€æŒç»­æ—¶é—´ | 30-60 ç§’ | å¤ªçŸ­ï¼šé¢‘ç¹è¯•æ¢<br>å¤ªé•¿ï¼šæ¢å¤æ…¢ |
| **requestVolumeThreshold** | æœ€å°è¯·æ±‚æ•° | 10-20 ä¸ª | é¿å…å› æ ·æœ¬å¤ªå°‘è€Œè¯¯åˆ¤ |
| **slidingWindowSize** | æ»‘åŠ¨çª—å£å¤§å° | 10 ç§’ | ç»Ÿè®¡æœ€è¿‘ N ç§’çš„è¯·æ±‚ |
| **halfOpenMaxCalls** | åŠå¼€çŠ¶æ€å…è®¸çš„æµ‹è¯•è¯·æ±‚æ•° | 3-5 ä¸ª | è°¨æ…è¯•æ¢ |

### 2.5 æ»‘åŠ¨çª—å£ç»Ÿè®¡

ä¸ºäº†å‡†ç¡®è®¡ç®—å¤±è´¥ç‡ï¼Œä½¿ç”¨**æ»‘åŠ¨çª—å£**ç»Ÿè®¡ï¼š

#### å›ºå®šçª—å£çš„é—®é¢˜

```
æ—¶é—´çª—å£: 10 ç§’
å½“å‰æ—¶é—´: 10:00:15

ç»Ÿè®¡: 10:00:10 - 10:00:20 çš„è¯·æ±‚

é—®é¢˜ï¼š
- 10:00:09 çš„è¯·æ±‚ä¸è®¡å…¥ï¼ˆåˆšè¿‡æœŸï¼‰
- è¾¹ç•Œæ•ˆåº”ï¼šçª—å£åˆ‡æ¢æ—¶ç»Ÿè®¡ä¸è¿ç»­
```

#### æ»‘åŠ¨çª—å£ï¼ˆæ¨èï¼‰

```go
type SlidingWindow struct {
    requests []Request
    duration time.Duration
    mu       sync.RWMutex
}

type Request struct {
    timestamp time.Time
    success   bool
}

func (w *SlidingWindow) Record(success bool) {
    w.mu.Lock()
    defer w.mu.Unlock()

    now := time.Now()

    // æ·»åŠ æ–°è¯·æ±‚
    w.requests = append(w.requests, Request{
        timestamp: now,
        success:   success,
    })

    // ç§»é™¤è¿‡æœŸè¯·æ±‚
    cutoff := now.Add(-w.duration)
    for i := 0; i < len(w.requests); i++ {
        if w.requests[i].timestamp.After(cutoff) {
            w.requests = w.requests[i:]
            break
        }
    }
}

func (w *SlidingWindow) GetStats() (total, failures int) {
    w.mu.RLock()
    defer w.mu.RUnlock()

    now := time.Now()
    cutoff := now.Add(-w.duration)

    for _, req := range w.requests {
        if req.timestamp.After(cutoff) {
            total++
            if !req.success {
                failures++
            }
        }
    }

    return total, failures
}

func (w *SlidingWindow) GetFailureRate() float64 {
    total, failures := w.GetStats()
    if total == 0 {
        return 0
    }
    return float64(failures) / float64(total)
}
```

---

## 3. æ•…éšœæ£€æµ‹ç®—æ³•

### 3.1 æ•…éšœçš„å®šä¹‰

é¦–å…ˆéœ€è¦æ˜ç¡®ï¼šä»€ä¹ˆç®—"æ•…éšœ"ï¼Ÿ

| æ•…éšœç±»å‹ | åˆ¤å®šæ ‡å‡† | ä¸¥é‡ç¨‹åº¦ |
|---------|---------|---------|
| **è¿æ¥å¤±è´¥** | æ— æ³•å»ºç«‹ TCP è¿æ¥ | é«˜ âš ï¸âš ï¸âš ï¸ |
| **è¶…æ—¶** | å“åº”æ—¶é—´ > é˜ˆå€¼ | é«˜ âš ï¸âš ï¸âš ï¸ |
| **HTTP 5xx** | 500, 502, 503, 504 | é«˜ âš ï¸âš ï¸ |
| **HTTP 4xx** | 400, 404, 429 | ä¸­ âš ï¸ |
| **æ…¢å“åº”** | å“åº”æ—¶é—´ > P95 é˜ˆå€¼ | ä¸­ âš ï¸ |
| **è¿”å›æ ¼å¼é”™è¯¯** | JSON è§£æå¤±è´¥ | ä¸­ âš ï¸ |

### 3.2 åˆ¤å®šæ ‡å‡†è®¾è®¡

#### æ–¹æ³• 1ï¼šè¿ç»­å¤±è´¥æ¬¡æ•°

**å®šä¹‰**ï¼šè¿ç»­ N æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·

```go
type ConsecutiveFailureDetector struct {
    threshold        int   // é˜ˆå€¼ï¼šè¿ç»­å¤±è´¥å¤šå°‘æ¬¡
    consecutiveFails int   // å½“å‰è¿ç»­å¤±è´¥æ¬¡æ•°
    mu               sync.Mutex
}

func (d *ConsecutiveFailureDetector) RecordResult(success bool) bool {
    d.mu.Lock()
    defer d.mu.Unlock()

    if success {
        d.consecutiveFails = 0  // æˆåŠŸåˆ™é‡ç½®
        return false  // å¥åº·
    }

    d.consecutiveFails++
    return d.consecutiveFails >= d.threshold  // è¾¾åˆ°é˜ˆå€¼ï¼Ÿ
}
```

**ç¤ºä¾‹**ï¼š
```
é˜ˆå€¼: 5 æ¬¡

è¯·æ±‚1 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 1)
è¯·æ±‚2 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 2)
è¯·æ±‚3 â†’ æˆåŠŸ (è¿ç»­å¤±è´¥: 0) â† é‡ç½®
è¯·æ±‚4 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 1)
è¯·æ±‚5 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 2)
è¯·æ±‚6 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 3)
è¯·æ±‚7 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 4)
è¯·æ±‚8 â†’ å¤±è´¥ (è¿ç»­å¤±è´¥: 5) â†’ æ ‡è®°ä¸å¥åº· âŒ
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•å®ç°
- âœ… å¯¹æŒç»­æ•…éšœååº”å¿«

**ç¼ºç‚¹**ï¼š
- âŒ å¿½ç•¥æˆåŠŸç‡
- âŒ ä¸€æ¬¡æˆåŠŸå°±é‡ç½®ï¼Œå¯èƒ½å»¶è¿Ÿæ£€æµ‹

#### æ–¹æ³• 2ï¼šå¤±è´¥ç‡ï¼ˆæ¨èï¼‰

**å®šä¹‰**ï¼šåœ¨æ—¶é—´çª—å£å†…ï¼Œå¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼

```go
type FailureRateDetector struct {
    window           *SlidingWindow
    failureThreshold float64  // å¤±è´¥ç‡é˜ˆå€¼ï¼ˆ0.5 = 50%ï¼‰
    minRequests      int      // æœ€å°è¯·æ±‚æ•°
}

func (d *FailureRateDetector) RecordResult(success bool) bool {
    d.window.Record(success)

    total, failures := d.window.GetStats()

    // è¯·æ±‚æ•°å¤ªå°‘ï¼Œä¸åˆ¤å®š
    if total < d.minRequests {
        return false
    }

    failureRate := float64(failures) / float64(total)
    return failureRate >= d.failureThreshold
}
```

**ç¤ºä¾‹**ï¼š
```
é…ç½®: å¤±è´¥ç‡é˜ˆå€¼ 50%, æœ€å°è¯·æ±‚æ•° 10, æ—¶é—´çª—å£ 10 ç§’

æ—¶é—´    è¯·æ±‚    ç»“æœ    çª—å£å†…ç»Ÿè®¡         å¤±è´¥ç‡    åˆ¤å®š
T1      è¯·æ±‚1   å¤±è´¥    1 å¤±è´¥/1 æ€»      100%     < 10 ä¸ªï¼Œä¸åˆ¤å®š
T2      è¯·æ±‚2   æˆåŠŸ    1 å¤±è´¥/2 æ€»      50%      < 10 ä¸ªï¼Œä¸åˆ¤å®š
...
T10     è¯·æ±‚10  å¤±è´¥    6 å¤±è´¥/10 æ€»     60%      ä¸å¥åº· âŒ
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ›´å‡†ç¡®åæ˜ æ•´ä½“å¥åº·çŠ¶æ€
- âœ… å®¹å¿å¶å‘å¤±è´¥

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°ç¨å¤æ‚
- âŒ éœ€è¦è°ƒæ•´å¤šä¸ªå‚æ•°

#### æ–¹æ³• 3ï¼šç»„åˆç­–ç•¥ï¼ˆæœ€ä½³å®è·µï¼‰

**å®šä¹‰**ï¼šç»“åˆå¤šç§åˆ¤å®šæ ‡å‡†

```go
type CombinedDetector struct {
    consecutiveDetector *ConsecutiveFailureDetector
    rateDetector        *FailureRateDetector
}

func (d *CombinedDetector) RecordResult(success bool) bool {
    // è¿ç»­å¤±è´¥æ£€æµ‹ï¼ˆå¿«é€Ÿå“åº”æŒç»­æ•…éšœï¼‰
    consecutiveUnhealthy := d.consecutiveDetector.RecordResult(success)

    // å¤±è´¥ç‡æ£€æµ‹ï¼ˆæ•´ä½“å¥åº·è¯„ä¼°ï¼‰
    rateUnhealthy := d.rateDetector.RecordResult(success)

    // ä»»æ„ä¸€ä¸ªåˆ¤å®šä¸ºä¸å¥åº·
    return consecutiveUnhealthy || rateUnhealthy
}
```

**è§„åˆ™**ï¼š
- è¿ç»­å¤±è´¥ 5 æ¬¡ â†’ ç«‹å³æ ‡è®°ä¸å¥åº·ï¼ˆå¿«é€Ÿå“åº”ï¼‰
- æˆ–å¤±è´¥ç‡è¶…è¿‡ 50% â†’ æ ‡è®°ä¸å¥åº·ï¼ˆæ•´ä½“è¯„ä¼°ï¼‰

### 3.3 è¶…æ—¶æ£€æµ‹

è¶…æ—¶æ˜¯æœ€å¸¸è§çš„æ•…éšœç±»å‹ï¼Œéœ€è¦åˆç†è®¾ç½®ï¼š

#### è¶…æ—¶æ—¶é—´çš„é€‰æ‹©

```go
type TimeoutConfig struct {
    ConnectTimeout time.Duration  // è¿æ¥è¶…æ—¶
    ReadTimeout    time.Duration  // è¯»è¶…æ—¶
    WriteTimeout   time.Duration  // å†™è¶…æ—¶
}

// æ¨èé…ç½®
config := TimeoutConfig{
    ConnectTimeout: 2 * time.Second,   // è¿æ¥åº”è¯¥å¾ˆå¿«
    ReadTimeout:    5 * time.Second,   // å…è®¸ä¸€å®šå¤„ç†æ—¶é—´
    WriteTimeout:   5 * time.Second,
}
```

#### è‡ªé€‚åº”è¶…æ—¶ï¼ˆé«˜çº§ï¼‰

æ ¹æ®å†å²å“åº”æ—¶é—´åŠ¨æ€è°ƒæ•´ï¼š

```go
type AdaptiveTimeout struct {
    p95Latency time.Duration  // P95 å»¶è¿Ÿ
    multiplier float64         // å€æ•°ï¼ˆå¦‚ 2.0ï¼‰
}

func (t *AdaptiveTimeout) GetTimeout() time.Duration {
    // è¶…æ—¶ = P95 å»¶è¿Ÿ Ã— å€æ•°
    return time.Duration(float64(t.p95Latency) * t.multiplier)
}

// å®šæœŸæ›´æ–° P95 å»¶è¿Ÿ
func (t *AdaptiveTimeout) UpdateP95(latencies []time.Duration) {
    sort.Slice(latencies, func(i, j int) bool {
        return latencies[i] < latencies[j]
    })

    p95Index := int(float64(len(latencies)) * 0.95)
    t.p95Latency = latencies[p95Index]
}
```

---

## 4. è‡ªåŠ¨è½¬ç§»æœºåˆ¶ï¼ˆFailoverï¼‰

### 4.1 ä»€ä¹ˆæ˜¯ Failoverï¼Ÿ

**å®šä¹‰**ï¼šå½“ä¸»æœåŠ¡/èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡/èŠ‚ç‚¹ã€‚

```
æ­£å¸¸æƒ…å†µï¼š
å®¢æˆ·ç«¯ â†’ ä¸»æœåŠ¡ï¼ˆMasterï¼‰âœ…

æ•…éšœå‘ç”Ÿï¼š
å®¢æˆ·ç«¯ â†’ ä¸»æœåŠ¡ âŒ æ•…éšœæ£€æµ‹åˆ°
         â†“
è‡ªåŠ¨è½¬ç§» â†’ å¤‡ç”¨æœåŠ¡ï¼ˆStandbyï¼‰âœ…
```

### 4.2 Failover ç±»å‹

#### ç±»å‹ 1ï¼šä¸»å¤‡åˆ‡æ¢ï¼ˆActive-Passiveï¼‰

**æ¶æ„**ï¼š
```
å®¢æˆ·ç«¯
   â†“
è´Ÿè½½å‡è¡¡å™¨
   â†“
ä¸»èŠ‚ç‚¹ï¼ˆActiveï¼‰âœ… â†â†’ å¿ƒè·³æ£€æµ‹ â†â†’ å¤‡èŠ‚ç‚¹ï¼ˆPassiveï¼‰ğŸ’¤
   â†“
æ•°æ®åº“

æ•…éšœæ—¶ï¼š
ä¸»èŠ‚ç‚¹ âŒ â†’ å¤‡èŠ‚ç‚¹æ¿€æ´» âœ… â†’ æ¥ç®¡æµé‡
```

**ç‰¹ç‚¹**ï¼š
- âœ… åˆ‡æ¢å¿«é€Ÿ
- âœ… æ•°æ®ä¸€è‡´æ€§å¥½ï¼ˆåªæœ‰ä¸€ä¸ªå†™èŠ‚ç‚¹ï¼‰
- âŒ å¤‡èŠ‚ç‚¹èµ„æºæµªè´¹

**é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®åº“ä¸»å¤‡ã€æœ‰çŠ¶æ€æœåŠ¡

#### ç±»å‹ 2ï¼šå¤šæ´»åˆ‡æ¢ï¼ˆActive-Activeï¼‰

**æ¶æ„**ï¼š
```
å®¢æˆ·ç«¯
   â†“
è´Ÿè½½å‡è¡¡å™¨
   â†“
èŠ‚ç‚¹1 âœ… â†â†’ èŠ‚ç‚¹2 âœ… â†â†’ èŠ‚ç‚¹3 âœ…
   â†“        â†“        â†“
     å…±äº«å­˜å‚¨/æ•°æ®åŒæ­¥

æ•…éšœæ—¶ï¼š
èŠ‚ç‚¹1 âŒ â†’ è´Ÿè½½å‡è¡¡å™¨æ£€æµ‹åˆ° â†’ æµé‡åˆ†é…åˆ°èŠ‚ç‚¹2ã€èŠ‚ç‚¹3
```

**ç‰¹ç‚¹**ï¼š
- âœ… èµ„æºåˆ©ç”¨ç‡é«˜
- âœ… æ‰©å±•æ€§å¥½
- âŒ æ•°æ®åŒæ­¥å¤æ‚

**é€‚ç”¨åœºæ™¯**ï¼šæ— çŠ¶æ€æœåŠ¡ã€è¯»å¤šå†™å°‘åœºæ™¯

#### ç±»å‹ 3ï¼šåˆ†çº§ Failover

```
ä¼˜å…ˆçº§é¡ºåºï¼š
ä¸»é›†ç¾¤ï¼ˆæœ¬åœ°æœºæˆ¿ï¼‰â†’ å¤‡é›†ç¾¤ï¼ˆåŒåŸæœºæˆ¿ï¼‰â†’ ç¾å¤‡é›†ç¾¤ï¼ˆå¼‚åœ°æœºæˆ¿ï¼‰

æ•…éšœæ—¶åˆ†çº§å¤„ç†ï¼š
1. ä¸»é›†ç¾¤èŠ‚ç‚¹æ•…éšœ â†’ åˆ‡æ¢åˆ°ä¸»é›†ç¾¤å…¶ä»–èŠ‚ç‚¹
2. ä¸»é›†ç¾¤å…¨éƒ¨æ•…éšœ â†’ åˆ‡æ¢åˆ°å¤‡é›†ç¾¤
3. ä¸»å¤‡é›†ç¾¤éƒ½æ•…éšœ â†’ åˆ‡æ¢åˆ°ç¾å¤‡é›†ç¾¤
```

### 4.3 Failover å®ç°

#### æ­¥éª¤ 1ï¼šæ•…éšœæ£€æµ‹

```go
type FailoverManager struct {
    primary   *Server
    standby   *Server
    detector  *CombinedDetector
    mu        sync.RWMutex
}

func (fm *FailoverManager) CheckHealth() {
    // æ£€æµ‹ä¸»æœåŠ¡å™¨
    healthy := fm.detector.IsHealthy(fm.primary)

    if !healthy {
        log.Printf("ä¸»æœåŠ¡å™¨ä¸å¥åº·ï¼Œå‡†å¤‡åˆ‡æ¢")
        fm.executeFailover()
    }
}
```

#### æ­¥éª¤ 2ï¼šæ‰§è¡Œåˆ‡æ¢

```go
func (fm *FailoverManager) executeFailover() {
    fm.mu.Lock()
    defer fm.mu.Unlock()

    log.Printf("å¼€å§‹ Failover: %s â†’ %s", fm.primary.URL, fm.standby.URL)

    // 1. æ ‡è®°ä¸»æœåŠ¡å™¨ä¸ºä¸å¯ç”¨
    fm.primary.Available = false

    // 2. æ¿€æ´»å¤‡ç”¨æœåŠ¡å™¨
    fm.standby.Available = true

    // 3. äº¤æ¢ä¸»å¤‡è§’è‰²
    fm.primary, fm.standby = fm.standby, fm.primary

    log.Printf("Failover å®Œæˆ")

    // 4. å‘é€å‘Šè­¦é€šçŸ¥
    sendAlert("Failover executed", fm.primary.URL)
}
```

#### æ­¥éª¤ 3ï¼šè‡ªåŠ¨æ¢å¤ï¼ˆFailbackï¼‰

```go
func (fm *FailoverManager) CheckFailback() {
    fm.mu.RLock()
    standby := fm.standby
    fm.mu.RUnlock()

    // æ£€æµ‹åŸä¸»æœåŠ¡å™¨æ˜¯å¦æ¢å¤
    healthy := fm.detector.IsHealthy(standby)

    if healthy {
        log.Printf("åŸä¸»æœåŠ¡å™¨å·²æ¢å¤ï¼Œè€ƒè™‘ Failback")

        // ç­‰å¾…ç¨³å®šæœŸï¼ˆå¦‚ 5 åˆ†é’Ÿï¼‰
        time.Sleep(5 * time.Minute)

        // å†æ¬¡æ£€æŸ¥
        if fm.detector.IsHealthy(standby) {
            fm.executeFailback()
        }
    }
}

func (fm *FailoverManager) executeFailback() {
    fm.mu.Lock()
    defer fm.mu.Unlock()

    log.Printf("å¼€å§‹ Failback")

    // äº¤æ¢å›ä¸»å¤‡è§’è‰²
    fm.primary, fm.standby = fm.standby, fm.primary

    log.Printf("Failback å®Œæˆ")
}
```

### 4.4 è„‘è£‚é—®é¢˜ï¼ˆSplit-Brainï¼‰

#### é—®é¢˜åœºæ™¯

```
åˆå§‹çŠ¶æ€ï¼š
ä¸»èŠ‚ç‚¹ âœ… â†â†’ å¿ƒè·³ â†â†’ å¤‡èŠ‚ç‚¹ ğŸ’¤

ç½‘ç»œåˆ†åŒºå‘ç”Ÿï¼š
ä¸»èŠ‚ç‚¹ âœ…  X   X   X  å¤‡èŠ‚ç‚¹ ğŸ’¤
         |ç½‘ç»œæ–­å¼€|
              â†“
ä¸»èŠ‚ç‚¹è®¤ä¸ºæ­£å¸¸ï¼Œç»§ç»­å·¥ä½œ
å¤‡èŠ‚ç‚¹æ£€æµ‹ä¸åˆ°å¿ƒè·³ï¼Œè®¤ä¸ºä¸»èŠ‚ç‚¹æŒ‚äº† â†’ æ¿€æ´»è‡ªå·±

ç»“æœï¼š
ä¸¤ä¸ªä¸»èŠ‚ç‚¹åŒæ—¶å·¥ä½œ âŒâŒ
```

**å±å®³**ï¼š
- æ•°æ®ä¸ä¸€è‡´
- å†²çªæ“ä½œ
- èµ„æºäº‰æŠ¢

#### è§£å†³æ–¹æ¡ˆ 1ï¼šFencingï¼ˆéš”ç¦»ï¼‰

```go
type FencingMechanism struct {
    sharedStorage Storage
}

func (f *FencingMechanism) AcquireLock(nodeID string) bool {
    // åœ¨å…±äº«å­˜å‚¨ä¸­å°è¯•è·å–é”
    success := f.sharedStorage.TryLock("master_lock", nodeID)

    if !success {
        log.Printf("èŠ‚ç‚¹ %s æ— æ³•è·å–ä¸»é”ï¼Œä¿æŒå¤‡ç”¨çŠ¶æ€", nodeID)
        return false
    }

    log.Printf("èŠ‚ç‚¹ %s è·å–ä¸»é”æˆåŠŸï¼Œæ¿€æ´»ä¸ºä¸»èŠ‚ç‚¹", nodeID)
    return true
}

func (f *FencingMechanism) Activate(nodeID string) {
    // åªæœ‰è·å¾—é”çš„èŠ‚ç‚¹æ‰èƒ½æ¿€æ´»
    if f.AcquireLock(nodeID) {
        activateAsMaster()
    } else {
        remainAsStandby()
    }
}
```

#### è§£å†³æ–¹æ¡ˆ 2ï¼šQuorumï¼ˆå¤šæ•°æ´¾ï¼‰

```go
type QuorumCheck struct {
    nodes      []*Node
    quorumSize int  // å¤šæ•°æ´¾å¤§å°
}

func (q *QuorumCheck) CanActivate(nodeID string) bool {
    // æ£€æŸ¥èƒ½å¦è”ç³»åˆ°å¤šæ•°æ´¾èŠ‚ç‚¹
    reachable := 0
    for _, node := range q.nodes {
        if ping(node) {
            reachable++
        }
    }

    // å¿…é¡»è”ç³»åˆ°å¤šæ•°æ´¾æ‰èƒ½æ¿€æ´»
    canActivate := reachable >= q.quorumSize

    if !canActivate {
        log.Printf("èŠ‚ç‚¹ %s æ— æ³•è”ç³»åˆ°å¤šæ•°æ´¾ï¼Œä¸èƒ½æ¿€æ´»", nodeID)
    }

    return canActivate
}

// ç¤ºä¾‹ï¼š5 ä¸ªèŠ‚ç‚¹ï¼Œquorum = 3
// è‡³å°‘èƒ½è”ç³»åˆ° 3 ä¸ªèŠ‚ç‚¹æ‰èƒ½æ¿€æ´»ä¸ºä¸»èŠ‚ç‚¹
```

---

## 5. å®è·µï¼šGo å®ç°å®Œæ•´çš„æ•…éšœæ£€æµ‹ä¸è½¬ç§»ç³»ç»Ÿ

### 5.1 é¡¹ç›®ç»“æ„

```
failover-system/
â”œâ”€â”€ main.go
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ circuitbreaker/
â”‚   â”‚   â””â”€â”€ breaker.go        # ç†”æ–­å™¨
â”‚   â”œâ”€â”€ detector/
â”‚   â”‚   â”œâ”€â”€ consecutive.go    # è¿ç»­å¤±è´¥æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ rate.go           # å¤±è´¥ç‡æ£€æµ‹
â”‚   â”‚   â””â”€â”€ combined.go       # ç»„åˆæ£€æµ‹
â”‚   â”œâ”€â”€ failover/
â”‚   â”‚   â””â”€â”€ manager.go        # Failover ç®¡ç†å™¨
â”‚   â””â”€â”€ window/
â”‚       â””â”€â”€ sliding.go        # æ»‘åŠ¨çª—å£
â””â”€â”€ internal/
    â””â”€â”€ server/
        â””â”€â”€ server.go         # æœåŠ¡å™¨æ¨¡å‹
```

### 5.2 ç†”æ–­å™¨å®Œæ•´å®ç°

```go
package circuitbreaker

import (
    "errors"
    "sync"
    "time"
)

// ç†”æ–­å™¨çŠ¶æ€
type State int

const (
    StateClosed State = iota  // å…³é—­ï¼ˆæ­£å¸¸ï¼‰
    StateOpen                 // æ‰“å¼€ï¼ˆç†”æ–­ï¼‰
    StateHalfOpen            // åŠå¼€ï¼ˆè¯•æ¢ï¼‰
)

func (s State) String() string {
    switch s {
    case StateClosed:
        return "Closed"
    case StateOpen:
        return "Open"
    case StateHalfOpen:
        return "HalfOpen"
    default:
        return "Unknown"
    }
}

// é…ç½®
type Config struct {
    // å¤±è´¥ç‡é˜ˆå€¼
    FailureThreshold float64

    // æœ€å°è¯·æ±‚æ•°ï¼ˆé¿å…æ ·æœ¬å¤ªå°‘ï¼‰
    MinRequests int

    // æ»‘åŠ¨çª—å£å¤§å°
    WindowSize time.Duration

    // Open çŠ¶æ€æŒç»­æ—¶é—´
    OpenTimeout time.Duration

    // åŠå¼€çŠ¶æ€å…è®¸çš„æµ‹è¯•è¯·æ±‚æ•°
    HalfOpenMaxCalls int

    // æ¢å¤éœ€è¦çš„æˆåŠŸæ¬¡æ•°
    SuccessThreshold int
}

// ç†”æ–­å™¨
type CircuitBreaker struct {
    name   string
    config Config
    state  State

    // ç»Ÿè®¡
    requests     []Request
    halfOpenCalls int
    halfOpenSuccesses int

    // çŠ¶æ€åˆ‡æ¢æ—¶é—´
    openedAt time.Time

    mu sync.RWMutex
}

type Request struct {
    timestamp time.Time
    success   bool
}

var ErrCircuitOpen = errors.New("circuit breaker is open")

func New(name string, config Config) *CircuitBreaker {
    return &CircuitBreaker{
        name:     name,
        config:   config,
        state:    StateClosed,
        requests: make([]Request, 0),
    }
}

// æ‰§è¡Œè¯·æ±‚ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
func (cb *CircuitBreaker) Execute(fn func() error) error {
    // æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚
    if !cb.allowRequest() {
        return ErrCircuitOpen
    }

    // æ‰§è¡Œè¯·æ±‚
    err := fn()

    // è®°å½•ç»“æœ
    cb.recordResult(err == nil)

    return err
}

// æ˜¯å¦å…è®¸è¯·æ±‚
func (cb *CircuitBreaker) allowRequest() bool {
    cb.mu.Lock()
    defer cb.mu.Unlock()

    switch cb.state {
    case StateClosed:
        return true  // å…³é—­çŠ¶æ€ï¼šå…è®¸æ‰€æœ‰è¯·æ±‚

    case StateOpen:
        // æ‰“å¼€çŠ¶æ€ï¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥è½¬æ¢åˆ°åŠå¼€
        if time.Since(cb.openedAt) > cb.config.OpenTimeout {
            cb.setState(StateHalfOpen)
            return true
        }
        return false  // ä»åœ¨ç†”æ–­æœŸ

    case StateHalfOpen:
        // åŠå¼€çŠ¶æ€ï¼šåªå…è®¸æœ‰é™çš„æµ‹è¯•è¯·æ±‚
        return cb.halfOpenCalls < cb.config.HalfOpenMaxCalls

    default:
        return false
    }
}

// è®°å½•è¯·æ±‚ç»“æœ
func (cb *CircuitBreaker) recordResult(success bool) {
    cb.mu.Lock()
    defer cb.mu.Unlock()

    now := time.Now()

    // æ·»åŠ è¯·æ±‚è®°å½•
    cb.requests = append(cb.requests, Request{
        timestamp: now,
        success:   success,
    })

    // æ¸…ç†è¿‡æœŸè®°å½•
    cb.cleanOldRequests(now)

    // æ ¹æ®çŠ¶æ€å¤„ç†
    switch cb.state {
    case StateClosed:
        cb.handleClosedState()

    case StateHalfOpen:
        cb.handleHalfOpenState(success)
    }
}

// å¤„ç†å…³é—­çŠ¶æ€
func (cb *CircuitBreaker) handleClosedState() {
    total, failures := cb.getStats()

    // è¯·æ±‚æ•°ä¸å¤Ÿï¼Œä¸åˆ¤å®š
    if total < cb.config.MinRequests {
        return
    }

    // è®¡ç®—å¤±è´¥ç‡
    failureRate := float64(failures) / float64(total)

    // è¶…è¿‡é˜ˆå€¼ï¼Œæ‰“å¼€ç†”æ–­å™¨
    if failureRate >= cb.config.FailureThreshold {
        log.Printf("[%s] å¤±è´¥ç‡ %.2f%% è¶…è¿‡é˜ˆå€¼ %.2f%%ï¼Œæ‰“å¼€ç†”æ–­å™¨",
            cb.name, failureRate*100, cb.config.FailureThreshold*100)
        cb.setState(StateOpen)
    }
}

// å¤„ç†åŠå¼€çŠ¶æ€
func (cb *CircuitBreaker) handleHalfOpenState(success bool) {
    cb.halfOpenCalls++

    if success {
        cb.halfOpenSuccesses++
    } else {
        // æœ‰ä»»ä½•å¤±è´¥ï¼Œç«‹å³å›åˆ°æ‰“å¼€çŠ¶æ€
        log.Printf("[%s] åŠå¼€çŠ¶æ€æµ‹è¯•å¤±è´¥ï¼Œé‡æ–°æ‰“å¼€ç†”æ–­å™¨", cb.name)
        cb.setState(StateOpen)
        return
    }

    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¢å¤æ¡ä»¶
    if cb.halfOpenSuccesses >= cb.config.SuccessThreshold {
        log.Printf("[%s] åŠå¼€çŠ¶æ€æµ‹è¯•æˆåŠŸï¼Œå…³é—­ç†”æ–­å™¨", cb.name)
        cb.setState(StateClosed)
    }
}

// è®¾ç½®çŠ¶æ€
func (cb *CircuitBreaker) setState(state State) {
    oldState := cb.state
    cb.state = state

    // çŠ¶æ€åˆ‡æ¢æ—¶çš„å¤„ç†
    switch state {
    case StateOpen:
        cb.openedAt = time.Now()

    case StateHalfOpen:
        cb.halfOpenCalls = 0
        cb.halfOpenSuccesses = 0

    case StateClosed:
        cb.requests = make([]Request, 0)
    }

    log.Printf("[%s] çŠ¶æ€åˆ‡æ¢: %s â†’ %s", cb.name, oldState, state)
}

// æ¸…ç†è¿‡æœŸè¯·æ±‚
func (cb *CircuitBreaker) cleanOldRequests(now time.Time) {
    cutoff := now.Add(-cb.config.WindowSize)

    for i := 0; i < len(cb.requests); i++ {
        if cb.requests[i].timestamp.After(cutoff) {
            cb.requests = cb.requests[i:]
            return
        }
    }

    cb.requests = make([]Request, 0)
}

// è·å–ç»Ÿè®¡ä¿¡æ¯
func (cb *CircuitBreaker) getStats() (total, failures int) {
    now := time.Now()
    cutoff := now.Add(-cb.config.WindowSize)

    for _, req := range cb.requests {
        if req.timestamp.After(cutoff) {
            total++
            if !req.success {
                failures++
            }
        }
    }

    return total, failures
}

// è·å–å½“å‰çŠ¶æ€
func (cb *CircuitBreaker) GetState() State {
    cb.mu.RLock()
    defer cb.mu.RUnlock()
    return cb.state
}

// è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¤–éƒ¨æ¥å£ï¼‰
func (cb *CircuitBreaker) GetMetrics() map[string]interface{} {
    cb.mu.RLock()
    defer cb.mu.RUnlock()

    total, failures := cb.getStats()
    failureRate := 0.0
    if total > 0 {
        failureRate = float64(failures) / float64(total)
    }

    return map[string]interface{}{
        "state":        cb.state.String(),
        "total":        total,
        "failures":     failures,
        "failure_rate": failureRate,
    }
}
```

### 5.3 ä½¿ç”¨ç¤ºä¾‹

```go
package main

import (
    "errors"
    "fmt"
    "math/rand"
    "time"
    "failover-system/pkg/circuitbreaker"
)

func main() {
    // é…ç½®ç†”æ–­å™¨
    config := circuitbreaker.Config{
        FailureThreshold:  0.5,              // 50% å¤±è´¥ç‡
        MinRequests:       10,               // æœ€å°‘ 10 ä¸ªè¯·æ±‚
        WindowSize:        10 * time.Second, // 10 ç§’çª—å£
        OpenTimeout:       30 * time.Second, // ç†”æ–­ 30 ç§’
        HalfOpenMaxCalls:  3,                // åŠå¼€æ—¶æµ‹è¯• 3 ä¸ªè¯·æ±‚
        SuccessThreshold:  3,                // 3 æ¬¡æˆåŠŸæ¢å¤
    }

    cb := circuitbreaker.New("order-service", config)

    // æ¨¡æ‹Ÿæ•…éšœæœåŠ¡
    callOrderService := func() error {
        // æ¨¡æ‹Ÿï¼š70% çš„è¯·æ±‚å¤±è´¥
        if rand.Float64() < 0.7 {
            return errors.New("service unavailable")
        }
        return nil
    }

    // æŒç»­è°ƒç”¨
    for i := 0; i < 100; i++ {
        err := cb.Execute(callOrderService)

        if err != nil {
            if err == circuitbreaker.ErrCircuitOpen {
                fmt.Printf("è¯·æ±‚ %d: ç†”æ–­å™¨æ‰“å¼€ï¼Œå¿«é€Ÿå¤±è´¥\n", i+1)
            } else {
                fmt.Printf("è¯·æ±‚ %d: è°ƒç”¨å¤±è´¥ - %v\n", i+1, err)
            }
        } else {
            fmt.Printf("è¯·æ±‚ %d: è°ƒç”¨æˆåŠŸ\n", i+1)
        }

        // æ‰“å°ç†”æ–­å™¨çŠ¶æ€
        if (i+1)%10 == 0 {
            metrics := cb.GetMetrics()
            fmt.Printf("\n--- ç»Ÿè®¡ï¼ˆå‰ %d ä¸ªè¯·æ±‚ï¼‰---\n", i+1)
            fmt.Printf("çŠ¶æ€: %s\n", metrics["state"])
            fmt.Printf("å¤±è´¥ç‡: %.2f%%\n\n", metrics["failure_rate"].(float64)*100)
        }

        time.Sleep(100 * time.Millisecond)
    }
}
```

**è¿è¡Œç»“æœ**ï¼š
```
è¯·æ±‚ 1: è°ƒç”¨å¤±è´¥ - service unavailable
è¯·æ±‚ 2: è°ƒç”¨å¤±è´¥ - service unavailable
è¯·æ±‚ 3: è°ƒç”¨æˆåŠŸ
...
è¯·æ±‚ 10: è°ƒç”¨å¤±è´¥ - service unavailable

--- ç»Ÿè®¡ï¼ˆå‰ 10 ä¸ªè¯·æ±‚ï¼‰---
çŠ¶æ€: Closed
å¤±è´¥ç‡: 70.00%

[order-service] å¤±è´¥ç‡ 70.00% è¶…è¿‡é˜ˆå€¼ 50.00%ï¼Œæ‰“å¼€ç†”æ–­å™¨
[order-service] çŠ¶æ€åˆ‡æ¢: Closed â†’ Open

è¯·æ±‚ 11: ç†”æ–­å™¨æ‰“å¼€ï¼Œå¿«é€Ÿå¤±è´¥
è¯·æ±‚ 12: ç†”æ–­å™¨æ‰“å¼€ï¼Œå¿«é€Ÿå¤±è´¥
...

ï¼ˆ30 ç§’åï¼‰

[order-service] çŠ¶æ€åˆ‡æ¢: Open â†’ HalfOpen

è¯·æ±‚ 41: è°ƒç”¨å¤±è´¥ - service unavailable
[order-service] åŠå¼€çŠ¶æ€æµ‹è¯•å¤±è´¥ï¼Œé‡æ–°æ‰“å¼€ç†”æ–­å™¨
[order-service] çŠ¶æ€åˆ‡æ¢: HalfOpen â†’ Open
```

---

## 6. ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹åˆ†æ

### 6.1 æ¡ˆä¾‹1ï¼šNetflix Hystrix

**èƒŒæ™¯**ï¼šNetflix çš„å¾®æœåŠ¡æ¶æ„ï¼Œæ•°ç™¾ä¸ªæœåŠ¡ç›¸äº’è°ƒç”¨

**é—®é¢˜**ï¼š
- æœåŠ¡é—´ä¾èµ–å¤æ‚
- ä¸€ä¸ªæœåŠ¡æ•…éšœå¯¼è‡´çº§è”å¤±è´¥
- 2011 å¹´å‘ç”Ÿé‡å¤§æ•…éšœï¼ˆAPI æœåŠ¡è°ƒç”¨ä¸ªæ€§åŒ–æ¨èæœåŠ¡è¶…æ—¶ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šHystrix ç†”æ–­å™¨åº“

**å…³é”®è®¾è®¡**ï¼š
```java
@HystrixCommand(
    fallbackMethod = "getFallbackRecommendations",
    commandProperties = {
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "1000"),
        @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
        @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
    }
)
public List<Movie> getRecommendations(long userId) {
    return recommendationService.getRecommendations(userId);
}

// é™çº§æ–¹æ³•
public List<Movie> getFallbackRecommendations(long userId) {
    // è¿”å›é€šç”¨æ¨èï¼ˆä¸ä¸ªæ€§åŒ–ï¼‰
    return genericRecommendations();
}
```

**æ•ˆæœ**ï¼š
- âœ… å•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“
- âœ… ç³»ç»Ÿå¯ç”¨æ€§ä» 99% æå‡åˆ° 99.99%
- âœ… ç”¨æˆ·ä½“éªŒæ”¹å–„ï¼ˆé™çº§æ€»æ¯”å®Œå…¨å¤±è´¥å¥½ï¼‰

### 6.2 æ¡ˆä¾‹2ï¼šæ·˜å®åŒåä¸€

**èƒŒæ™¯**ï¼šåŒåä¸€æµé‡æš´å¢ 100 å€

**æŒ‘æˆ˜**ï¼š
- åº“å­˜æœåŠ¡å‹åŠ›å·¨å¤§
- æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶
- è®¢å•æœåŠ¡è¢«æ‹–å®

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†çº§ç†”æ–­ + é™çº§

```
1. åº“å­˜æœåŠ¡è¿‡è½½ â†’ ç†”æ–­åº“å­˜å®æ—¶æŸ¥è¯¢
   é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ç¼“å­˜çš„åº“å­˜æ•°æ®ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼Œä½†å¯ç”¨ï¼‰

2. æ¨èæœåŠ¡è¿‡è½½ â†’ ç†”æ–­ä¸ªæ€§åŒ–æ¨è
   é™çº§æ–¹æ¡ˆï¼šè¿”å›çƒ­é—¨å•†å“åˆ—è¡¨

3. è¯„è®ºæœåŠ¡è¿‡è½½ â†’ ç†”æ–­è¯„è®ºåŠ è½½
   é™çº§æ–¹æ¡ˆï¼šä»…æ˜¾ç¤º"æŸ¥çœ‹è¯„è®º"æŒ‰é’®ï¼Œç‚¹å‡»æ‰åŠ è½½
```

**åˆ†çº§ç­–ç•¥**ï¼š
| è´Ÿè½½çº§åˆ« | åŠ¨ä½œ |
|---------|------|
| < 60% | æ­£å¸¸æœåŠ¡ |
| 60%-80% | å…³é—­éæ ¸å¿ƒåŠŸèƒ½ï¼ˆæ¨èã€è¯„è®ºï¼‰ |
| 80%-90% | é™çº§æ¬¡è¦åŠŸèƒ½ï¼ˆä½¿ç”¨ç¼“å­˜åº“å­˜ï¼‰ |
| > 90% | åªä¿ç•™æ ¸å¿ƒä¸‹å•æµç¨‹ |

**æ•ˆæœ**ï¼š
- âœ… æˆåŠŸåº”å¯¹ 10 å€æµé‡å³°å€¼
- âœ… æ ¸å¿ƒäº¤æ˜“åŠŸèƒ½å§‹ç»ˆå¯ç”¨
- âœ… ç”¨æˆ·ä½“éªŒéƒ¨åˆ†é™çº§ä½†å¯æ¥å—

---

## 7. æœ€ä½³å®è·µä¸é™·é˜±

### 7.1 å‚æ•°è°ƒä¼˜æœ€ä½³å®è·µ

#### å¤±è´¥ç‡é˜ˆå€¼

```
æ¨èå€¼: 50%

å¤ªä½ï¼ˆå¦‚ 10%ï¼‰ï¼š
âŒ è¿‡äºæ•æ„Ÿï¼Œå¶å‘æ•…éšœå°±ç†”æ–­
âŒ é¢‘ç¹æ‰“å¼€ç†”æ–­å™¨ï¼Œå½±å“å¯ç”¨æ€§

å¤ªé«˜ï¼ˆå¦‚ 90%ï¼‰ï¼š
âŒ ä¿æŠ¤ä¸åŠæ—¶ï¼Œå¤§é‡è¯·æ±‚å¤±è´¥
âŒ èµ„æºè€—å°½é£é™©
```

#### æœ€å°è¯·æ±‚æ•°

```
æ¨èå€¼: 10-20

å¤ªä½ï¼ˆå¦‚ 3ï¼‰ï¼š
âŒ æ ·æœ¬å¤ªå°‘ï¼Œç»Ÿè®¡ä¸å‡†ç¡®
âŒ å®¹æ˜“è¯¯åˆ¤

å¤ªé«˜ï¼ˆå¦‚ 100ï¼‰ï¼š
âŒ éœ€è¦å¤§é‡å¤±è´¥æ‰èƒ½è§¦å‘
âŒ æ•…éšœå½±å“èŒƒå›´å¤§
```

#### ç†”æ–­æŒç»­æ—¶é—´

```
æ¨èå€¼: 30-60 ç§’

å¤ªçŸ­ï¼ˆå¦‚ 5 ç§’ï¼‰ï¼š
âŒ æœåŠ¡è¿˜æœªæ¢å¤å°±è¯•æ¢
âŒ é¢‘ç¹çŠ¶æ€åˆ‡æ¢

å¤ªé•¿ï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ï¼š
âŒ æœåŠ¡å·²æ¢å¤ä½†ä»è¢«ç†”æ–­
âŒ å½±å“ç”¨æˆ·ä½“éªŒ
```

### 7.2 å¸¸è§é™·é˜±

#### é™·é˜± 1ï¼šæ²¡æœ‰é™çº§æ–¹æ¡ˆ

**é—®é¢˜**ï¼š
```go
// âŒ é”™è¯¯ç¤ºä¾‹
err := cb.Execute(func() error {
    return callService()
})

if err != nil {
    return err  // ç›´æ¥è¿”å›é”™è¯¯ç»™ç”¨æˆ·
}
```

**æ”¹è¿›**ï¼š
```go
// âœ… æ­£ç¡®ç¤ºä¾‹
err := cb.Execute(func() error {
    return callService()
})

if err != nil {
    if err == circuitbreaker.ErrCircuitOpen {
        // é™çº§ï¼šä½¿ç”¨ç¼“å­˜æ•°æ®
        return getCachedData()
    }
    return err
}
```

#### é™·é˜± 2ï¼šç†”æ–­å™¨ç²’åº¦è¿‡ç²—

**é—®é¢˜**ï¼š
```go
// âŒ æ•´ä¸ªæœåŠ¡ä¸€ä¸ªç†”æ–­å™¨
cb := circuitbreaker.New("user-service", config)

// é—®é¢˜ï¼šä¸€ä¸ªæ¥å£æ•…éšœï¼Œæ‰€æœ‰æ¥å£éƒ½è¢«ç†”æ–­
```

**æ”¹è¿›**ï¼š
```go
// âœ… æ¯ä¸ªæ¥å£ç‹¬ç«‹ç†”æ–­å™¨
getUserCB := circuitbreaker.New("user-service:getUser", config)
updateUserCB := circuitbreaker.New("user-service:updateUser", config)

// ä¼˜ç‚¹ï¼šç»†ç²’åº¦æ§åˆ¶ï¼Œäº’ä¸å½±å“
```

#### é™·é˜± 3ï¼šå¿½ç•¥è¶…æ—¶è®¾ç½®

**é—®é¢˜**ï¼š
```go
// âŒ æ²¡æœ‰è¶…æ—¶æ§åˆ¶
cb.Execute(func() error {
    return http.Get("http://slow-service")  // å¯èƒ½ç­‰å¾…å¾ˆä¹…
})
```

**æ”¹è¿›**ï¼š
```go
// âœ… è®¾ç½®è¶…æ—¶
client := &http.Client{Timeout: 2 * time.Second}

cb.Execute(func() error {
    _, err := client.Get("http://slow-service")
    return err
})
```

#### é™·é˜± 4ï¼šé™çº§é›ªå´©

**é—®é¢˜**ï¼š
```
æœåŠ¡ A æ•…éšœ â†’ é™çº§åˆ°æœåŠ¡ B
     â†“
æœåŠ¡ B çªç„¶å‹åŠ›æš´å¢
     â†“
æœåŠ¡ B ä¹Ÿæ•…éšœ ğŸ’¥
     â†“
æ•´ä¸ªç³»ç»Ÿå´©æºƒ âŒ
```

**æ”¹è¿›**ï¼š
```go
// é™çº§æ—¶ä¹Ÿè¦é™æµ
func getDegradedData() {
    // é™æµï¼šæœ€å¤š 100 QPS
    if !rateLimiter.Allow() {
        return defaultData
    }

    return backupService.GetData()
}
```

### 7.3 ç›‘æ§æŒ‡æ ‡

ç”Ÿäº§ç¯å¢ƒåº”ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

#### ç†”æ–­å™¨æŒ‡æ ‡

```go
type Metrics struct {
    CircuitBreakerState string   // çŠ¶æ€ï¼ˆClosed/Open/HalfOpenï¼‰
    TotalRequests       int64    // æ€»è¯·æ±‚æ•°
    FailedRequests      int64    // å¤±è´¥è¯·æ±‚æ•°
    FailureRate         float64  // å¤±è´¥ç‡
    RejectedRequests    int64    // ç†”æ–­æ‹’ç»çš„è¯·æ±‚æ•°
    StateChanges        int64    // çŠ¶æ€åˆ‡æ¢æ¬¡æ•°
}
```

#### å‘Šè­¦è§„åˆ™

```yaml
alerts:
  - name: CircuitBreakerOpen
    condition: circuit_breaker_state == "Open"
    duration: 1m
    severity: critical
    message: "ç†”æ–­å™¨ {{ $labels.service }} å·²æ‰“å¼€"

  - name: HighFailureRate
    condition: failure_rate > 0.3
    duration: 5m
    severity: warning
    message: "æœåŠ¡ {{ $labels.service }} å¤±è´¥ç‡è¿‡é«˜"

  - name: FrequentStateChanges
    condition: rate(state_changes[5m]) > 10
    duration: 5m
    severity: warning
    message: "ç†”æ–­å™¨ {{ $labels.service }} çŠ¶æ€é¢‘ç¹åˆ‡æ¢"
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **é›ªå´©æ•ˆåº”çš„å±å®³**
   - ä¸€ä¸ªæœåŠ¡æ•…éšœå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ
   - éœ€è¦å¿«é€Ÿéš”ç¦»æ•…éšœæœåŠ¡

2. **ç†”æ–­å™¨çš„ä¸‰ç§çŠ¶æ€**
   - Closedï¼ˆå…³é—­ï¼‰ï¼šæ­£å¸¸è½¬å‘
   - Openï¼ˆæ‰“å¼€ï¼‰ï¼šå¿«é€Ÿå¤±è´¥
   - Half-Openï¼ˆåŠå¼€ï¼‰ï¼šè°¨æ…è¯•æ¢

3. **æ•…éšœæ£€æµ‹ç®—æ³•**
   - è¿ç»­å¤±è´¥æ¬¡æ•°ï¼ˆç®€å•å¿«é€Ÿï¼‰
   - å¤±è´¥ç‡ï¼ˆæ›´å‡†ç¡®ï¼‰
   - ç»„åˆç­–ç•¥ï¼ˆæœ€ä½³å®è·µï¼‰

4. **è‡ªåŠ¨è½¬ç§»ï¼ˆFailoverï¼‰**
   - ä¸»å¤‡åˆ‡æ¢
   - å¤šæ´»åˆ‡æ¢
   - é˜²æ­¢è„‘è£‚

5. **é™çº§ç­–ç•¥ä¸å¯å°‘**
   - æ€»æ¯”å®Œå…¨å¤±è´¥å¥½
   - ç¼“å­˜ã€é»˜è®¤å€¼ã€é€šç”¨æ–¹æ¡ˆ

### è®¾è®¡æ¸…å•

è®¾è®¡æ•…éšœæ£€æµ‹ä¸è½¬ç§»ç³»ç»Ÿæ—¶ï¼Œé—®è‡ªå·±ï¼š

- [ ] å“ªäº›æ•…éšœéœ€è¦æ£€æµ‹ï¼Ÿï¼ˆè¶…æ—¶ã€5xxã€æ…¢å“åº”ï¼‰
- [ ] å¤±è´¥é˜ˆå€¼è®¾ç½®å¤šå°‘ï¼Ÿï¼ˆ50% å¤±è´¥ç‡ or è¿ç»­ 5 æ¬¡ï¼‰
- [ ] ç†”æ–­ååšä»€ä¹ˆï¼Ÿï¼ˆè¿”å›é”™è¯¯ or é™çº§æ–¹æ¡ˆï¼‰
- [ ] å¦‚ä½•éªŒè¯æ¢å¤ï¼Ÿï¼ˆåŠå¼€çŠ¶æ€æµ‹è¯•ï¼‰
- [ ] Failover éœ€è¦å¤šå¿«ï¼Ÿï¼ˆç§’çº§ or åˆ†é’Ÿçº§ï¼‰
- [ ] å¦‚ä½•é˜²æ­¢è„‘è£‚ï¼Ÿï¼ˆFencing or Quorumï¼‰
- [ ] é™çº§æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆç¼“å­˜ã€é»˜è®¤å€¼ã€å¤‡ç”¨æœåŠ¡ï¼‰

### è¿›ä¸€æ­¥å­¦ä¹ 

1. **å¼€æºå®ç°å­¦ä¹ **
   - Netflix Hystrixï¼ˆç»å…¸å®ç°ï¼‰
   - Resilience4jï¼ˆç°ä»£åŒ–æ›¿ä»£ï¼‰
   - Go-kit circuit breaker

2. **æ·±å…¥ä¸»é¢˜**
   - Raft å…±è¯†ç®—æ³•ï¼ˆåˆ†å¸ƒå¼ä¸»å¤‡é€‰ä¸¾ï¼‰
   - æœåŠ¡ç½‘æ ¼ä¸­çš„ç†”æ–­ï¼ˆIstioã€Linkerdï¼‰
   - æ··æ²Œå·¥ç¨‹ï¼ˆChaos Engineeringï¼‰

3. **å®è·µé¡¹ç›®**
   - ä¸ºä½ çš„å¾®æœåŠ¡æ·»åŠ ç†”æ–­å™¨
   - å®ç°åˆ†çº§é™çº§ç­–ç•¥
   - æ­å»ºå®Œæ•´çš„ Failover ç³»ç»Ÿ

---

**è®°ä½**ï¼šæ•…éšœæ˜¯å¸¸æ€ï¼Œè®¾è®¡ç³»ç»Ÿæ—¶è¦æ‹¥æŠ±å¤±è´¥ï¼Œè€Œä¸æ˜¯å‡è®¾ä¸€åˆ‡æ­£å¸¸ã€‚ç†”æ–­å™¨å’Œ Failover æ˜¯ä¿è¯ç³»ç»Ÿå¼¹æ€§ï¼ˆResilienceï¼‰çš„å…³é”®æœºåˆ¶ã€‚
