# 带宽估算与程序员必记数字

> Back-of-the-envelope Calculations

---

## 一、带宽基础知识

### 1.1 单位换算

**比特与字节**:

```
1 Byte = 8 bits
1 KB = 1024 Bytes
1 MB = 1024 KB = 1,048,576 Bytes
1 GB = 1024 MB = 1,073,741,824 Bytes
1 TB = 1024 GB
1 PB = 1024 TB

网络带宽通常用 bits/s 表示:
1 Mbps (Megabits per second) = 1,000,000 bits/s
1 Gbps (Gigabits per second) = 1,000,000,000 bits/s

转换:
1 Gbps = 125 MB/s (1000 ÷ 8)
10 Gbps = 1.25 GB/s
```

**实际例子**:

```
Q: 1 Gbps 带宽每秒能传输多少张 1MB 的图片？
A: 1 Gbps = 125 MB/s
   125 MB/s ÷ 1 MB/张 = 125 张/秒

Q: 传输 1GB 文件需要多久？
A: 1 Gbps = 125 MB/s
   1024 MB ÷ 125 MB/s ≈ 8.2 秒
```

### 1.2 吞吐量计算

**基本公式**:

```
吞吐量 (Throughput) = QPS × 平均请求大小

示例:
QPS = 1000 requests/s
平均请求大小 = 10 KB
吞吐量 = 1000 × 10 KB = 10 MB/s = 10,000 KB/s = 80 Mbps
```

**双向流量**:

```
Web 应用通常有上行和下行:

下行 (服务器 → 客户端):
- 返回数据: HTML, JSON, 图片
- 通常较大

上行 (客户端 → 服务器):
- 请求数据: HTTP Headers, 表单数据
- 通常较小

示例:
QPS = 500
请求大小 (上行) = 1 KB
响应大小 (下行) = 50 KB

上行带宽 = 500 × 1 KB = 500 KB/s = 4 Mbps
下行带宽 = 500 × 50 KB = 25 MB/s = 200 Mbps
```

---

## 二、程序员必记数字

### 2.1 Jeff Dean 的经典延迟数据

**2024 版本** (更新数据):

```
操作                         延迟           说明
─────────────────────────────────────────────────────
L1 cache reference          0.5 ns         CPU 一级缓存
Branch mispredict           5 ns           分支预测失败
L2 cache reference          7 ns           CPU 二级缓存
Mutex lock/unlock           25 ns          互斥锁
Main memory reference       100 ns         内存访问 ★
Compress 1KB with Snappy    3 μs           压缩 1KB 数据
Send 1KB over 1 Gbps        10 μs          网络发送 1KB
SSD random read             150 μs         SSD 随机读 ★
Read 1MB sequentially       250 μs         顺序读 1MB (内存)
  from memory
Round trip in same DC       500 μs         同数据中心往返 ★
SSD sequential read 1MB     1 ms           SSD 顺序读 1MB
Disk seek                   10 ms          磁盘寻道 ★
Read 1MB sequentially       20 ms          HDD 顺序读 1MB
  from disk
Send packet CA → EU         150 ms         跨大西洋网络 ★
```

**可视化** (指数级差异):

```
1 ns     ──→ L1 cache
10 ns    ───→ L2 cache, mutex
100 ns   ────→ 内存访问
1 μs     ─────→ 压缩, 网络发送
10 μs
100 μs   ──────→ SSD 读, 数据中心往返
1 ms     ───────→ SSD 顺序读
10 ms    ────────→ 磁盘寻道
100 ms   ─────────→ 跨洋网络
1 s      ──────────→ (用户耐心极限)

相对时间换算:
如果 1 ns = 1 秒, 那么:
- 内存访问 (100ns) = 1 分 40 秒
- SSD 读 (150μs) = 1.7 天
- 磁盘寻道 (10ms) = 115 天
- 跨洋网络 (150ms) = 4.8 年
```

### 2.2 必记的容量数字

**存储容量**:

```
L1 Cache:       32-64 KB        (每个 CPU 核)
L2 Cache:       256-512 KB      (每个 CPU 核)
L3 Cache:       8-32 MB         (CPU 共享)
RAM:            8-256 GB        (服务器)
SSD:            256 GB - 4 TB   (单盘)
HDD:            1 TB - 20 TB    (单盘)
```

**网络带宽**:

```
移动网络 (4G):  10-50 Mbps
家庭宽带:       100-1000 Mbps (100M-1G)
企业网络:       1-10 Gbps
数据中心:       10-100 Gbps
跨洋光缆:       100+ Gbps
```

**数据库性能**:

```
MySQL (单机):
- QPS (读):     10,000-50,000
- TPS (写):     1,000-5,000

Redis (单机):
- QPS:          100,000+ (GET)
- TPS:          80,000+ (SET)

MongoDB (单机):
- QPS (读):     50,000+
- TPS (写):     10,000+
```

---

## 三、带宽估算实战

### 3.1 图片分发服务

**需求**:
- DAU: 500 万
- 每用户查看图片: 50 张/天
- 图片平均大小: 200 KB
- 峰值因子: 3 倍

**计算**:

```
Step 1: 日总流量
= 5,000,000 用户 × 50 张 × 200 KB
= 50,000,000,000 KB
= 50,000,000 MB
= 48,828 GB
≈ 48 TB/天

Step 2: 平均带宽
= 48 TB / 86,400 秒
= 48 × 1024 GB / 86,400
= 49,152 GB / 86,400
≈ 0.57 GB/s
≈ 570 MB/s
≈ 4.56 Gbps

Step 3: 峰值带宽
= 4.56 Gbps × 3
≈ 13.7 Gbps

Step 4: 加 20% 冗余
= 13.7 × 1.2
≈ 16.5 Gbps

结论: 需要准备 20 Gbps 带宽
```

**成本估算** (AWS CloudFront):

```
前 10 TB:       $0.085/GB
10 TB - 50 TB:  $0.080/GB
50 TB - 150 TB: $0.060/GB
150 TB+:        $0.040/GB

48 TB 每天:
- 前 10 TB:  10,000 GB × $0.085 = $850
- 10-48 TB:  38,000 GB × $0.080 = $3,040
- 日成本:    $3,890
- 月成本:    $3,890 × 30 = $116,700

优化方案:
1. 图片压缩 (200KB → 100KB): 成本减半
2. WebP 格式: 比 JPEG 小 25-35%
3. CDN 分层缓存: 降低回源流量
4. 懒加载: 减少无效请求
```

### 3.2 视频流媒体

**需求**:
- 并发观看: 10,000 人
- 视频码率: 5 Mbps (1080p)
- 视频时长: 平均 60 分钟

**计算**:

```
Step 1: 实时带宽需求
= 10,000 人 × 5 Mbps
= 50,000 Mbps
= 50 Gbps

Step 2: 日流量
= 10,000 人 × 60 分钟 × 5 Mbps
= 10,000 × 3600 秒 × 5 Mbps
= 180,000,000 Mbits
= 180,000 Mbits ÷ 8
= 22,500 MB
= 22.5 GB (单批次)

如果全天滚动播放:
假设平均每小时 10,000 人观看
= 22.5 GB × 24 小时
= 540 GB/天

Step 3: 存储需求
单个视频 (60 分钟, 1080p):
= 60 × 60 秒 × 5 Mbps
= 3600 × 5 Mbits
= 18,000 Mbits ÷ 8
= 2,250 MB
≈ 2.2 GB

1000 个视频:
= 2.2 GB × 1000
= 2,200 GB
≈ 2.2 TB

加 3 副本:
= 2.2 TB × 3
= 6.6 TB
```

**优化方案**:

```
1. 自适应码率 (ABR):
   - 480p:  1.5 Mbps
   - 720p:  3 Mbps
   - 1080p: 5 Mbps
   - 4K:    20 Mbps
   根据网络动态调整

2. CDN 加速:
   - 95% 流量走 CDN
   - 源站只需 2.5 Gbps

3. P2P 技术:
   - 用户互相分享流量
   - 降低 20-50% CDN 成本

4. 预加载:
   - 缓存前 30 秒
   - 提升播放流畅度

最终带宽:
= 50 Gbps × 5% (源站) = 2.5 Gbps
+ P2P 架构
实际带宽成本: < 5 Gbps
```

### 3.3 短视频平台 (抖音类)

**需求**:
- DAU: 1000 万
- 人均上传: 2 视频/天 (50 MB)
- 人均观看: 30 视频/天 (平均 60 秒)
- 视频码率: 3 Mbps

**计算**:

```
Step 1: 日新增存储
= 10,000,000 × 2 × 50 MB
= 1,000,000,000 MB
= 976,562 GB
≈ 1 PB/天

Step 2: 1 年存储
= 1 PB × 365
= 365 PB

加 3 副本:
= 365 × 3
= 1,095 PB
≈ 1.1 EB (Exabyte)

Step 3: 观看流量
每天观看总数:
= 10,000,000 × 30 = 300,000,000 次

单次观看流量:
= 60 秒 × 3 Mbps
= 180 Mbits ÷ 8
= 22.5 MB

日观看流量:
= 300,000,000 × 22.5 MB
= 6,750,000,000 MB
= 6,592,968 GB
≈ 6,640 TB

月观看流量:
= 6,640 × 30
= 199,200 TB
≈ 200 PB/月

Step 4: 带宽估算
峰值带宽 (假设 10 万并发):
= 100,000 × 3 Mbps
= 300,000 Mbps
= 300 Gbps
```

**成本估算** (粗略):

```
存储 (S3 Standard, $0.023/GB/月):
365 PB = 365,000,000 GB
= 365,000,000 × $0.023
= $8,395,000/月

CDN (CloudFront, 平均 $0.03/GB):
200 PB = 200,000,000 GB
= 200,000,000 × $0.03
= $6,000,000/月

总成本:
= $8,395,000 + $6,000,000
= $14,395,000/月
≈ $14.4M/月
≈ $173M/年

优化后 (冷热分层 + 压缩 + P2P):
实际成本可降至 $50-80M/年
```

---

## 四、系统容量估算

### 4.1 估算框架

**通用步骤**:

```
1. 确定用户规模
   - DAU (日活)
   - MAU (月活)
   - 注册用户

2. 估算流量
   - QPS (读/写分别计算)
   - 峰值因子 (2-5 倍)

3. 估算存储
   - 单条数据大小
   - 日新增量
   - 保留时长 (1年/5年/永久)

4. 估算带宽
   - 上行带宽 (写)
   - 下行带宽 (读)
   - 峰值带宽

5. 估算服务器
   - 应用服务器
   - 数据库
   - 缓存

6. 估算成本
   - 服务器
   - 存储
   - 带宽
```

### 4.2 Twitter 容量规划案例

**用户规模**:

```
注册用户: 10 亿
MAU: 5 亿 (50%)
DAU: 2 亿 (40% of MAU)
```

**功能定义**:

```
- 发推文
- 查看 Timeline
- 点赞/转发
- 搜索
```

**QPS 估算**:

```
写操作 (发推文):
人均: 2 条/天
日总量: 2 亿 × 2 = 4 亿条
平均写 QPS: 4 亿 / 86,400 ≈ 4,630
峰值写 QPS: 4,630 × 3 ≈ 13,890

读操作 (Timeline):
人均: 100 次/天
日总量: 2 亿 × 100 = 200 亿次
平均读 QPS: 200 亿 / 86,400 ≈ 231,481
峰值读 QPS: 231,481 × 3 ≈ 694,444

读写比: 694,444 / 13,890 ≈ 50:1
```

**存储估算**:

```
推文数据:
单条推文:
- 文本 (280字 × 2 bytes UTF-8) = 560 bytes
- 用户 ID (8 bytes) = 8 bytes
- 时间戳 (8 bytes) = 8 bytes
- 点赞/转发数 (各 4 bytes) = 8 bytes
- 其他元数据 ≈ 100 bytes
总计 ≈ 700 bytes ≈ 1 KB

日新增: 4 亿条 × 1 KB = 400 GB/天
5 年: 400 GB × 365 × 5 = 730 TB

图片/视频:
假设 20% 推文包含媒体 (平均 200 KB)
日新增: 4 亿 × 20% × 200 KB = 16 TB/天
5 年: 16 TB × 365 × 5 = 29,200 TB ≈ 29 PB

总存储 (含 3 副本):
文本: 730 TB × 3 = 2,190 TB ≈ 2.2 PB
媒体: 29 PB × 3 = 87 PB
总计: ≈ 90 PB
```

**带宽估算**:

```
写带宽:
文本: 400 GB / 86,400s ≈ 4.6 MB/s ≈ 37 Mbps
媒体: 16 TB / 86,400s ≈ 185 MB/s ≈ 1.48 Gbps
峰值写 (×3): 1.48 × 3 ≈ 4.5 Gbps

读带宽:
假设读写比 50:1
读带宽: 4.5 Gbps × 50 = 225 Gbps

实际 (CDN 承担 95%):
源站读带宽: 225 × 5% = 11.25 Gbps
CDN 带宽: 225 Gbps
```

**服务器估算**:

```
应用服务器:
单机能力: 1,000 QPS
峰值需求: 694,444 QPS
需要: 694,444 / 1,000 ≈ 695 台
加冗余: 700 × 1.5 = 1,050 台

数据库 (MySQL):
主库 (写):
单机写能力: 5,000 TPS
峰值写: 13,890 TPS
需要主库: 13,890 / 5,000 ≈ 3 台 (分片)

从库 (读):
单机读能力: 10,000 QPS
峰值读: 694,444 QPS
需要从库: 694,444 / 10,000 ≈ 70 台

实际 (缓存分担 80% 读):
从库: 70 × 20% = 14 台

缓存 (Redis):
缓存 20% 热数据: 90 PB × 20% = 18 PB
单台 Redis: 256 GB
需要: 18 PB / 256 GB = 70,313 台

优化 (只缓存 7 天数据):
7 天数据: 16 TB × 7 = 112 TB
需要: 112 TB / 256 GB ≈ 450 台
```

**成本估算**:

```
服务器 (AWS EC2 c5.2xlarge, $0.34/h):
1,050 台 × $0.34/h × 730h/月 = $260,190/月

数据库 (RDS db.r5.4xlarge, $1.60/h):
(3 主 + 14 从) × $1.60/h × 730h/月 = $19,856/月

缓存 (ElastiCache r5.4xlarge, $1.34/h):
450 台 × $1.34/h × 730h/月 = $440,370/月

存储 (S3, $0.023/GB/月):
90 PB = 90,000,000 GB
90,000,000 × $0.023 = $2,070,000/月

带宽 (CloudFront, 平均 $0.05/GB):
假设月流量 6,750 TB (225 Gbps × 30 天)
6,750,000 GB × $0.05 = $337,500/月

总成本:
= $260,190 + $19,856 + $440,370 + $2,070,000 + $337,500
= $3,127,916/月
≈ $3.1M/月
≈ $37.5M/年
```

---

## 五、快速估算技巧

### 5.1 幂次法则

**记住关键点**:

```
10^3 = 千 (K)
10^6 = 百万 (M)
10^9 = 十亿 (B/G)
10^12 = 万亿 (T)

1 KB ≈ 1,000 Bytes
1 MB ≈ 1,000 KB
1 GB ≈ 1,000 MB
1 TB ≈ 1,000 GB

(精确值是 1024, 但估算时用 1000 更快)
```

**快速计算**:

```
Q: 100 万用户, 每人 1 KB 数据, 需要多少存储?
A: 1M × 1KB = 1,000,000 KB = 1,000 MB = 1 GB

Q: 1 Gbps 带宽, 1 MB 文件, 每秒能传几个?
A: 1 Gbps = 125 MB/s
   125 MB/s ÷ 1 MB = 125 个

Q: 1 亿条数据, 每条 100 Bytes, 需要多少存储?
A: 100M × 100B = 10,000M Bytes = 10G Bytes = 10 GB
```

### 5.2 二的幂次

```
2^10 = 1,024 ≈ 1,000 (K)
2^20 = 1,048,576 ≈ 1,000,000 (M)
2^30 = 1,073,741,824 ≈ 1,000,000,000 (G)
2^40 ≈ 1T

使用场景:
- 内存大小 (2^10 MB = 1 GB)
- 哈希表容量 (2^16 = 65,536 个桶)
- ID 范围 (2^32 = 42 亿)
```

---

## 六、学习检查清单

完成以下检查，说明你掌握了带宽估算:

- [ ] 记住 1 Gbps = 125 MB/s
- [ ] 能快速估算日流量和带宽
- [ ] 记住 Jeff Dean 的 10 个关键数字
- [ ] 能用幂次法则快速计算
- [ ] 能估算图片/视频服务的带宽需求
- [ ] 能估算存储容量 (含副本)
- [ ] 能粗略估算云服务成本
- [ ] 理解读写比对架构的影响

---

## 参考资料

1. **Numbers Every Programmer Should Know**: https://gist.github.com/jboner/2841832
2. **System Design Primer**: https://github.com/donnemartin/system-design-primer
3. **AWS Pricing Calculator**: https://calculator.aws/
4. **Latency Numbers Visualized**: https://colin-scott.github.io/personal_website/research/interactive_latency.html

**下一步**: 完成容量规划实战 → `资料5-容量规划实战.md`
