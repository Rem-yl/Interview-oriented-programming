# Week 1 模块 3 - 练习题答案参考

> 提示：先独立完成练习，再查看答案！

---

## 练习 1: QPS 计算

### 题目
某电商网站有以下数据:
- DAU: 50 万
- 每个用户平均访问 30 个页面/天
- 高峰时段 (2 小时) 占全天流量的 40%
- 峰值因子: 4 倍

### 详细解答

**问题 1: 平均 QPS 是多少？**

```
总请求数/天 = 500,000 × 30 = 15,000,000 次

平均 QPS = 15,000,000 / 86,400秒 ≈ 173.6 QPS
```

**答案**: **174 QPS**

---

**问题 2: 高峰时段平均 QPS？**

```
高峰时段请求量 = 15,000,000 × 40% = 6,000,000 次

高峰时段时长 = 2 小时 = 7,200 秒

高峰时段平均 QPS = 6,000,000 / 7,200 ≈ 833.3 QPS
```

**答案**: **833 QPS**

---

**问题 3: 瞬时峰值 QPS？**

```
瞬时峰值 QPS = 833 × 4 = 3,332 QPS
```

**答案**: **3,332 QPS**

---

**问题 4: 如果单台 Nginx 处理 5000 QPS，需要几台？**

```
理论需要 = 3,332 / 5,000 = 0.67 台

考虑冗余和故障切换，建议配置 2 台
(一主一备，或双活)
```

**答案**: **2 台 Nginx**

**架构建议**:
```
          Internet
              |
        [LVS/HAProxy]
           /      \
      Nginx-1    Nginx-2
       (5000)    (5000)
          \      /
        [后端服务器池]
```

---

## 练习 2: 延迟分析

### 题目
以下是 100 次 API 请求的响应时间 (ms，已排序):

```
[1, 2, 3, 4, 5, ..., 45, 46, 47, 48, 49, 50,
 51, 52, ..., 95, 96, 97, 98, 99, 100,
 110, 120, 150, 200, 250, 300, 500, 1000]

完整数据 (模拟):
前 70 个: 1-70ms (线性增长)
71-90: 71-90ms
91-95: 95, 100, 110, 120, 150ms
96-99: 200, 250, 300, 500ms
100: 1000ms
```

### 详细解答

**问题 1: 计算 P50、P95、P99**

**P50 (中位数)**:
```
P50 位置 = 100 × 50% = 第 50 个值
P50 = 50ms
```

**P95**:
```
P95 位置 = 100 × 95% = 第 95 个值
P95 = 150ms
```

**P99**:
```
P99 位置 = 100 × 99% = 第 99 个值
P99 = 500ms
```

**答案**:
- **P50 = 50ms**
- **P95 = 150ms**
- **P99 = 500ms**

---

**问题 2: 如果 SLA 要求 P95 < 100ms，是否达标？**

```
实际 P95 = 150ms
要求 P95 < 100ms

150ms > 100ms
```

**答案**: **不达标**，需要优化！

**优化建议**:
1. 分析 90-95 百分位的慢请求原因（缓存未命中？数据库慢查询？）
2. 增加缓存预热，提高命中率
3. 优化数据库查询，添加索引
4. 考虑异步处理非关键路径

---

**问题 3: 如果微服务链路中有 5 个这样的服务，整体 P95 会是多少？**

这是一个**尾延迟放大效应**的问题！

**分析**:
```
单个服务 P95 = 150ms，意味着 5% 的请求 > 150ms

5 个服务都在 P95 以内的概率 = (1 - 0.05)^5
                              = 0.95^5
                              ≈ 0.774 (77.4%)

至少有 1 个服务超过 P95 的概率 = 1 - 0.774 = 0.226 (22.6%)
```

**这意味着**:
- 单个服务的 P95 (150ms) ≈ 整体链路的 **P77**
- 整体链路的 P95 会更高！

**估算整体 P95**:
如果假设各服务延迟独立且相加:
```
最坏情况 (串行调用):
整体 P95 ≈ 150ms × 5 = 750ms

实际情况 (部分并行):
整体 P95 ≈ 300-500ms (取决于并行度)
```

**答案**: 整体 P95 约 **300-500ms**，远超单个服务！

**启示**: 微服务越多，尾延迟影响越大。必须严格控制每个服务的 P99/P95！

---

## 练习 3: Little's Law

### 题目
一个数据库连接池有以下配置:
- 最大连接数: 200
- 平均每个查询耗时: 20ms

### 详细解答

**问题 1: 理论最大 QPS 是多少？**

使用 Little's Law:
```
L = λ × W

已知:
L = 200 (最大并发连接数)
W = 20ms = 0.02s

求 λ (QPS):
λ = L / W = 200 / 0.02 = 10,000 QPS
```

**答案**: **10,000 QPS**

---

**问题 2: 如果实际 QPS 只有 5,000，说明什么？**

```
实际并发连接数 = λ × W
                = 5,000 × 0.02
                = 100 个连接

连接池利用率 = 100 / 200 = 50%
```

**分析**:
1. ✅ **好消息**: 系统有充足冗余（50% 利用率）
2. ⚠️ **可能问题**:
   - 连接池配置过大（浪费资源）
   - 或者业务还在增长阶段（预留空间）

**建议**:
- 监控连接池使用情况
- 如果长期只用 50%，可以缩减到 120-150 个连接
- 保留一定冗余应对突发流量

---

**问题 3: 如果要支持 10,000 QPS，需要调整什么？**

**方案 1: 保持连接池不变，优化查询速度**

```
需要的响应时间 W = L / λ
                  = 200 / 10,000
                  = 0.02s = 20ms

当前已经是 20ms，刚好达到极限！
```

**方案 2: 保持响应时间不变，增加连接数**

```
需要的连接数 L = λ × W
                = 10,000 × 0.02
                = 200 个连接

当前配置已经是 200，刚好达到极限！
```

**结论**: 当前配置理论上可以支持 10,000 QPS，但有以下问题:

⚠️ **风险**:
1. **零冗余**: 利用率 100%，任何抖动都会导致排队
2. **排队延迟**: 根据排队论，利用率 > 90% 时延迟会急剧增加
3. **数据库压力**: 200 个连接可能已接近 MySQL 单机极限

**实际建议**:

**选项 A: 读写分离**
```
- 主库: 100 连接 (处理写操作)
- 从库 1: 100 连接 (处理读操作)
- 从库 2: 100 连接 (处理读操作)

总能力 = 10,000 QPS (写) + 20,000 QPS (读)
```

**选项 B: 分库分表**
```
- 分为 4 个分片
- 每个分片 50 连接
- 总能力 = 4 × 10,000 = 40,000 QPS
```

**选项 C: 增加缓存层**
```
- Redis 缓存热数据
- 缓存命中率 80%
- 数据库 QPS 降低到 2,000
- 只需 40 个连接
```

**答案**: 需要**读写分离** 或 **增加缓存**，单纯增加连接数不可行！

---

## 练习 4: 短视频容量规划

### 题目
为一个短视频 APP 做容量规划:
- DAU: 1000 万
- 每个用户平均上传 2 个视频/天 (平均 50MB)
- 每个用户平均观看 30 个视频/天
- 视频平均码率: 3Mbps (375KB/s)
- 平均观看时长: 60 秒

### 详细解答

**问题 1: 每天新增存储需求？**

```
每天上传视频数 = 10,000,000 × 2 = 20,000,000 个视频

每天新增存储 = 20,000,000 × 50MB
             = 1,000,000,000 MB
             = 1,000,000 GB
             = 976.6 TB
             ≈ 1 PB/天
```

**答案**: **约 1 PB/天**

---

**问题 2: 存储 1 年需要多少 PB？**

```
1 年存储 = 1 PB/天 × 365 天 = 365 PB

考虑 3 副本 (数据安全):
实际存储 = 365 PB × 3 = 1,095 PB ≈ 1.1 EB (Exabyte)
```

**答案**: **365 PB (原始数据)** 或 **1.1 EB (含副本)**

**成本估算** (AWS S3 Standard):
```
$0.023/GB/月

365 PB = 365,000,000 GB
月成本 = 365,000,000 × $0.023 = $8,395,000/月

年成本 = $8,395,000 × 12 ≈ $100M/年 (仅存储!)
```

**优化方案**:
1. 使用 S3 Glacier (归档冷数据): $0.004/GB
2. 对象存储分层: 热数据 (30天) + 温数据 (1年) + 冷数据 (永久)
3. 视频去重 (相同视频不重复存储)
4. 转码优化 (降低码率但保持画质)

---

**问题 3: 峰值带宽需求 (假设 10 万并发观看)？**

```
单个视频流带宽 = 3 Mbps

10 万并发观看带宽 = 100,000 × 3 Mbps
                   = 300,000 Mbps
                   = 300 Gbps
```

**答案**: **300 Gbps**

**架构方案**:

```
         [CDN 边缘节点]
        /      |      \
    节点1    节点2    节点3
   (100G)   (100G)   (100G)
       \      |      /
        [源站 (Origin)]
          (50 Gbps)
```

**成本优化**:
- CDN 承担 95% 流量
- 源站只需 15 Gbps (5% 回源)
- P2P 技术分担 20% 流量 → 降低到 240 Gbps

---

**问题 4: 估算 CDN 月成本 (CloudFront $0.085/GB)？**

**计算每月观看流量**:

```
每天观看视频数 = 10,000,000 × 30 = 300,000,000 次

单次观看流量 = 60秒 × 375KB/s = 22,500 KB ≈ 22 MB

每天流量 = 300,000,000 × 22 MB
         = 6,600,000,000 MB
         = 6,600,000 GB
         ≈ 6.6 TB × 1024 = 6,758 TB

每月流量 = 6,758 TB × 30 = 202,752 TB ≈ 203 PB
```

**CDN 成本** (CloudFront 阶梯定价):

```
前 10TB:        10 × $0.085/GB = $850
10TB - 50TB:    40 × $0.080/GB = $3,200
50TB - 150TB:  100 × $0.060/GB = $6,000
150TB - 500TB: 350 × $0.040/GB = $14,000
500TB+:    202,202 × $0.030/GB = $6,066,060

总计 ≈ $6,090,110/月
```

**答案**: **约 $6M/月 (仅 CDN 流量成本!)**

**年成本**: $6M × 12 = **$72M/年**

---

### 综合成本总结

**短视频 APP 年度成本估算**:

| 类型 | 月成本 | 年成本 |
|------|--------|--------|
| 存储 (S3) | $8.4M | $100M |
| CDN 流量 | $6.1M | $73M |
| 服务器 (估算) | $1M | $12M |
| 数据库/缓存 | $0.5M | $6M |
| **总计** | **$16M** | **$191M** |

**每 DAU 成本**: $191M / 10M DAU = **$19/用户/年**

**变现要求**: 如果要盈利，每个用户每年需贡献 > $19 (广告或会员费)

---

## 关键洞察总结

### 1. QPS 估算的关键

- ✅ **不要忘记峰值因子** (通常 3-5 倍)
- ✅ **留足冗余** (至少 20%)
- ✅ **考虑业务增长** (6 个月后翻倍？)
- ⚠️ **读写比很重要** (通常读 >> 写)

### 2. 延迟分析的关键

- ✅ **P99 比平均值重要**
- ✅ **微服务会放大尾延迟**
- ✅ **SLA 应该基于百分位数**
- ⚠️ **监控要用 Histogram，不要只看 avg**

### 3. Little's Law 的应用

- ✅ **永远不要运行在 100% 利用率**
- ✅ **利用率 > 70% 就要考虑扩容**
- ✅ **优化响应时间比增加连接数更有效**
- ⚠️ **排队延迟在高利用率下指数增长**

### 4. 容量规划的经验

- ✅ **成本主要在存储和带宽**
- ✅ **CDN 是必须的，不是可选的**
- ✅ **3 副本是数据安全的标配**
- ⚠️ **冷热数据分层存储可省 50%+ 成本**

---

## 进阶思考题

### 思考 1: 如果你是抖音的架构师

给定:
- DAU: 6 亿
- 人均观看 100 个视频/天
- 平均时长: 30 秒
- 码率: 3 Mbps

问题:
1. 估算每日 CDN 流量
2. 估算年度 CDN 成本 (假设 $0.03/GB)
3. 提出 3 个降低成本的方案

### 思考 2: 容量规划的"陷阱"

以下哪些会导致容量严重低估？
- [ ] 没考虑峰值因子
- [ ] 没考虑数据副本
- [ ] 没考虑数据增长
- [ ] 没考虑热点数据
- [ ] 没考虑网络开销 (TCP/IP 头部)

### 思考 3: 成本优化的优先级

对于视频网站，优化优先级排序:
- [ ] 降低视频码率 (不影响观感)
- [ ] P2P 分发技术
- [ ] 冷热数据分层存储
- [ ] 视频去重
- [ ] 使用更便宜的云服务商

你会如何排序？理由是什么？

---

**完成这些练习后，你对容量规划应该有深刻理解了！** 🎉

继续保持深度学习，祝你成为优秀的系统架构师！ 🚀
