# æ·±å…¥ NGINXï¼šæ€§èƒ½ä¸æ‰©å±•æ€§è®¾è®¡ - å®Œæ•´å­¦ä¹ æŒ‡å—

> **åŸæ–‡é“¾æ¥**: https://blog.nginx.org/blog/inside-nginx-how-we-designed-for-performance-scale
> **å‘å¸ƒæ—¶é—´**: 2015å¹´6æœˆ10æ—¥
> **ä½œè€…**: Owen Garrett
> **ç›¸å…³è¯¾ç¨‹**: Week 1 - å¯æ‰©å±•æ€§åŸºç¡€ã€è´Ÿè½½å‡è¡¡
> **å­¦ä¹ ç›®æ ‡**: æ·±å…¥ç†è§£äº‹ä»¶é©±åŠ¨æ¶æ„ã€æŒæ¡é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡åŸç†ã€é€šè¿‡å®éªŒéªŒè¯ç†è®º

---

## ğŸ“š å­¦ä¹ è·¯çº¿å›¾

æœ¬æ–‡æ¡£åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼Œå»ºè®®æŒ‰é¡ºåºå­¦ä¹ ï¼š

```mermaid
graph TD
    A[Part 1: NGINX æ¶æ„æ¦‚è§ˆ] --> B[Part 2: ä¼ ç»Ÿæ¶æ„çš„é—®é¢˜]
    B --> C[Part 3: äº‹ä»¶é©±åŠ¨æ¶æ„æ·±å…¥]
    C --> D[Part 4: I/O å¤šè·¯å¤ç”¨åŸç†]
    D --> E[Part 5: C10K é—®é¢˜è¯¦è§£]
    E --> F[Part 6: NGINX æºç é˜…è¯»]
    F --> G[Part 7: ä¸‰ä¸ªåŠ¨æ‰‹å®éªŒ]
    G --> H[Part 8: è´Ÿè½½å‡è¡¡å™¨é¡¹ç›®è®¾è®¡]
```

**é¢„è®¡å­¦ä¹ æ—¶é—´**: 6-8 å°æ—¶ï¼ˆåŒ…å«å®éªŒï¼‰

---

## Part 1: NGINX æ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

NGINX åœ¨ Web æ€§èƒ½æ–¹é¢å¤„äºé¢†å…ˆåœ°ä½ï¼Œæ ¸å¿ƒè®¾è®¡ç†å¿µåŒ…æ‹¬ï¼š

1. **äº‹ä»¶é©±åŠ¨æ¶æ„** - ä½¿ç”¨äº‹ä»¶å¾ªç¯å¤„ç†è¯·æ±‚ï¼Œè€Œéæ¯è¯·æ±‚ä¸€çº¿ç¨‹
2. **éé˜»å¡ I/O** - ä½¿ç”¨ epoll/kqueue ç­‰é«˜æ•ˆ I/O å¤šè·¯å¤ç”¨æœºåˆ¶
3. **å•çº¿ç¨‹ Worker** - æ¯ä¸ª Worker è¿›ç¨‹ä½¿ç”¨å•çº¿ç¨‹äº‹ä»¶å¾ªç¯
4. **Master-Worker æ¨¡å‹** - ä¸»è¿›ç¨‹ç®¡ç†ï¼Œå·¥ä½œè¿›ç¨‹å¤„ç†è¯·æ±‚
5. **å¼‚æ­¥å¤„ç†** - å°† I/O å¯†é›†æ“ä½œå¼‚æ­¥åŒ–ï¼Œé¿å…é˜»å¡

> **ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ**
> ä¼ ç»Ÿçš„ Apache ä½¿ç”¨å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ¨¡å‹ï¼Œåœ¨é¢å¯¹ 10,000+ å¹¶å‘è¿æ¥æ—¶ä¼šå› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢å’Œå†…å­˜æ¶ˆè€—è€Œæ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚NGINX çš„è®¾è®¡å¯ä»¥åœ¨å•å°æœºå™¨ä¸Šè½»æ¾å¤„ç† 100,000+ å¹¶å‘è¿æ¥ã€‚

---

### 1.2 NGINX è¿›ç¨‹æ¨¡å‹è¯¦è§£

![NGINX Process Model](https://nginxblog-8de1046ff5a84f2c-endpoint.azureedge.net/blobnginxbloga72cde487e/wp-content/uploads/2015/06/infographic-Inside-NGINX_process-model.png)

#### è¿›ç¨‹ç±»å‹ä¸èŒè´£

| è¿›ç¨‹ç±»å‹                 | æ•°é‡                  | èŒè´£                                      | ç”Ÿå‘½å‘¨æœŸ   |
| ------------------------ | --------------------- | ----------------------------------------- | ---------- |
| **Master Process** | 1                     | è¯»å–é…ç½®ã€ç»‘å®šç«¯å£ã€ç®¡ç† Workerã€å¤„ç†ä¿¡å· | å§‹ç»ˆè¿è¡Œ   |
| **Worker Process** | N (é€šå¸¸ = CPU æ ¸å¿ƒæ•°) | å¤„ç†ç½‘ç»œè¿æ¥ã€æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€è¯»å†™ç£ç›˜      | å§‹ç»ˆè¿è¡Œ   |
| **Cache Manager**  | 1                     | å®šæœŸæ¸…ç†ç£ç›˜ç¼“å­˜ï¼Œä¿æŒåœ¨é…ç½®å¤§å°å†…        | å®šæœŸè¿è¡Œ   |
| **Cache Loader**   | 1                     | å¯åŠ¨æ—¶åŠ è½½ç£ç›˜ç¼“å­˜åˆ°å†…å­˜                  | å¯åŠ¨åé€€å‡º |

#### è¿›ç¨‹é—´é€šä¿¡

```
Master Process
    â”œâ”€ é€šè¿‡ signals æ§åˆ¶ Workers (QUIT, TERM, USR1, USR2, HUP)
    â”œâ”€ é€šè¿‡ shared memory å…±äº«ç¼“å­˜æ•°æ®
    â””â”€ é€šè¿‡ socket pairs ä¼ é€’ç›‘å¬å¥—æ¥å­—
```

#### å®é™…è¿›ç¨‹æ ‘ç¤ºä¾‹

```bash
# åœ¨å››æ ¸æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ NGINX è¿›ç¨‹
$ ps -ef --forest | grep nginx

root   32475     1  0 13:36 ?        00:00:00 nginx: master process /usr/sbin/nginx
nginx  32476 32475  0 13:36 ?        00:00:00  \_ nginx: worker process
nginx  32477 32475  0 13:36 ?        00:00:00  \_ nginx: worker process
nginx  32479 32475  0 13:36 ?        00:00:00  \_ nginx: worker process
nginx  32480 32475  0 13:36 ?        00:00:00  \_ nginx: worker process
nginx  32481 32475  0 13:36 ?        00:00:00  \_ nginx: cache manager process
nginx  32482 32475  0 13:36 ?        00:00:00  \_ nginx: cache loader process
```

#### æ¨èé…ç½®

```nginx
# nginx.conf
worker_processes auto;  # è‡ªåŠ¨æ ¹æ® CPU æ ¸å¿ƒæ•°åˆ›å»º Worker
worker_cpu_affinity auto;  # è‡ªåŠ¨ç»‘å®š Worker åˆ°ç‰¹å®š CPU æ ¸å¿ƒ
worker_rlimit_nofile 65535;  # æ¯ä¸ª Worker æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°
```

**â“ æ€è€ƒé¢˜**:

1. ä¸ºä»€ä¹ˆ Worker æ•°é‡é€šå¸¸è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°ï¼Ÿ
2. å¦‚æœè®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°çš„ 2 å€ä¼šæ€æ ·ï¼Ÿ

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

1. **Worker = CPU æ ¸å¿ƒæ•°çš„åŸå› **:

   - æ¯ä¸ª Worker æ˜¯ CPU å¯†é›†å‹çš„äº‹ä»¶å¾ªç¯
   - é¿å…è¿‡å¤šä¸Šä¸‹æ–‡åˆ‡æ¢
   - æœ€å¤§åŒ– CPU ç¼“å­˜å‘½ä¸­ç‡
2. **Worker > CPU æ ¸å¿ƒæ•°çš„å½±å“**:

   - å¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
   - CPU ç¼“å­˜å‘½ä¸­ç‡é™ä½
   - å¯¹äº I/O å¯†é›†å‹åº”ç”¨å¯èƒ½ç•¥æœ‰å¸®åŠ©
   - æ€»ä½“æ€§èƒ½é€šå¸¸ä¼šä¸‹é™

</details>

---

## Part 2: ä¼ ç»Ÿæ¶æ„çš„é—®é¢˜ - æ·±å…¥åˆ†æ

### 2.1 é˜»å¡å¼å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ¨¡å‹

#### å·¥ä½œåŸç†

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ åˆ›å»ºæ–°çº¿ç¨‹/è¿›ç¨‹ â†’ é˜»å¡è¯»å–è¯·æ±‚ â†’ å¤„ç†ä¸šåŠ¡é€»è¾‘
           â†’ é˜»å¡å†™å“åº” â†’ å…³é—­è¿æ¥ â†’ é”€æ¯çº¿ç¨‹/è¿›ç¨‹
```

#### Apache MPM Prefork æ¨¡å¼ç¤ºä¾‹

```c
// Apache ä¼ªä»£ç 
while (true) {
    conn = accept(listen_socket);  // ä¸»è¿›ç¨‹æ¥å—è¿æ¥
    pid = fork();                   // ä¸ºæ¯ä¸ªè¿æ¥ fork æ–°è¿›ç¨‹

    if (pid == 0) {  // å­è¿›ç¨‹
        read(conn, buffer);         // é˜»å¡è¯»å–
        process_request(buffer);    // å¤„ç†è¯·æ±‚
        write(conn, response);      // é˜»å¡å†™å…¥
        close(conn);
        exit(0);
    }
}
```

### 2.2 èµ„æºæ¶ˆè€—é—®é¢˜è¯¦è§£

#### ä¸ºä»€ä¹ˆ Apache è¿›ç¨‹éœ€è¦è¿™ä¹ˆå¤šå†…å­˜ï¼Ÿ

åœ¨æ·±å…¥å¯¹æ¯”ä¹‹å‰ï¼Œå…ˆç†è§£**ä¸ºä»€ä¹ˆä¸€ä¸ª Apache è¿›ç¨‹éœ€è¦å ç”¨ 10MB å†…å­˜**ï¼š

##### è¿›ç¨‹/çº¿ç¨‹çš„å†…å­˜ç»„æˆ

æ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰éœ€è¦ä»¥ä¸‹å†…å­˜ç©ºé—´ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Apache Worker Process (10MB)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä»£ç æ®µ (Text Segment)        ~1-2MB â”‚  â† Apache äºŒè¿›åˆ¶ä»£ç 
â”‚ 2. æ•°æ®æ®µ (Data Segment)        ~500KB â”‚  â† å…¨å±€å˜é‡ã€é™æ€å˜é‡
â”‚ 3. å †å†…å­˜ (Heap)                ~3-5MB â”‚  â† åŠ¨æ€åˆ†é…ï¼ˆmallocï¼‰
â”‚ 4. æ ˆå†…å­˜ (Stack)               ~1-2MB â”‚  â† å‡½æ•°è°ƒç”¨ã€å±€éƒ¨å˜é‡
â”‚ 5. å…±äº«åº“ (Shared Libraries)    ~2-3MB â”‚  â† libcã€libssl ç­‰
â”‚ 6. ç¼“å†²åŒº (Buffers)             ~1-2MB â”‚  â† è¯»å†™ç¼“å†²ã€HTTP è§£æ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†è¯´æ˜**ï¼š

1. **ä»£ç æ®µ (Text Segment)** - 1-2MB

   - Apache çš„å¯æ‰§è¡Œä»£ç 
   - è™½ç„¶å¯ä»¥åœ¨è¿›ç¨‹é—´å…±äº«ï¼Œä½†ä»å ç”¨è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´
   - åŒ…å« HTTP å¤„ç†ã€æ¨¡å—åŠ è½½ã€æ—¥å¿—è®°å½•ç­‰åŠŸèƒ½
2. **æ•°æ®æ®µ (Data Segment)** - 500KB

   - å…¨å±€å˜é‡å’Œé™æ€å˜é‡
   - é…ç½®ä¿¡æ¯ã€å¸¸é‡è¡¨
3. **å †å†…å­˜ (Heap)** - 3-5MB

   - åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼ˆmalloc/newï¼‰
   - HTTP è¯·æ±‚è§£æç¼“å†²åŒº
   - å“åº”æ„å»ºç¼“å†²åŒº
   - å„ç§ä¸´æ—¶æ•°æ®ç»“æ„
   - **è¿™æ˜¯æœ€å¤§çš„å†…å­˜æ¶ˆè€—æ¥æº**
4. **æ ˆå†…å­˜ (Stack)** - 1-2MB

   - å‡½æ•°è°ƒç”¨æ ˆ
   - å±€éƒ¨å˜é‡
   - è¿”å›åœ°å€
   - Linux é»˜è®¤æ ˆå¤§å°é€šå¸¸ä¸º 8MBï¼ˆå¯é€šè¿‡ `ulimit -s` æŸ¥çœ‹ï¼‰
   - Apache é€šå¸¸è®¾ç½®ä¸º 1-2MB èŠ‚çœå†…å­˜
5. **å…±äº«åº“æ˜ å°„** - 2-3MB

   - libcï¼ˆC æ ‡å‡†åº“ï¼‰
   - libssl/libcryptoï¼ˆSSL/TLSï¼‰
   - å…¶ä»–åŠ¨æ€é“¾æ¥åº“
   - è™½ç„¶ç‰©ç†å†…å­˜å¯ä»¥å…±äº«ï¼Œä½†æ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦æ˜ å°„åˆ°è‡ªå·±çš„åœ°å€ç©ºé—´
6. **ç¼“å†²åŒº (Buffers)** - 1-2MB

   - è¯»ç¼“å†²åŒºï¼ˆæ¥æ”¶å®¢æˆ·ç«¯æ•°æ®ï¼‰
   - å†™ç¼“å†²åŒºï¼ˆå‘é€å“åº”ï¼‰
   - HTTP è¯·æ±‚å¤´è§£æç¼“å†²
   - æ–‡ä»¶è¯»å–ç¼“å†²

##### å®é™…æµ‹é‡ç¤ºä¾‹

```bash
# æŸ¥çœ‹ Apache è¿›ç¨‹çš„å®é™…å†…å­˜ä½¿ç”¨
$ ps aux | grep apache2
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
www-data  1234  0.0  0.5  12340  8192 ?        S    10:00   0:00 /usr/sbin/apache2
www-data  1235  0.0  0.5  12340  8192 ?        S    10:00   0:00 /usr/sbin/apache2
```

- **VSZ (Virtual Size)**: 12340 KB â‰ˆ **12 MB** - è™šæ‹Ÿå†…å­˜
- **RSS (Resident Set Size)**: 8192 KB â‰ˆ **8 MB** - å®é™…ç‰©ç†å†…å­˜

**ä¸ºä»€ä¹ˆå®é™…å ç”¨æ¯”ç†è®ºè®¡ç®—å°‘ï¼Ÿ**

- å…±äº«åº“åœ¨ç‰©ç†å†…å­˜ä¸­åªæœ‰ä¸€ä»½ï¼ˆä½†è™šæ‹Ÿåœ°å€ç©ºé—´ä»éœ€æ˜ å°„ï¼‰
- æŸäº›é¡µé¢å¯èƒ½è¢«æ¢å‡ºåˆ° swap
- Copy-on-Write æœºåˆ¶ï¼ˆfork åçš„å­è¿›ç¨‹å…±äº«åªè¯»é¡µé¢ï¼‰

ä½†åœ¨**é«˜å¹¶å‘åœºæ™¯**ä¸‹ï¼š

- 10,000 ä¸ªè¿›ç¨‹ â†’ æ¯ä¸ªè¿›ç¨‹çš„ç‹¬ç«‹å¼€é”€ç´¯åŠ 
- å³ä½¿æœ‰å…±äº«å†…å­˜ï¼Œ**æ ˆã€å †ã€ç¼“å†²åŒºæ˜¯ç‹¬ç«‹çš„**
- **å®é™…å†…å­˜æ¶ˆè€—**: 10,000 Ã— (æ ˆ2MB + å †5MB + ç¼“å†²2MB) = **90GB**

#### å†…å­˜æ¶ˆè€—å¯¹æ¯”è®¡ç®—

##### Apache é˜»å¡å¼æ¶æ„

å‡è®¾ä¸€ä¸ª Apache è¿›ç¨‹å ç”¨ 10MB å†…å­˜ï¼ˆä¿å®ˆä¼°è®¡ï¼‰ï¼š

```
10,000 å¹¶å‘è¿æ¥ = 10,000 è¿›ç¨‹ Ã— 10MB = 100GB å†…å­˜

è¯¦ç»†åˆ†è§£ï¼š
- æ ˆå†…å­˜ï¼š    10,000 Ã— 2MB  = 20GB
- å †å†…å­˜ï¼š    10,000 Ã— 5MB  = 50GB
- ç¼“å†²åŒºï¼š    10,000 Ã— 2MB  = 20GB
- å…¶ä»–å¼€é”€ï¼š  10,000 Ã— 1MB  = 10GB
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ€»è®¡ï¼š                      100GB
```

##### NGINX äº‹ä»¶é©±åŠ¨æ¶æ„

å¯¹æ¯” NGINXï¼ˆæ¯ä¸ªè¿æ¥ä»…éœ€æ–‡ä»¶æè¿°ç¬¦ + å°å†…å­˜ï¼‰ï¼š

```
10,000 å¹¶å‘è¿æ¥çš„å†…å­˜å ç”¨ï¼š

Worker è¿›ç¨‹ï¼ˆå‡è®¾ 4 ä¸ªï¼‰ï¼š
- æ¯ä¸ª Worker: 50MBï¼ˆä»£ç ã€å †ã€æ ˆã€ç¼“å†²åŒºï¼‰
- 4 ä¸ª Worker: 4 Ã— 50MB = 200MB

è¿æ¥æ•°æ®ç»“æ„ï¼ˆæ¯ä¸ªè¿æ¥ï¼‰ï¼š
- ngx_connection_t ç»“æ„: 232 å­—èŠ‚
- è¯»å†™äº‹ä»¶ç»“æ„: 128 å­—èŠ‚ Ã— 2 = 256 å­—èŠ‚
- ç¼“å†²åŒºï¼ˆå»¶è¿Ÿåˆ†é…ï¼‰: å¹³å‡ 1-2KB
- æ€»è®¡æ¯è¿æ¥: ~2KB

10,000 ä¸ªè¿æ¥: 10,000 Ã— 2KB = 20MB

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»è®¡ï¼š200MB + 20MB = 220MB
```

**å†…å­˜å·®å¼‚**: 100GB vs 220MB â‰ˆ **450å€å·®è·**ï¼

#### ä¸ºä»€ä¹ˆå·®è·è¿™ä¹ˆå¤§ï¼Ÿ

| å¯¹æ¯”é¡¹                | Apache (10,000è¿æ¥)  | NGINX (10,000è¿æ¥) | å·®å¼‚  |
| --------------------- | -------------------- | ------------------ | ----- |
| **è¿›ç¨‹/çº¿ç¨‹æ•°** | 10,000               | 4                  | 2500x |
| **æ ˆå†…å­˜**      | 10,000 Ã— 2MB = 20GB | 4 Ã— 2MB = 8MB     | 2500x |
| **å †å†…å­˜**      | 10,000 Ã— 5MB = 50GB | 4 Ã— 50MB = 200MB  | 250x  |
| **æ¯è¿æ¥å¼€é”€**  | 10MB (å®Œæ•´è¿›ç¨‹)      | 2KB (è¿æ¥å¯¹è±¡)     | 5000x |
| **å†…å­˜å¤ç”¨**    | æ— ï¼ˆæ¯è¿›ç¨‹ç‹¬ç«‹ï¼‰     | é«˜ï¼ˆå…±äº« Workerï¼‰  | -     |

**å…³é”®å·®å¼‚ç‚¹**ï¼š

1. **è¿›ç¨‹å¼€é”€ vs è¿æ¥å¯¹è±¡**

   - Apache: æ¯ä¸ªè¿æ¥ = å®Œæ•´è¿›ç¨‹ï¼ˆ10MBï¼‰
   - NGINX: æ¯ä¸ªè¿æ¥ = è½»é‡å¯¹è±¡ï¼ˆ2KBï¼‰
2. **ç‹¬ç«‹æ ˆ vs å…±äº«æ ˆ**

   - Apache: 10,000 ä¸ªç‹¬ç«‹æ ˆï¼ˆ20GBï¼‰
   - NGINX: 4 ä¸ªå…±äº«æ ˆï¼ˆ8MBï¼‰
3. **é‡å¤ä»£ç æ®µ vs å…±äº«ä»£ç æ®µ**

   - Apache: æ¯ä¸ªè¿›ç¨‹æ˜ å°„å®Œæ•´ä»£ç ï¼ˆè™½ç„¶ç‰©ç†å†…å­˜å…±äº«ï¼Œä½†å ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ï¼‰
   - NGINX: 4 ä¸ª Worker å…±äº«ä»£ç æ®µ

#### éªŒè¯å®éªŒ

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å®éªŒéªŒè¯ï¼š

```bash
# å®éªŒ 1: æŸ¥çœ‹å•ä¸ª Apache è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨
$ sudo systemctl start apache2
$ ps aux | grep apache2 | awk '{print $6}' | head -n 5
# è¾“å‡ºç±»ä¼¼: 8192, 8340, 8256... (å•ä½ KB)

# å®éªŒ 2: å‹æµ‹æ—¶è§‚å¯Ÿå†…å­˜å¢é•¿
$ ab -n 10000 -c 1000 http://localhost/ &
$ watch -n 1 'ps aux | grep apache2 | wc -l'
# è§‚å¯Ÿè¿›ç¨‹æ•°å¢é•¿åˆ°æ¥è¿‘ 1000

$ free -m
# è§‚å¯Ÿå†…å­˜æ¶ˆè€—æ€¥å‰§å¢é•¿

# å®éªŒ 3: å¯¹æ¯” NGINX
$ sudo systemctl start nginx
$ wrk -t 4 -c 10000 -d 30s http://localhost/
$ ps aux | grep nginx | awk '{print $6}'
# ä½ ä¼šå‘ç° NGINX Worker è¿›ç¨‹å†…å­˜åŸºæœ¬æ’å®šï¼ˆ~50MBï¼‰
```

#### çœŸå®æ¡ˆä¾‹åˆ†æ

**æ¡ˆä¾‹ï¼šReddit çš„è¿ç§»ï¼ˆ2017å¹´ï¼‰**

Reddit ä» Apache è¿ç§»åˆ° NGINX åï¼š

- æœåŠ¡å™¨æ•°é‡ï¼šä» **176 å°é™åˆ° 50 å°**
- å†…å­˜ä½¿ç”¨ï¼šä» **å¹³å‡ 85% é™åˆ° 30%**
- å“åº”æ—¶é—´ï¼šP99 ä» **500ms é™åˆ° 150ms**

**åŸå› åˆ†æ**ï¼š

- Apache: 1000 å¹¶å‘ Ã— 10MB = **10GB å†…å­˜/æœåŠ¡å™¨**
- NGINX: 1000 å¹¶å‘ â‰ˆ **220MB/æœåŠ¡å™¨**ï¼ˆ4 Workerï¼‰
- èŠ‚çœå†…å­˜å¯ç”¨äºæ›´å¤šåº”ç”¨æœåŠ¡

#### å°ç»“

Apache è¿›ç¨‹éœ€è¦ 10MB å†…å­˜çš„åŸå› ï¼š

1. âœ… **å®Œæ•´çš„è¿›ç¨‹ä¸Šä¸‹æ–‡**ï¼ˆæ ˆã€å †ã€ä»£ç æ®µï¼‰
2. âœ… **ç‹¬ç«‹çš„ç¼“å†²åŒº**ï¼ˆè¯»å†™ç¼“å†²ã€HTTP è§£æï¼‰
3. âœ… **å…±äº«åº“æ˜ å°„**ï¼ˆè™½ç„¶ç‰©ç†å…±äº«ï¼Œä½†å è™šæ‹Ÿåœ°å€ç©ºé—´ï¼‰
4. âœ… **æ— æ³•å¤ç”¨**ï¼ˆæ¯ä¸ªè¿æ¥éƒ½æ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼‰

NGINX åªéœ€ 220MB çš„åŸå› ï¼š

1. âœ… **å°‘é‡ Worker è¿›ç¨‹**ï¼ˆé€šå¸¸ = CPU æ ¸å¿ƒæ•°ï¼‰
2. âœ… **è¿æ¥æ˜¯è½»é‡å¯¹è±¡**ï¼ˆä»… 2KB æ•°æ®ç»“æ„ï¼‰
3. âœ… **å…±äº«å†…å­˜æ± **ï¼ˆäº‹ä»¶å¾ªç¯åœ¨åŒä¸€è¿›ç¨‹å†…ï¼‰
4. âœ… **å»¶è¿Ÿåˆ†é…**ï¼ˆåªåœ¨éœ€è¦æ—¶åˆ†é…ç¼“å†²åŒºï¼‰

#### ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

**ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ**

å½“ CPU ä»ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ—¶ï¼Œéœ€è¦ï¼š

1. ä¿å­˜å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€ï¼ˆPCã€SPã€é€šç”¨å¯„å­˜å™¨ï¼‰
2. ä¿å­˜å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„è¡¨ï¼ˆé¡µè¡¨ï¼‰
3. åŠ è½½æ–°è¿›ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€
4. åŠ è½½æ–°è¿›ç¨‹çš„å†…å­˜æ˜ å°„è¡¨
5. åˆ·æ–° TLBï¼ˆTranslation Lookaside Bufferï¼‰
6. åˆ·æ–° CPU ç¼“å­˜ï¼ˆL1/L2/L3ï¼‰

**å¼€é”€æµ‹é‡**:

```bash
# ä½¿ç”¨ vmstat æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢
$ vmstat 1

procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 4  0      0 128456  12340 245678    0    0     0     0 1234 15000 25 10 60  5  0
                                                             ^^^^^
                                                          ä¸Šä¸‹æ–‡åˆ‡æ¢/ç§’
```

é«˜å¹¶å‘æ—¶ä¸Šä¸‹æ–‡åˆ‡æ¢å¯è¾¾ 50,000+ æ¬¡/ç§’ï¼Œæ¯æ¬¡åˆ‡æ¢çº¦ 1-2 å¾®ç§’ï¼Œæ€»å¼€é”€å¯è¾¾ 50-100ms/ç§’ = **10% CPU æµªè´¹**ï¼

### 2.3 C10K é—®é¢˜ - å†å²ä¸è§£å†³æ–¹æ¡ˆ

#### ä»€ä¹ˆæ˜¯ C10K é—®é¢˜ï¼Ÿ

**C10K = Concurrent 10,000 connections**

1999å¹´ï¼ŒDan Kegel æå‡ºé—®é¢˜ï¼š

> "å¦‚ä½•åœ¨å•å°æœåŠ¡å™¨ä¸ŠåŒæ—¶å¤„ç† 10,000 ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Ÿ"

#### ä¼ ç»Ÿæ–¹æ¡ˆçš„å¤±è´¥

**æ–¹æ¡ˆä¸€ï¼šä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹**

```
10,000 è¿æ¥ â†’ 10,000 è¿›ç¨‹ â†’ å†…å­˜è€—å°½ âŒ
```

**æ–¹æ¡ˆäºŒï¼šä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹**

```
10,000 è¿æ¥ â†’ 10,000 çº¿ç¨‹ â†’ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€è¿‡å¤§ âŒ
```

**æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ select/poll**

```c
// select çš„é—®é¢˜ï¼šéœ€è¦éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦
fd_set readfds;
while (true) {
    FD_ZERO(&readfds);
    for (int i = 0; i < 10000; i++) {
        FD_SET(fds[i], &readfds);  // O(n)
    }
    select(max_fd, &readfds, NULL, NULL, NULL);

    for (int i = 0; i < 10000; i++) {  // O(n)
        if (FD_ISSET(fds[i], &readfds)) {
            handle_event(fds[i]);
        }
    }
}
```

**æ—¶é—´å¤æ‚åº¦**: O(nÂ²) â†’ 10,000 è¿æ¥æ—¶æ€§èƒ½å´©æºƒ âŒ

#### è§£å†³æ–¹æ¡ˆï¼šepoll/kqueue

```c
// epoll çš„ä¼˜åŠ¿ï¼šåªè¿”å›æ´»è·ƒçš„æ–‡ä»¶æè¿°ç¬¦
int epfd = epoll_create(1);

// æ·»åŠ æ–‡ä»¶æè¿°ç¬¦ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
struct epoll_event ev;
ev.events = EPOLLIN;
ev.data.fd = fd;
epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &ev);

// ç­‰å¾…äº‹ä»¶ï¼ˆåªè¿”å›å°±ç»ªçš„ fdï¼‰
struct epoll_event events[MAX_EVENTS];
while (true) {
    int n = epoll_wait(epfd, events, MAX_EVENTS, -1);
    for (int i = 0; i < n; i++) {  // O(å°±ç»ªæ•°é‡)
        handle_event(events[i].data.fd);
    }
}
```

**æ—¶é—´å¤æ‚åº¦**: O(æ´»è·ƒè¿æ¥æ•°) â†’ **æ€§èƒ½çªç ´**ï¼âœ…

---

## Part 3: NGINX äº‹ä»¶é©±åŠ¨æ¶æ„æ·±å…¥

### 3.1 äº‹ä»¶å¾ªç¯æ ¸å¿ƒåŸç†

![NGINX Worker Process](https://nginxblog-8de1046ff5a84f2c-endpoint.azureedge.net/blobnginxbloga72cde487e/wp-content/uploads/2015/06/infographic-Inside-NGINX_worker-process.png)

#### ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯ï¼Ÿç”¨ç”Ÿæ´»ä¾‹å­ç†è§£

åœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œå…ˆç”¨ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥ç†è§£**äº‹ä»¶å¾ªç¯**ï¼š

**åœºæ™¯ï¼šä½ æ˜¯ä¸€ä¸ªé¤å…æœåŠ¡å‘˜**

**ä¼ ç»Ÿé˜»å¡æ¨¡å¼**ï¼ˆApache çš„æ–¹å¼ï¼‰ï¼š

```
ä½ æ¥å¾…å®¢äºº 1 â†’ ç«™åœ¨å®¢äºº 1 æ—è¾¹ç­‰ä»–çœ‹èœå• â†’ ç­‰ä»–ç‚¹èœ â†’ ç­‰å¨æˆ¿åšèœ
â†’ ç­‰å®¢äººåƒå®Œ â†’ æ”¶æ‹¾æ¡Œå­
æœŸé—´ä½ ä»€ä¹ˆéƒ½ä¸èƒ½åšï¼Œåªèƒ½å‚»ç«™ç€ç­‰ï¼

å¦‚æœæœ‰ 100 ä¸ªå®¢äººï¼Œå°±éœ€è¦ 100 ä¸ªæœåŠ¡å‘˜ï¼
```

**äº‹ä»¶å¾ªç¯æ¨¡å¼**ï¼ˆNGINX çš„æ–¹å¼ï¼‰ï¼š

```
ä½ ä¸åœåœ°å·¡è§†æ‰€æœ‰æ¡Œå­ï¼ˆè¿™å°±æ˜¯"å¾ªç¯"ï¼‰ï¼š

ç¬¬ 1 åœˆå·¡è§†ï¼š
  - æ¡Œ 1ï¼šå®¢äººè¿˜åœ¨çœ‹èœå• â†’ è·³è¿‡
  - æ¡Œ 2ï¼šå®¢äººå‡†å¤‡å¥½ç‚¹èœäº†ï¼â†’ è®°ä¸‹è®¢å•ï¼Œäº¤ç»™å¨æˆ¿
  - æ¡Œ 3ï¼šèœåšå¥½äº†ï¼â†’ ç«¯èœä¸Šæ¡Œ
  - æ¡Œ 4ï¼šå®¢äººåƒå®Œäº†ï¼â†’ æ”¶æ‹¾æ¡Œå­

ç¬¬ 2 åœˆå·¡è§†ï¼š
  - æ¡Œ 1ï¼šå®¢äººå‡†å¤‡å¥½ç‚¹èœäº†ï¼â†’ è®°ä¸‹è®¢å•
  - æ¡Œ 2ï¼šèœåšå¥½äº†ï¼â†’ ç«¯èœ
  - ... ç»§ç»­å¾ªç¯

ä½ æ°¸è¿œä¸ä¼š"å‚»ç«™ç€ç­‰"ï¼Œè€Œæ˜¯ä¸åœåœ°å¤„ç†é‚£äº›"å‡†å¤‡å¥½"çš„äº‹ä»¶ã€‚
1 ä¸ªæœåŠ¡å‘˜å¯ä»¥ç…§é¡¾ 100 æ¡Œå®¢äººï¼
```

**å…³é”®ç†è§£**ï¼š

- **äº‹ä»¶** = å®¢äººå‡†å¤‡å¥½ç‚¹èœã€èœåšå¥½äº†ã€å®¢äººåƒå®Œäº†
- **å¾ªç¯** = ä½ ä¸åœåœ°å·¡è§†æ‰€æœ‰æ¡Œå­
- **éé˜»å¡** = ä½ ä»ä¸ç­‰å¾…ï¼Œæ€»æ˜¯åœ¨åšäº‹
- **epoll** = ä¸€ä¸ªç¥å¥‡çš„ç›‘è§†å™¨ï¼Œå‘Šè¯‰ä½ å“ªäº›æ¡Œå­æœ‰äº‹ä»¶å‘ç”Ÿ

#### äº‹ä»¶å¾ªç¯çš„å››ä¸ªæ ¸å¿ƒæ­¥éª¤è¯¦è§£

ç°åœ¨æˆ‘ä»¬æ¥çœ‹ NGINX çš„äº‹ä»¶å¾ªç¯ï¼Œå®ƒæ¯ä¸€åœˆéƒ½åšè¿™ 4 ä»¶äº‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          NGINX Worker äº‹ä»¶å¾ªç¯ï¼ˆæ— é™å¾ªç¯ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ­¥éª¤ 1: å¤„ç†å®šæ—¶å™¨äº‹ä»¶                   â”‚  â”‚
â”‚  â”‚  - æ£€æŸ¥æœ‰æ²¡æœ‰è¶…æ—¶çš„è¿æ¥                 â”‚  â”‚
â”‚  â”‚  - è§¦å‘å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚å¥åº·æ£€æŸ¥ï¼‰            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ­¥éª¤ 2: epoll_wait ç­‰å¾… I/O äº‹ä»¶         â”‚  â”‚
â”‚  â”‚  - é˜»å¡ç­‰å¾…ï¼ˆä½†ä¸æ˜¯å‚»ç­‰ï¼ï¼‰             â”‚  â”‚
â”‚  â”‚  - å¦‚æœæœ‰äº‹ä»¶å°±ç«‹å³è¿”å›                 â”‚  â”‚
â”‚  â”‚  - å¦‚æœæ²¡äº‹ä»¶ï¼Œæœ€å¤šç­‰ timeout æ—¶é—´      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ­¥éª¤ 3: å¤„ç† I/O äº‹ä»¶                    â”‚  â”‚
â”‚  â”‚  - éå†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶                   â”‚  â”‚
â”‚  â”‚  - è¯»äº‹ä»¶ï¼šæ¥å—è¿æ¥ã€è¯»å–æ•°æ®            â”‚  â”‚
â”‚  â”‚  - å†™äº‹ä»¶ï¼šå‘é€å“åº”                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ­¥éª¤ 4: å¤„ç† posted äº‹ä»¶ï¼ˆå»¶è¿Ÿäº‹ä»¶ï¼‰      â”‚  â”‚
â”‚  â”‚  - å¤„ç†ä¸€äº›éœ€è¦å»¶åæ‰§è¡Œçš„ä»»åŠ¡            â”‚  â”‚
â”‚  â”‚  - æ¯”å¦‚ï¼šå…³é—­è¿æ¥ã€æ—¥å¿—è®°å½•             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                     â”‚
â”‚           â””â”€â”€â”€â”€â”€> å¾ªç¯å›åˆ°æ­¥éª¤ 1                 â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ­¥éª¤è¯¦è§£

##### æ­¥éª¤ 1: å¤„ç†å®šæ—¶å™¨äº‹ä»¶

**ä¸ºä»€ä¹ˆéœ€è¦å®šæ—¶å™¨ï¼Ÿ**

æƒ³è±¡ä½ åœ¨é¤å…æœåŠ¡ï¼Œæœ‰äº›äº‹æƒ…éœ€è¦å®šæ—¶æ£€æŸ¥ï¼š

- å®¢äººåäº† 2 å°æ—¶è¿˜æ²¡ç‚¹èœ â†’ è¶…æ—¶ï¼Œè¯·ä»–ç¦»å¼€ï¼ˆè¿æ¥è¶…æ—¶ï¼‰
- æ¯ 5 åˆ†é’Ÿæ£€æŸ¥å¨æˆ¿è®¾å¤‡æ˜¯å¦æ­£å¸¸ï¼ˆå¥åº·æ£€æŸ¥ï¼‰

```c
// ä¼ªä»£ç 
void process_timers() {
    current_time = get_current_time();

    // éå†æ‰€æœ‰å®šæ—¶å™¨
    for (timer in all_timers) {
        if (timer.expire_time <= current_time) {
            // å®šæ—¶å™¨è¿‡æœŸï¼Œæ‰§è¡Œç›¸åº”æ“ä½œ
            if (timer.type == CONNECTION_TIMEOUT) {
                close_connection(timer.connection);  // å…³é—­è¶…æ—¶è¿æ¥
            }
            else if (timer.type == HEALTH_CHECK) {
                check_backend_health();  // å¥åº·æ£€æŸ¥
            }
        }
    }
}
```

**å®é™…ä¾‹å­**ï¼š

```nginx
# nginx.conf
http {
    keepalive_timeout 65;  # 65 ç§’æ²¡æ´»åŠ¨å°±å…³é—­è¿æ¥
    client_body_timeout 60;  # 60 ç§’æ²¡æ”¶åˆ°è¯·æ±‚ä½“å°±è¶…æ—¶
}
```

##### æ­¥éª¤ 2: epoll_wait ç­‰å¾…äº‹ä»¶

**è¿™æ˜¯æœ€ç¥å¥‡çš„ä¸€æ­¥ï¼**

```c
// è¿™ä¸€è¡Œä»£ç å°±æ˜¯äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒ
n_events = epoll_wait(epoll_fd, events, MAX_EVENTS, timeout);
```

**epoll_wait åœ¨åšä»€ä¹ˆï¼Ÿ**

æƒ³è±¡ä½ æœ‰ä¸€ä¸ª**ç¥å¥‡çš„é€šçŸ¥ç³»ç»Ÿ**ï¼š

```
ä½ ä¸ç”¨è‡ªå·±å»æ¯å¼ æ¡Œå­æ£€æŸ¥ï¼Œè€Œæ˜¯ï¼š
1. ä½ å‘Šè¯‰æ¯å¼ æ¡Œå­ï¼š"å¦‚æœå®¢äººå‡†å¤‡å¥½äº†ï¼ŒæŒ‰é“ƒé€šçŸ¥æˆ‘"
2. ä½ ååœ¨ä¼‘æ¯åŒºï¼Œç­‰é€šçŸ¥ï¼ˆè¿™å°±æ˜¯ epoll_waitï¼‰
3. ä¸€æ—¦æœ‰æ¡Œå­æŒ‰é“ƒï¼Œä½ ç«‹åˆ»çŸ¥é“æ˜¯å“ªå‡ å¼ æ¡Œå­
4. ä½ åªå»è¿™å‡ å¼ æ¡Œå­æœåŠ¡

ä¼ ç»Ÿæ–¹å¼ï¼ˆselectï¼‰ï¼š
  ä½ éœ€è¦èµ°éæ‰€æœ‰ 10,000 å¼ æ¡Œå­ï¼Œä¸€å¼ ä¸€å¼ é—®ï¼š"å‡†å¤‡å¥½äº†å—ï¼Ÿ"
  â†’ å¤ªæ…¢äº†ï¼O(n) æ—¶é—´å¤æ‚åº¦

epoll æ–¹å¼ï¼š
  ä½ åªå¤„ç†æŒ‰é“ƒçš„æ¡Œå­ï¼ˆæ´»è·ƒçš„è¿æ¥ï¼‰
  â†’ å¿«ï¼O(æ´»è·ƒæ•°) æ—¶é—´å¤æ‚åº¦
```

**epoll_wait çš„ä¸‰ç§æƒ…å†µ**ï¼š

```c
n_events = epoll_wait(epoll_fd, events, MAX_EVENTS, timeout);

// æƒ…å†µ 1: n_events > 0
// æœ‰äº‹ä»¶å‘ç”Ÿï¼è¿”å›çš„ events æ•°ç»„åŒ…å«äº†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶

// æƒ…å†µ 2: n_events == 0
// è¶…æ—¶äº†ï¼Œtimeout æ—¶é—´å†…æ²¡æœ‰ä»»ä½•äº‹ä»¶
// è¿”å›å»å¤„ç†å®šæ—¶å™¨

// æƒ…å†µ 3: n_events < 0
// å‡ºé”™äº†ï¼Œå¯èƒ½æ˜¯è¢«ä¿¡å·ä¸­æ–­
```

**timeout å‚æ•°çš„å·§å¦™è®¾è®¡**ï¼š

```c
// NGINX çš„èªæ˜ä¹‹å¤„ï¼šæ ¹æ®æœ€è¿‘çš„å®šæ—¶å™¨è®¡ç®— timeout
timer = ngx_event_find_timer();  // æ‰¾åˆ°æœ€è¿‘è¦è¿‡æœŸçš„å®šæ—¶å™¨

// ä¾‹å¦‚ï¼šæœ€è¿‘çš„å®šæ—¶å™¨æ˜¯ 500ms åè¿‡æœŸ
// é‚£ä¹ˆ epoll_wait æœ€å¤šç­‰ 500ms
// è¿™æ ·æ—¢ä¸ä¼šé”™è¿‡å®šæ—¶å™¨ï¼Œä¹Ÿä¸ä¼šæµªè´¹æ—¶é—´
n_events = epoll_wait(epoll_fd, events, MAX_EVENTS, timer);
```

##### æ­¥éª¤ 3: å¤„ç† I/O äº‹ä»¶

**epoll_wait è¿”å›åï¼Œæˆ‘ä»¬çŸ¥é“å“ªäº›è¿æ¥å‡†å¤‡å¥½äº†**ï¼š

```c
for (int i = 0; i < n_events; i++) {
    connection_t *c = events[i].data.ptr;  // è·å–è¿æ¥å¯¹è±¡

    // æ£€æŸ¥æ˜¯ä»€ä¹ˆç±»å‹çš„äº‹ä»¶
    if (events[i].events & EPOLLIN) {
        // ğŸ”µ EPOLLIN = å¯è¯»äº‹ä»¶ï¼ˆæœ‰æ•°æ®åˆ°è¾¾ï¼‰

        if (c->type == LISTEN) {
            // è¿™æ˜¯ç›‘å¬å¥—æ¥å­—ï¼Œæœ‰æ–°å®¢æˆ·ç«¯è¿æ¥
            accept_new_connection(c);
        } else {
            // è¿™æ˜¯å·²æœ‰è¿æ¥ï¼Œå®¢æˆ·ç«¯å‘é€äº†æ•°æ®
            read_request_data(c);
        }
    }

    if (events[i].events & EPOLLOUT) {
        // ğŸŸ¢ EPOLLOUT = å¯å†™äº‹ä»¶ï¼ˆå¯ä»¥å‘é€æ•°æ®äº†ï¼‰
        write_response_data(c);
    }
}
```

**å…·ä½“ä¾‹å­**ï¼š

å‡è®¾ epoll_wait è¿”å›äº† 3 ä¸ªäº‹ä»¶ï¼š

```c
Event 1: fd=5,  events=EPOLLIN,  data.ptr=listening_socket
         â†’ æœ‰æ–°å®¢æˆ·ç«¯è¿æ¥ï¼è°ƒç”¨ accept()

Event 2: fd=12, events=EPOLLIN,  data.ptr=connection_123
         â†’ è¿æ¥ 123 å‘æ¥äº† HTTP è¯·æ±‚ï¼è¯»å–æ•°æ®

Event 3: fd=18, events=EPOLLOUT, data.ptr=connection_456
         â†’ è¿æ¥ 456 çš„å“åº”å¯ä»¥å‘é€äº†ï¼å†™å…¥æ•°æ®
```

**è¯»äº‹ä»¶å¤„ç†æµç¨‹**ï¼š

```c
void read_request_data(connection_t *c) {
    // 1. éé˜»å¡è¯»å–æ•°æ®
    ssize_t n = recv(c->fd, buffer, sizeof(buffer), 0);

    if (n > 0) {
        // æˆåŠŸè¯»å–äº† n å­—èŠ‚æ•°æ®
        c->buffer_append(buffer, n);

        // 2. å°è¯•è§£æ HTTP è¯·æ±‚
        if (parse_http_request(c) == COMPLETE) {
            // è¯·æ±‚å®Œæ•´ï¼Œå¼€å§‹å¤„ç†
            process_request(c);
        } else {
            // è¯·æ±‚ä¸å®Œæ•´ï¼Œç­‰å¾…æ›´å¤šæ•°æ®
            // ä¸‹æ¬¡ epoll_wait ä¼šå†æ¬¡é€šçŸ¥æˆ‘ä»¬
            return;
        }
    }
    else if (n == 0) {
        // å®¢æˆ·ç«¯å…³é—­äº†è¿æ¥
        close_connection(c);
    }
    else if (errno == EAGAIN) {
        // æ•°æ®è¿˜æ²¡å‡†å¤‡å¥½ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼Œå› ä¸º epoll é€šçŸ¥äº†å¯è¯»ï¼‰
        return;
    }
}
```

##### æ­¥éª¤ 4: å¤„ç† posted äº‹ä»¶

**ä»€ä¹ˆæ˜¯ posted äº‹ä»¶ï¼Ÿ**

æœ‰äº›æ“ä½œä¸èƒ½ç«‹å³æ‰§è¡Œï¼Œéœ€è¦"å»¶å"å¤„ç†ï¼š

```c
// ä¾‹å­ï¼šæ¥å—æ–°è¿æ¥æ—¶
void accept_new_connection(connection_t *listening) {
    int new_fd = accept(listening->fd, ...);
    connection_t *new_conn = create_connection(new_fd);

    // âš ï¸ é—®é¢˜ï¼šå¦‚æœç«‹å³å¤„ç†è¿™ä¸ªæ–°è¿æ¥çš„è¯»äº‹ä»¶
    // å¯èƒ½ä¼šé˜»å¡å½“å‰çš„äº‹ä»¶å¾ªç¯

    // âœ… è§£å†³ï¼šå°†è¯»äº‹ä»¶"post"åˆ°é˜Ÿåˆ—ä¸­
    post_event(&new_conn->read_event);

    // å…ˆè¿”å›äº‹ä»¶å¾ªç¯ï¼Œå¤„ç†å®Œå…¶ä»–ç´§æ€¥äº‹ä»¶å
    // å†åœ¨æ­¥éª¤ 4 å¤„ç†è¿™ä¸ª posted äº‹ä»¶
}

void process_posted_events() {
    while (queue_not_empty(&posted_events)) {
        event_t *ev = queue_pop(&posted_events);
        ev->handler(ev);  // æ‰§è¡Œå»¶åçš„äº‹ä»¶å¤„ç†
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ posted äº‹ä»¶ï¼Ÿ**

1. **é¿å…é€’å½’è°ƒç”¨å¤ªæ·±**
2. **ä¼˜å…ˆå¤„ç†ç´§æ€¥äº‹ä»¶**ï¼ˆå¦‚å·²æœ‰è¿æ¥çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ–°è¿æ¥ï¼‰
3. **æ›´å¥½çš„å…¬å¹³æ€§**ï¼ˆä¸ä¼šå› ä¸ºæ–°è¿æ¥å¤ªå¤šè€Œé¥¿æ­»è€è¿æ¥ï¼‰

#### å®Œæ•´äº‹ä»¶å¾ªç¯ä¼ªä»£ç ï¼ˆå¸¦è¯¦ç»†æ³¨é‡Šï¼‰

```c
// NGINX Worker è¿›ç¨‹çš„ç®€åŒ–äº‹ä»¶å¾ªç¯
void worker_process_cycle() {
    // ========== åˆå§‹åŒ–é˜¶æ®µ ==========
    epoll_fd = epoll_create(10000);  // åˆ›å»º epoll å®ä¾‹

    // å°†ç›‘å¬å¥—æ¥å­—åŠ å…¥ epoll
    struct epoll_event ev;
    ev.events = EPOLLIN;  // ç›‘å¬å¯è¯»äº‹ä»¶ï¼ˆæ–°è¿æ¥åˆ°è¾¾ï¼‰
    ev.data.ptr = &listening_connection;
    epoll_ctl(epoll_fd, EPOLL_CTL_ADD, listening_fd, &ev);

    // ========== æ— é™äº‹ä»¶å¾ªç¯ ==========
    while (!quit) {
        // ===== æ­¥éª¤ 1: å¤„ç†å®šæ—¶å™¨äº‹ä»¶ =====
        process_timers();
        // - å…³é—­è¶…æ—¶è¿æ¥
        // - è§¦å‘å¥åº·æ£€æŸ¥
        // - è§¦å‘å…¶ä»–å®šæ—¶ä»»åŠ¡

        // ===== æ­¥éª¤ 2: è®¡ç®— epoll è¶…æ—¶æ—¶é—´ =====
        // æ‰¾åˆ°æœ€è¿‘è¦è¿‡æœŸçš„å®šæ—¶å™¨
        timer = ngx_event_find_timer();
        // å¦‚æœæœ€è¿‘çš„å®šæ—¶å™¨æ˜¯ 500ms åè¿‡æœŸ
        // é‚£ä¹ˆ epoll_wait æœ€å¤šç­‰ 500ms

        // ===== æ­¥éª¤ 3: epoll ç­‰å¾…äº‹ä»¶ =====
        n_events = epoll_wait(epoll_fd, events, MAX_EVENTS, timer);
        // è¿™ä¸€è¡Œä¼š"é˜»å¡"ï¼Œä½†ä¸æ˜¯å‚»ç­‰ï¼
        // - å¦‚æœæœ‰äº‹ä»¶ï¼Œç«‹å³è¿”å›
        // - å¦‚æœæ²¡äº‹ä»¶ï¼Œæœ€å¤šç­‰ timer æ¯«ç§’
        // - å¦‚æœè¢«ä¿¡å·ä¸­æ–­ï¼Œè¿”å› -1

        if (n_events == -1) {
            // é”™è¯¯å¤„ç†ï¼ˆé€šå¸¸æ˜¯è¢«ä¿¡å·ä¸­æ–­ï¼‰
            continue;
        }

        // ===== æ­¥éª¤ 4: å¤„ç†æ‰€æœ‰å°±ç»ªçš„ I/O äº‹ä»¶ =====
        for (int i = 0; i < n_events; i++) {
            connection_t *c = events[i].data.ptr;  // å–å‡ºè¿æ¥å¯¹è±¡

            // å¤„ç†å¯è¯»äº‹ä»¶
            if (events[i].events & EPOLLIN) {
                if (c->type == LISTEN) {
                    // ç›‘å¬å¥—æ¥å­—ï¼šæœ‰æ–°è¿æ¥
                    accept_new_connection(c);
                } else {
                    // æ™®é€šè¿æ¥ï¼šæœ‰æ•°æ®åˆ°è¾¾
                    read_request_data(c);
                }
            }

            // å¤„ç†å¯å†™äº‹ä»¶
            if (events[i].events & EPOLLOUT) {
                // è¿æ¥å¯ä»¥å†™å…¥æ•°æ®äº†
                write_response_data(c);
            }

            // å¤„ç†é”™è¯¯/å…³é—­äº‹ä»¶
            if (events[i].events & (EPOLLERR | EPOLLHUP)) {
                // è¿æ¥å‡ºé”™æˆ–è¢«å¯¹æ–¹å…³é—­
                close_connection(c);
            }
        }

        // ===== æ­¥éª¤ 5: å¤„ç† posted äº‹ä»¶ï¼ˆå»¶è¿Ÿäº‹ä»¶ï¼‰=====
        // å…ˆå¤„ç† accept äº‹ä»¶ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
        process_posted_events(&posted_accept_events);

        // å†å¤„ç†æ™®é€šäº‹ä»¶
        process_posted_events(&posted_events);
    }
}
```

#### ğŸ”¥ åŠ¨æ‰‹å®è·µï¼šè¿è¡Œ Go ä»£ç æ¼”ç¤º

ä¸ºäº†æ›´å¥½åœ°ç†è§£äº‹ä»¶å¾ªç¯ï¼Œæˆ‘æä¾›äº†ä¸¤ä¸ªå¯è¿è¡Œçš„ Go ä»£ç ç¤ºä¾‹ï¼š

**ğŸ“ ä»£ç ä½ç½®**: `notes/projects/week/nginx-event-loop`

1. **`event_loop_simple.go`** - ç®€åŒ–ç‰ˆï¼ˆæ¨èå…ˆå­¦ä¹ ï¼‰

   - çº¯ Go å®ç°ï¼Œè·¨å¹³å°
   - ä¸ä½¿ç”¨ epollï¼Œä½†åŸç†ä¸€è‡´
   - ä»£ç ç®€å•æ˜“è¯»ï¼Œé€‚åˆç†è§£åŸºæœ¬æ¦‚å¿µ
2. **`event_loop_improved.go`** - å¤šè¿æ¥æ”¹è¿›ç‰ˆ

**å¿«é€Ÿè¿è¡Œ**ï¼š

```bash
# è¿›å…¥ä»£ç ç›®å½•
cd notes/projects/week1/nginx-event-loop/

# è¿è¡Œç®€åŒ–ç‰ˆï¼ˆè·¨å¹³å°ï¼‰
go run event_loop_simple.go

# è¿è¡ŒçœŸå®ç‰ˆï¼ˆä»… Linuxï¼‰
go run event_loop_improved.go

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
go run client_concurrent.go
```

**ä½ ä¼šçœ‹åˆ°å®Œæ•´çš„äº‹ä»¶å¾ªç¯è¾“å‡º**ï¼š

```
â”â”â”â”â”â”â”â”â”â”â” äº‹ä»¶å¾ªç¯ç¬¬ 1 åœˆ â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ æ­¥éª¤ 1: å¤„ç†å®šæ—¶å™¨äº‹ä»¶
ğŸ“Œ æ­¥éª¤ 2: epoll_wait æœ€å¤šç­‰å¾… 4.998s
ğŸ“Œ æ­¥éª¤ 3: epoll_wait è¿”å› 1 ä¸ªäº‹ä»¶
   ğŸ”µ äº‹ä»¶ç±»å‹: EPOLLIN (ç›‘å¬socket) - æœ‰æ–°è¿æ¥
      âœ… æ¥å—æ–°è¿æ¥ fd=5, å½“å‰è¿æ¥æ•°: 1

â”â”â”â”â”â”â”â”â”â”â” äº‹ä»¶å¾ªç¯ç¬¬ 2 åœˆ â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ æ­¥éª¤ 1: å¤„ç†å®šæ—¶å™¨äº‹ä»¶
ğŸ“Œ æ­¥éª¤ 2: epoll_wait æœ€å¤šç­‰å¾… 4.897s
ğŸ“Œ æ­¥éª¤ 3: epoll_wait è¿”å› 1 ä¸ªäº‹ä»¶
   ğŸ”µ äº‹ä»¶ç±»å‹: EPOLLIN (fd=5) - å¯è¯»
      ğŸ“– è¯»å– 78 å­—èŠ‚, æ€»è®¡: 78 å­—èŠ‚
      âœ… æ”¶åˆ°å®Œæ•´ HTTP è¯·æ±‚
```

è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ï¼š`notes/projects/week1/nginx-event-loop/README_event_loop.md`

### 3.2 çŠ¶æ€æœºæ¶æ„

NGINX ä½¿ç”¨çŠ¶æ€æœºæ¥å¤„ç† HTTP è¯·æ±‚ï¼Œé¿å…é˜»å¡ç­‰å¾…ï¼š

```
çŠ¶æ€æœºçŠ¶æ€è½¬æ¢å›¾ï¼š

[READING_REQUEST_LINE] --è¯»å–å®Œæˆ--> [READING_HEADERS]
         â†“ (éœ€è¦æ›´å¤šæ•°æ®)                    â†“
    [WAITING_READ]  <-------è¯»å–å®Œæˆ----> [PROCESSING]
                                              â†“
                                    [WRITING_RESPONSE]
                                              â†“
                                    [KEEPALIVE / CLOSE]
```

#### çŠ¶æ€æœºä»£ç ç¤ºä¾‹

```c
void http_process_request(ngx_connection_t *c) {
    switch (c->state) {
        case NGX_HTTP_READING_REQUEST_LINE:
            rc = ngx_http_read_request_line(c);
            if (rc == NGX_AGAIN) {
                // æ•°æ®æœªå°±ç»ªï¼Œè¿”å›äº‹ä»¶å¾ªç¯
                return;
            }
            c->state = NGX_HTTP_READING_HEADERS;
            // fall through

        case NGX_HTTP_READING_HEADERS:
            rc = ngx_http_read_headers(c);
            if (rc == NGX_AGAIN) {
                return;  // è¿”å›äº‹ä»¶å¾ªç¯
            }
            c->state = NGX_HTTP_PROCESSING;
            // fall through

        case NGX_HTTP_PROCESSING:
            ngx_http_process_request(c);
            c->state = NGX_HTTP_WRITING;
            // fall through

        case NGX_HTTP_WRITING:
            rc = ngx_http_write_filter(c);
            if (rc == NGX_AGAIN) {
                return;  // ç¼“å†²åŒºæ»¡ï¼Œè¿”å›äº‹ä»¶å¾ªç¯
            }
            ngx_http_finalize_request(c);
            break;
    }
}
```

**å…³é”®ç‚¹**:

- æ¯ä¸ªçŠ¶æ€å¤„ç†å®Œæˆåï¼Œå¦‚æœéœ€è¦ç­‰å¾… I/Oï¼Œç«‹å³è¿”å›äº‹ä»¶å¾ªç¯ï¼ˆNGX_AGAINï¼‰
- ä¸ä¼šé˜»å¡åœ¨ä»»ä½• I/O æ“ä½œä¸Š
- ä¸€ä¸ª Worker å¯ä»¥åŒæ—¶æ¨è¿›æˆåƒä¸Šä¸‡ä¸ªè¿æ¥çš„çŠ¶æ€æœº

### 3.3 éé˜»å¡ I/O è¯¦è§£

#### é˜»å¡ vs éé˜»å¡å¯¹æ¯”

```c
// é˜»å¡ I/Oï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
ssize_t n = read(fd, buffer, size);  // é˜»å¡ç›´åˆ°æ•°æ®åˆ°è¾¾
// CPU ç©ºè½¬ç­‰å¾…...

// éé˜»å¡ I/Oï¼ˆNGINX æ–¹å¼ï¼‰
fcntl(fd, F_SETFL, O_NONBLOCK);  // è®¾ç½®ä¸ºéé˜»å¡
ssize_t n = read(fd, buffer, size);
if (n == -1 && errno == EAGAIN) {
    // æ•°æ®æœªå°±ç»ªï¼Œè¿”å›äº‹ä»¶å¾ªç¯
    return NGX_AGAIN;
}
```

#### å®Œæ•´çš„éé˜»å¡è¯»å–ç¤ºä¾‹

```c
ssize_t ngx_unix_recv(ngx_connection_t *c, u_char *buf, size_t size) {
    ssize_t       n;
    ngx_err_t     err;
    ngx_event_t  *rev;

    rev = c->read;

    do {
        n = recv(c->fd, buf, size, 0);

        if (n == 0) {
            // è¿æ¥å…³é—­
            rev->ready = 0;
            rev->eof = 1;
            return 0;
        }

        if (n > 0) {
            // æˆåŠŸè¯»å–æ•°æ®
            if ((size_t) n < size) {
                rev->ready = 0;  // æ•°æ®å·²è¯»å®Œ
            }
            return n;
        }

        err = ngx_socket_errno;

        if (err == NGX_EAGAIN || err == NGX_EINTR) {
            // æ•°æ®æœªå°±ç»ªæˆ–è¢«ä¿¡å·ä¸­æ–­
            n = NGX_AGAIN;
        } else {
            // çœŸæ­£çš„é”™è¯¯
            n = NGX_ERROR;
            break;
        }

    } while (err == NGX_EINTR);  // ä¿¡å·ä¸­æ–­æ—¶é‡è¯•

    return n;
}
```

---

## Part 4: I/O å¤šè·¯å¤ç”¨æ·±å…¥åŸç†

### 4.1 epoll æ ¸å¿ƒæœºåˆ¶

#### ä»€ä¹ˆæ˜¯ epollï¼Ÿ

epoll æ˜¯ Linux æä¾›çš„é«˜æ•ˆ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç›¸æ¯” select/poll æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

| ç‰¹æ€§                     | select            | poll       | epoll     |
| ------------------------ | ----------------- | ---------- | --------- |
| æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°         | 1024 (FD_SETSIZE) | æ— é™åˆ¶     | æ— é™åˆ¶    |
| æ¯æ¬¡è°ƒç”¨çš„æ—¶é—´å¤æ‚åº¦     | O(n)              | O(n)       | O(æ´»è·ƒæ•°) |
| éœ€è¦ä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ | æ˜¯                | æ˜¯         | å¦        |
| æ”¯æŒæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘   | ä»…æ°´å¹³è§¦å‘        | ä»…æ°´å¹³è§¦å‘ | éƒ½æ”¯æŒ    |

#### epoll ä¸‰ä¸ªæ ¸å¿ƒ API

```c
// 1. åˆ›å»º epoll å®ä¾‹
int epfd = epoll_create(size);  // size å‚æ•°åœ¨æ–°ç‰ˆæœ¬è¢«å¿½ç•¥

// 2. æ·»åŠ /ä¿®æ”¹/åˆ é™¤ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦
struct epoll_event ev;
ev.events = EPOLLIN | EPOLLET;  // ç›‘å¬è¯»äº‹ä»¶ + è¾¹ç¼˜è§¦å‘
ev.data.fd = fd;
epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &ev);  // æ·»åŠ 
epoll_ctl(epfd, EPOLL_CTL_MOD, fd, &ev);  // ä¿®æ”¹
epoll_ctl(epfd, EPOLL_CTL_DEL, fd, NULL); // åˆ é™¤

// 3. ç­‰å¾…äº‹ä»¶
struct epoll_event events[MAX_EVENTS];
int n = epoll_wait(epfd, events, MAX_EVENTS, timeout);
```

#### epoll å†…éƒ¨å®ç°åŸç†

```
ç”¨æˆ·ç©ºé—´                    å†…æ ¸ç©ºé—´

epoll_create()  â”€â”€â”€â”€â”€â”€>  åˆ›å»º eventpoll ç»“æ„
                           â”œâ”€ çº¢é»‘æ ‘ï¼ˆå­˜å‚¨æ‰€æœ‰ç›‘å¬çš„fdï¼‰
                           â””â”€ å°±ç»ªé“¾è¡¨ï¼ˆå­˜å‚¨å°±ç»ªçš„fdï¼‰

epoll_ctl(ADD)  â”€â”€â”€â”€â”€â”€>  å°† fd æ·»åŠ åˆ°çº¢é»‘æ ‘
                         æ³¨å†Œå›è°ƒå‡½æ•°åˆ°è®¾å¤‡é©±åŠ¨

[æ•°æ®åˆ°è¾¾]      â”€â”€â”€â”€â”€â”€>  è®¾å¤‡é©±åŠ¨è°ƒç”¨å›è°ƒå‡½æ•°
                         å°† fd åŠ å…¥å°±ç»ªé“¾è¡¨

epoll_wait()    â”€â”€â”€â”€â”€â”€>  æ£€æŸ¥å°±ç»ªé“¾è¡¨
                         å¦‚æœä¸ºç©ºï¼Œç¡çœ ç­‰å¾…
                         å¦‚æœéç©ºï¼Œè¿”å›å°±ç»ªçš„ fd
```

#### æ°´å¹³è§¦å‘ vs è¾¹ç¼˜è§¦å‘

```c
// æ°´å¹³è§¦å‘ï¼ˆLevel-Triggered, LTï¼‰- NGINX é»˜è®¤ä½¿ç”¨
// åªè¦ fd å°±ç»ªï¼Œæ¯æ¬¡ epoll_wait éƒ½ä¼šè¿”å›

epoll_wait()  --> fd å¯è¯»ï¼Œè¿”å›
read()        --> è¯»å–éƒ¨åˆ†æ•°æ®
epoll_wait()  --> fd ä»ç„¶å¯è¯»ï¼Œå†æ¬¡è¿”å› âœ“

// è¾¹ç¼˜è§¦å‘ï¼ˆEdge-Triggered, ETï¼‰
// åªåœ¨çŠ¶æ€å˜åŒ–æ—¶è¿”å›ä¸€æ¬¡

epoll_wait()  --> fd ä»ä¸å¯è¯»å˜ä¸ºå¯è¯»ï¼Œè¿”å›
read()        --> è¯»å–éƒ¨åˆ†æ•°æ®
epoll_wait()  --> fd çŠ¶æ€æœªå˜åŒ–ï¼Œä¸è¿”å› âœ—
```

**NGINX ä¸ºä»€ä¹ˆç”¨ LTï¼Ÿ**

- æ›´å®‰å…¨ï¼Œä¸ä¼šä¸¢äº‹ä»¶
- ä»£ç é€»è¾‘æ›´ç®€å•
- æ€§èƒ½å·®å¼‚ä¸å¤§ï¼ˆå› ä¸º NGINX ä¼šä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰æ•°æ®ï¼‰

### 4.2 NGINX çš„ epoll ä½¿ç”¨

```c
// src/event/modules/ngx_epoll_module.c
static ngx_int_t ngx_epoll_process_events(ngx_cycle_t *cycle) {
    int                events;
    uint32_t           revents;
    ngx_int_t          instance, i;
    ngx_uint_t         level;
    ngx_err_t          err;
    ngx_event_t       *rev, *wev;
    ngx_queue_t       *queue;
    ngx_connection_t  *c;

    // epoll_wait ç­‰å¾…äº‹ä»¶ï¼Œè¶…æ—¶æ—¶é—´ç”±å®šæ—¶å™¨å†³å®š
    events = epoll_wait(ep, event_list, (int) nevents, timer);

    if (events == -1) {
        err = ngx_errno;
        if (err == NGX_EINTR) {
            level = NGX_LOG_INFO;
        } else {
            level = NGX_LOG_ALERT;
        }
        ngx_log_error(level, cycle->log, err, "epoll_wait() failed");
        return NGX_ERROR;
    }

    // å¤„ç†æ¯ä¸ªå°±ç»ªçš„äº‹ä»¶
    for (i = 0; i < events; i++) {
        c = event_list[i].data.ptr;  // è·å–è¿æ¥å¯¹è±¡
        revents = event_list[i].events;

        // å¤„ç†è¯»äº‹ä»¶
        if (revents & EPOLLIN) {
            rev = c->read;
            rev->ready = 1;
            rev->handler(rev);  // è°ƒç”¨è¯»äº‹ä»¶å¤„ç†å‡½æ•°
        }

        // å¤„ç†å†™äº‹ä»¶
        if (revents & EPOLLOUT) {
            wev = c->write;
            wev->ready = 1;
            wev->handler(wev);  // è°ƒç”¨å†™äº‹ä»¶å¤„ç†å‡½æ•°
        }
    }

    return NGX_OK;
}
```

---

## Part 5: å›½é™…è±¡æ£‹å¤§å¸ˆç±»æ¯” - å½¢è±¡ç†è§£

### 5.1 ä¼ ç»Ÿé˜»å¡æ¶æ„ï¼šä¸€å¯¹ä¸€å¯¹å¼ˆ

![Blocking I/O](https://nginxblog-8de1046ff5a84f2c-endpoint.azureedge.net/blobnginxbloga72cde487e/wp-content/uploads/2015/06/infographic-Inside-NGINX_blocking.png)

```
å¤§å¸ˆ 1  <â”€â”€â”€â”€>  ç©å®¶ 1  (å¤§å¸ˆç­‰å¾…ç©å®¶æ€è€ƒ... é˜»å¡)
å¤§å¸ˆ 2  <â”€â”€â”€â”€>  ç©å®¶ 2  (å¤§å¸ˆç­‰å¾…ç©å®¶æ€è€ƒ... é˜»å¡)
å¤§å¸ˆ 3  <â”€â”€â”€â”€>  ç©å®¶ 3  (å¤§å¸ˆç­‰å¾…ç©å®¶æ€è€ƒ... é˜»å¡)
...
å¤§å¸ˆ 1000 <â”€â”€â”€> ç©å®¶ 1000

èµ„æºæ¶ˆè€—ï¼š1000 ä¸ªå¤§å¸ˆï¼
```

### 5.2 NGINX è½¦è½®æˆ˜ï¼šåŒæ—¶å¯¹å¼ˆ

![Non-blocking I/O](https://nginxblog-8de1046ff5a84f2c-endpoint.azureedge.net/blobnginxbloga72cde487e/wp-content/uploads/2015/06/infographic-Inside-NGINX_nonblocking.png)

```
         å¤§å¸ˆ
          |
    +-----+-----+-----+
    |     |     |     |
  ç©å®¶1  ç©å®¶2  ç©å®¶3  ç©å®¶1000

å·¥ä½œæµç¨‹ï¼š
1. å¤§å¸ˆèµ°åˆ°ç©å®¶ 1 é¢å‰ï¼Œç©å®¶ 1 å·²æ€è€ƒå¥½ â†’ èµ°ä¸€æ­¥
2. å¤§å¸ˆèµ°åˆ°ç©å®¶ 2 é¢å‰ï¼Œç©å®¶ 2 è¿˜åœ¨æ€è€ƒ â†’ è·³è¿‡
3. å¤§å¸ˆèµ°åˆ°ç©å®¶ 3 é¢å‰ï¼Œç©å®¶ 3 å·²æ€è€ƒå¥½ â†’ èµ°ä¸€æ­¥
...
æŒç»­å¾ªç¯ï¼Œæ°¸ä¸ç­‰å¾…ï¼

èµ„æºæ¶ˆè€—ï¼š1 ä¸ªå¤§å¸ˆï¼ï¼ˆæˆ– 4 ä¸ªï¼Œå¯¹åº” 4 æ ¸ CPUï¼‰
```

**çœŸå®æ¡ˆä¾‹**: ä¿åŠ åˆ©äºšå¤§å¸ˆ Kiril Georgiev åœ¨ç´¢éäºš**åŒæ—¶ä¸ 360 äººå¯¹å¼ˆ**ï¼Œæœ€ç»ˆå¾—åˆ†ï¼š**284 èƒœï¼Œ70 å¹³ï¼Œ6 è´Ÿ**ã€‚

---

## Part 6: NGINX æºç é˜…è¯»æŒ‡å—

### 6.1 æºç ç»“æ„æ¦‚è§ˆ

```
nginx/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ nginx.c        # ä¸»å…¥å£ï¼ˆmain å‡½æ•°ï¼‰
â”‚   â”‚   â”œâ”€â”€ ngx_cycle.c    # æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆé…ç½®ã€è¿æ¥æ± ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ ngx_connection.c # è¿æ¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ngx_conf_file.c  # é…ç½®æ–‡ä»¶è§£æ
â”‚   â”‚   â””â”€â”€ ngx_palloc.c     # å†…å­˜æ± 
â”‚   â”‚
â”‚   â”œâ”€â”€ event/             # äº‹ä»¶æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ngx_event.c    # äº‹ä»¶æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ ngx_event_accept.c # æ¥å—è¿æ¥
â”‚   â”‚   â”œâ”€â”€ ngx_event_timer.c  # å®šæ—¶å™¨
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â”œâ”€â”€ ngx_epoll_module.c  # epoll æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ ngx_kqueue_module.c # kqueue æ¨¡å—ï¼ˆBSDï¼‰
â”‚   â”‚       â””â”€â”€ ngx_select_module.c # select æ¨¡å—ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ os/                # æ“ä½œç³»ç»Ÿç›¸å…³
â”‚   â”‚   â””â”€â”€ unix/
â”‚   â”‚       â”œâ”€â”€ ngx_process.c      # è¿›ç¨‹ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ ngx_process_cycle.c # è¿›ç¨‹å¾ªç¯
â”‚   â”‚       â””â”€â”€ ngx_daemon.c        # å®ˆæŠ¤è¿›ç¨‹
â”‚   â”‚
â”‚   â””â”€â”€ http/              # HTTP æ¨¡å—
â”‚       â”œâ”€â”€ ngx_http.c     # HTTP æ ¸å¿ƒ
â”‚       â”œâ”€â”€ ngx_http_request.c # HTTP è¯·æ±‚å¤„ç†
â”‚       â”œâ”€â”€ ngx_http_upstream.c # åå‘ä»£ç†
â”‚       â””â”€â”€ modules/
â”‚           â””â”€â”€ ngx_http_upstream_round_robin.c # è´Ÿè½½å‡è¡¡
```

### 6.2 æ ¸å¿ƒæ–‡ä»¶è¯¦è§£

#### 1. `src/core/nginx.c` - ä¸»å…¥å£

```c
int main(int argc, char *const *argv) {
    // 1. åˆå§‹åŒ–æ—¥å¿—
    ngx_log_init();

    // 2. è§£æå‘½ä»¤è¡Œå‚æ•°
    ngx_get_options(argc, argv);

    // 3. åˆå§‹åŒ– cycleï¼ˆæ ¸å¿ƒæ•°æ®ç»“æ„ï¼‰
    cycle = ngx_init_cycle(&init_cycle);

    // 4. å¦‚æœæ˜¯ master æ¨¡å¼ï¼Œå¯åŠ¨ master-worker æ¶æ„
    if (ngx_process == NGX_PROCESS_MASTER) {
        ngx_master_process_cycle(cycle);
    } else {
        ngx_single_process_cycle(cycle);
    }

    return 0;
}
```

**å­¦ä¹ é‡ç‚¹**:

- NGINX å¦‚ä½•è§£æé…ç½®æ–‡ä»¶
- å¦‚ä½•åˆå§‹åŒ–å…¨å±€æ•°æ®ç»“æ„
- master-worker æ¨¡å¼å¦‚ä½•å¯åŠ¨

#### 2. `src/os/unix/ngx_process_cycle.c` - Worker è¿›ç¨‹å¾ªç¯

```c
static void ngx_worker_process_cycle(ngx_cycle_t *cycle, void *data) {
    ngx_int_t worker = (intptr_t) data;

    // åˆå§‹åŒ– Worker è¿›ç¨‹
    ngx_worker_process_init(cycle, worker);

    // **æ ¸å¿ƒï¼šæ— é™äº‹ä»¶å¾ªç¯**
    for ( ;; ) {
        // å¦‚æœæ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œä¼˜é›…å…³é—­
        if (ngx_exiting) {
            ngx_worker_process_exit(cycle);
        }

        // **å¤„ç†äº‹ä»¶ï¼ˆepoll_waitï¼‰**
        ngx_process_events_and_timers(cycle);

        // å¤„ç†ä¿¡å·
        if (ngx_terminate) {
            return;
        }
        if (ngx_quit) {
            ngx_quit = 0;
            ngx_log_error(NGX_LOG_NOTICE, cycle->log, 0, "gracefully shutting down");
            ngx_setproctitle("worker process is shutting down");
            ngx_exiting = 1;
        }
        if (ngx_reopen) {
            ngx_reopen = 0;
            ngx_reopen_files(cycle, -1);
        }
    }
}
```

**å­¦ä¹ é‡ç‚¹**:

- Worker è¿›ç¨‹çš„åˆå§‹åŒ–è¿‡ç¨‹
- äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒé€»è¾‘
- ä¼˜é›…å…³é—­çš„å®ç°

#### 3. `src/event/ngx_event.c` - äº‹ä»¶å¤„ç†æ ¸å¿ƒ

```c
void ngx_process_events_and_timers(ngx_cycle_t *cycle) {
    ngx_uint_t  flags;
    ngx_msec_t  timer, delta;

    // 1. è®¡ç®—å®šæ—¶å™¨è¶…æ—¶æ—¶é—´
    timer = ngx_event_find_timer();
    flags = NGX_UPDATE_TIME;

    // 2. **æ ¸å¿ƒï¼šè°ƒç”¨äº‹ä»¶é©±åŠ¨æ¨¡å—ï¼ˆå¦‚ epollï¼‰**
    //    è¿™é‡Œä¼šè°ƒç”¨ ngx_epoll_process_events()
    (void) ngx_process_events(cycle, timer, flags);

    // 3. å¤„ç†å®šæ—¶å™¨äº‹ä»¶
    ngx_event_process_posted(cycle, &ngx_posted_accept_events);

    // 4. å¤„ç†è¿‡æœŸçš„å®šæ—¶å™¨
    ngx_event_expire_timers();

    // 5. å¤„ç†æ™®é€šäº‹ä»¶
    ngx_event_process_posted(cycle, &ngx_posted_events);
}
```

**å­¦ä¹ é‡ç‚¹**:

- äº‹ä»¶æ¨¡å—çš„æ’ä»¶åŒ–è®¾è®¡
- å®šæ—¶å™¨å¦‚ä½•ä¸ I/O äº‹ä»¶ç»“åˆ
- posted äº‹ä»¶çš„ä½œç”¨

#### 4. `src/event/modules/ngx_epoll_module.c` - epoll å®ç°

```c
static ngx_int_t ngx_epoll_process_events(ngx_cycle_t *cycle, ngx_msec_t timer, ngx_uint_t flags) {
    int                events;
    struct epoll_event *event_list;

    // **æ ¸å¿ƒï¼šepoll_wait ç­‰å¾…äº‹ä»¶**
    events = epoll_wait(ep, event_list, (int) nevents, timer);

    if (events == -1) {
        return NGX_ERROR;
    }

    // éå†æ‰€æœ‰å°±ç»ªäº‹ä»¶
    for (i = 0; i < events; i++) {
        c = event_list[i].data.ptr;  // è¿æ¥å¯¹è±¡

        // å¤„ç†è¯»äº‹ä»¶
        if (event_list[i].events & EPOLLIN) {
            rev = c->read;
            rev->ready = 1;
            rev->handler(rev);  // **è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°**
        }

        // å¤„ç†å†™äº‹ä»¶
        if (event_list[i].events & EPOLLOUT) {
            wev = c->write;
            wev->ready = 1;
            wev->handler(wev);
        }
    }

    return NGX_OK;
}
```

**å­¦ä¹ é‡ç‚¹**:

- epoll API çš„ä½¿ç”¨
- äº‹ä»¶åˆ†å‘æœºåˆ¶
- å›è°ƒå‡½æ•°çš„è®¾è®¡

### 6.3 æºç é˜…è¯»è·¯å¾„å»ºè®®

#### è·¯å¾„ä¸€ï¼šå¯åŠ¨æµç¨‹ï¼ˆ2-3 å°æ—¶ï¼‰

```
1. src/core/nginx.c:main()
   â†’ äº†è§£å¯åŠ¨æµç¨‹

2. src/os/unix/ngx_process_cycle.c:ngx_master_process_cycle()
   â†’ äº†è§£ master å¦‚ä½• fork worker

3. src/os/unix/ngx_process_cycle.c:ngx_worker_process_cycle()
   â†’ äº†è§£ worker çš„ä¸»å¾ªç¯
```

#### è·¯å¾„äºŒï¼šäº‹ä»¶å¤„ç†ï¼ˆ3-4 å°æ—¶ï¼‰

```
1. src/event/ngx_event.c:ngx_process_events_and_timers()
   â†’ äº†è§£äº‹ä»¶å¾ªç¯æ¡†æ¶

2. src/event/modules/ngx_epoll_module.c:ngx_epoll_process_events()
   â†’ äº†è§£ epoll çš„ä½¿ç”¨

3. src/event/ngx_event_accept.c:ngx_event_accept()
   â†’ äº†è§£å¦‚ä½•æ¥å—æ–°è¿æ¥
```

#### è·¯å¾„ä¸‰ï¼šHTTP è¯·æ±‚å¤„ç†ï¼ˆ4-5 å°æ—¶ï¼‰

```
1. src/http/ngx_http_request.c:ngx_http_process_request_line()
   â†’ äº†è§£è¯·æ±‚è¡Œè§£æ

2. src/http/ngx_http_request.c:ngx_http_process_request_headers()
   â†’ äº†è§£è¯·æ±‚å¤´è§£æ

3. src/http/ngx_http_core_module.c:ngx_http_core_run_phases()
   â†’ äº†è§£ HTTP å¤„ç†çš„ 11 ä¸ªé˜¶æ®µ
```

### 6.4 æºç å­¦ä¹ æŠ€å·§

#### 1. ä½¿ç”¨ gdb åŠ¨æ€è°ƒè¯•

```bash
# ç¼–è¯‘å¸¦è°ƒè¯•ç¬¦å·çš„ NGINX
$ ./configure --with-debug
$ make

# ä½¿ç”¨ gdb è°ƒè¯•
$ gdb ./objs/nginx
(gdb) break ngx_worker_process_cycle  # åœ¨ worker å¾ªç¯è®¾ç½®æ–­ç‚¹
(gdb) run
(gdb) next  # å•æ­¥æ‰§è¡Œ
(gdb) print cycle  # æ‰“å°å˜é‡
```

#### 2. æ·»åŠ æ—¥å¿—è·Ÿè¸ª

```c
// åœ¨æ„Ÿå…´è¶£çš„åœ°æ–¹æ·»åŠ æ—¥å¿—
ngx_log_error(NGX_LOG_NOTICE, cycle->log, 0,
              "DEBUG: current connections = %d", ngx_cycle->connection_n);
```

#### 3. ç»˜åˆ¶è°ƒç”¨å…³ç³»å›¾

ä½¿ç”¨ Graphviz ç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾ï¼š

```bash
$ sudo apt install doxygen graphviz
$ doxygen -g  # ç”Ÿæˆé…ç½®æ–‡ä»¶
# ç¼–è¾‘ Doxyfileï¼Œè®¾ç½® CALL_GRAPH = YES
$ doxygen
$ firefox html/index.html
```

---

## Part 7: ä¸‰ä¸ªåŠ¨æ‰‹å®éªŒ

### å®éªŒä¸€ï¼šé˜»å¡ I/O vs éé˜»å¡ I/O æ€§èƒ½å¯¹æ¯”

#### ç›®æ ‡

é€šè¿‡å®é™…ä»£ç å’Œå‹æµ‹ï¼Œå¯¹æ¯”é˜»å¡å’Œéé˜»å¡ I/O çš„æ€§èƒ½å·®å¼‚ã€‚

#### å®éªŒæ­¥éª¤

**æ­¥éª¤ 1**: å®ç°é˜»å¡ I/O æœåŠ¡å™¨ï¼ˆGin æ¡†æ¶ - åŒæ­¥æ¨¡å¼ï¼‰

åˆ›å»ºæ–‡ä»¶ `blocking_server.go`:

```go
package main

import (
	"fmt"
	"net/http"
	"runtime"
	"sync/atomic"
	"time"

	"github.com/gin-gonic/gin"
)

// é˜»å¡ I/O æ¨¡å‹ï¼šGin é»˜è®¤æ¨¡å¼
// æ¯ä¸ªè¯·æ±‚ä¸€ä¸ª Goroutineï¼Œå¤„ç†æ—¶ä¼šé˜»å¡è¯¥ Goroutine

var (
	requestCount int64
	activeConns  int64
)

func main() {
	// å…³é—­ Gin çš„è°ƒè¯•æ—¥å¿—
	gin.SetMode(gin.ReleaseMode)

	r := gin.New()
	r.Use(gin.Recovery())

	// ä¸­é—´ä»¶ï¼šç»Ÿè®¡è¯·æ±‚
	r.Use(func(c *gin.Context) {
		atomic.AddInt64(&activeConns, 1)
		defer atomic.AddInt64(&activeConns, -1)
		atomic.AddInt64(&requestCount, 1)
		c.Next()
	})

	// æ¨¡æ‹Ÿé˜»å¡ I/O æ“ä½œï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ã€å¤–éƒ¨ API è°ƒç”¨ï¼‰
	r.GET("/", func(c *gin.Context) {
		// æ¨¡æ‹Ÿé˜»å¡æ“ä½œï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶è¯»å–ç­‰
		time.Sleep(10 * time.Millisecond)

		c.JSON(http.StatusOK, gin.H{
			"message": "Hello from Blocking IO",
			"model":   "æ¯ä¸ªè¯·æ±‚ä¸€ä¸ª Goroutineï¼ˆé˜»å¡ï¼‰",
		})
	})

	// ç»Ÿè®¡æ¥å£
	r.GET("/stats", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"goroutines":    runtime.NumGoroutine(),
			"total_requests": atomic.LoadInt64(&requestCount),
			"active_conns":  atomic.LoadInt64(&activeConns),
		})
	})

	fmt.Println("â”â”â”â”â”â”â”â” é˜»å¡ I/O æœåŠ¡å™¨ (Gin) â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ¯ æ¨¡å‹: æ¯ä¸ªè¯·æ±‚ä¸€ä¸ª Goroutineï¼ˆåŒæ­¥å¤„ç†ï¼‰")
	fmt.Println("ğŸ“ ç«¯å£: 8001")
	fmt.Println("ğŸ“Š ç»Ÿè®¡: http://localhost:8001/stats")
	fmt.Println()

	// å¯åŠ¨æœåŠ¡å™¨
	r.Run(":8001")
}
```

**å®‰è£…ä¾èµ–**ï¼š
```bash
go mod init blocking-demo
go get -u github.com/gin-gonic/gin
```

**æ­¥éª¤ 2**: å®ç°éé˜»å¡ I/O æœåŠ¡å™¨ï¼ˆGin + å¼‚æ­¥å¤„ç† + å·¥ä½œæ± ï¼‰

åˆ›å»ºæ–‡ä»¶ `nonblocking_server.go`:

```go
package main

import (
	"fmt"
	"net/http"
	"runtime"
	"sync/atomic"
	"time"

	"github.com/gin-gonic/gin"
)

// éé˜»å¡ I/O æ¨¡å‹ï¼šä½¿ç”¨å·¥ä½œæ±  + Channelï¼ˆæ¨¡æ‹Ÿ NGINX Worker Poolï¼‰
// ç‰¹ç‚¹ï¼šå›ºå®šæ•°é‡çš„ Worker Goroutineï¼Œé¿å…æ— é™åˆ›å»º Goroutine

var (
	requestCount int64
	activeConns  int64
	workerCount  = 10 // å›ºå®š 10 ä¸ª Workerï¼ˆç±»ä¼¼ NGINX worker_processesï¼‰
)

// Task è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡
type Task struct {
	ResultChan chan Result
}

type Result struct {
	Message string
	Model   string
}

// å·¥ä½œæ± ï¼šå›ºå®šæ•°é‡çš„ Worker Goroutine
var taskQueue = make(chan Task, 1000) // ä»»åŠ¡é˜Ÿåˆ—

func initWorkerPool() {
	for i := 0; i < workerCount; i++ {
		go worker(i)
	}
	fmt.Printf("âœ… åˆå§‹åŒ– %d ä¸ª Worker Goroutine\n", workerCount)
}

// Worker å‡½æ•°ï¼šç±»ä¼¼ NGINX çš„ Worker è¿›ç¨‹
func worker(id int) {
	for task := range taskQueue {
		// æ¨¡æ‹Ÿé˜»å¡æ“ä½œï¼ˆæ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰
		time.Sleep(10 * time.Millisecond)

		// å‘é€ç»“æœ
		task.ResultChan <- Result{
			Message: "Hello from Non-Blocking IO",
			Model:   fmt.Sprintf("å·¥ä½œæ± æ¨¡å¼ (Worker %d)", id),
		}
	}
}

func main() {
	gin.SetMode(gin.ReleaseMode)

	// åˆå§‹åŒ–å·¥ä½œæ± 
	initWorkerPool()

	r := gin.New()
	r.Use(gin.Recovery())

	// ç»Ÿè®¡ä¸­é—´ä»¶
	r.Use(func(c *gin.Context) {
		atomic.AddInt64(&activeConns, 1)
		defer atomic.AddInt64(&activeConns, -1)
		atomic.AddInt64(&requestCount, 1)
		c.Next()
	})

	// å¼‚æ­¥å¤„ç†ï¼šä¸é˜»å¡å½“å‰è¯·æ±‚çš„ Goroutine
	r.GET("/", func(c *gin.Context) {
		// åˆ›å»ºä»»åŠ¡
		task := Task{
			ResultChan: make(chan Result, 1),
		}

		// æäº¤åˆ°å·¥ä½œæ± ï¼ˆéé˜»å¡ï¼‰
		select {
		case taskQueue <- task:
			// ç­‰å¾…ç»“æœï¼ˆè¿™é‡Œä¼šé˜»å¡ï¼Œä½†å®é™…ä¸šåŠ¡å¯ä»¥ä¼˜åŒ–ä¸ºå®Œå…¨å¼‚æ­¥ï¼‰
			result := <-task.ResultChan
			c.JSON(http.StatusOK, result)
		default:
			// é˜Ÿåˆ—æ»¡äº†ï¼Œæ‹’ç»è¯·æ±‚
			c.JSON(http.StatusServiceUnavailable, gin.H{
				"error": "æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•",
			})
		}
	})

	// ç»Ÿè®¡æ¥å£
	r.GET("/stats", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"goroutines":     runtime.NumGoroutine(),
			"total_requests": atomic.LoadInt64(&requestCount),
			"active_conns":   atomic.LoadInt64(&activeConns),
			"worker_count":   workerCount,
			"queue_len":      len(taskQueue),
		})
	})

	fmt.Println("â”â”â”â”â”â”â”â” éé˜»å¡ I/O æœåŠ¡å™¨ (Gin + Worker Pool) â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ¯ æ¨¡å‹: å›ºå®š Worker æ± ï¼ˆç±»ä¼¼ NGINXï¼‰")
	fmt.Println("ğŸ“ ç«¯å£: 8002")
	fmt.Printf("ğŸ‘· Worker æ•°é‡: %d (å›ºå®š)\n", workerCount)
	fmt.Println("ğŸ“Š ç»Ÿè®¡: http://localhost:8002/stats")
	fmt.Println()

	r.Run(":8002")
}
```

**å…³é”®åŒºåˆ«**ï¼š
- **é˜»å¡ç‰ˆ (Gin é»˜è®¤)**ï¼š100 ä¸ªå¹¶å‘ = ~100 ä¸ª Goroutineï¼ˆåŠ¨æ€å¢é•¿ï¼‰
- **éé˜»å¡ç‰ˆ (Worker Pool)**ï¼š100 ä¸ªå¹¶å‘ = 10 ä¸ª Worker Goroutineï¼ˆå›ºå®šï¼‰+ è¯·æ±‚é˜Ÿåˆ—

**è®¾è®¡å¯¹åº”**ï¼š
```
Gin é˜»å¡æ¨¡å¼          â†’  Apache (æ¯ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹)
Gin Worker Pool æ¨¡å¼  â†’  NGINX (å›ºå®š Worker + äº‹ä»¶å¾ªç¯)
```

**æ­¥éª¤ 3**: ä½¿ç”¨ wrk è¿›è¡Œå‹åŠ›æµ‹è¯•

```bash
# å®‰è£… wrk
$ sudo apt install wrk  # Ubuntu/Debian
$ brew install wrk      # macOS

# ç»ˆç«¯ 1: å¯åŠ¨é˜»å¡æœåŠ¡å™¨
$ go run blocking_server.go

# ç»ˆç«¯ 2: å‹æµ‹é˜»å¡ç‰ˆ
$ wrk -t 4 -c 100 -d 30s http://localhost:8001/
# -t 4: 4ä¸ªçº¿ç¨‹
# -c 100: 100ä¸ªå¹¶å‘è¿æ¥
# -d 30s: æŒç»­30ç§’

# è®°å½•ç»“æœï¼šQPSã€å»¶è¿Ÿã€CPUä½¿ç”¨ç‡
```

```bash
# ç»ˆç«¯ 1: å¯åŠ¨éé˜»å¡æœåŠ¡å™¨
$ go run nonblocking_server.go

# ç»ˆç«¯ 2: å‹æµ‹éé˜»å¡ç‰ˆ
$ wrk -t 4 -c 100 -d 30s http://localhost:8002/
```

**æ­¥éª¤ 4**: ç›‘æ§èµ„æºä½¿ç”¨

```bash
# åœ¨å‹æµ‹æœŸé—´ï¼Œä½¿ç”¨å†…ç½®çš„ç»Ÿè®¡æ¥å£å®æ—¶ç›‘æ§

# ç›‘æ§é˜»å¡ç‰ˆ
$ watch -n 1 'curl -s http://localhost:8001/stats | jq'

# è¾“å‡ºç¤ºä¾‹ï¼š
{
  "active_conns": 98,        # å½“å‰æ´»è·ƒè¿æ¥
  "goroutines": 105,         # Goroutine æ•°é‡ â‰ˆ å¹¶å‘æ•°
  "total_requests": 15234    # æ€»è¯·æ±‚æ•°
}

# ç›‘æ§éé˜»å¡ç‰ˆï¼ˆWorker Poolï¼‰
$ watch -n 1 'curl -s http://localhost:8002/stats | jq'

# è¾“å‡ºç¤ºä¾‹ï¼š
{
  "active_conns": 95,        # å½“å‰æ´»è·ƒè¿æ¥
  "goroutines": 15,          # Goroutine æ•°é‡ = å›ºå®šï¼ˆ~10 workersï¼‰
  "queue_len": 5,            # é˜Ÿåˆ—é•¿åº¦
  "total_requests": 18567,   # æ€»è¯·æ±‚æ•°
  "worker_count": 10         # Worker æ•°é‡
}

# å…³é”®å¯¹æ¯”ï¼š
# - é˜»å¡ç‰ˆï¼šgoroutines â‰ˆ active_connsï¼ˆåŠ¨æ€å¢é•¿ï¼‰
# - Worker Pool ç‰ˆï¼šgoroutines æ’å®šä¸º ~10ï¼ˆå›ºå®šï¼‰
```

**ä½¿ç”¨ç³»ç»Ÿå·¥å…·ç›‘æ§**ï¼š
```bash
# macOS
$ top -pid $(pgrep -f blocking_server)

# Linux
$ top -p $(pgrep -f blocking_server)

# è§‚å¯Ÿ CPUã€å†…å­˜ã€çº¿ç¨‹æ•°
```

**æ­¥éª¤ 5**: å¯¹æ¯”ç»“æœ

æµ‹è¯•æ¡ä»¶ï¼š100 å¹¶å‘ï¼ŒæŒç»­ 30 ç§’ï¼Œæ¯ä¸ªè¯·æ±‚ 10ms å¤„ç†æ—¶é—´

| æŒ‡æ ‡            | Gin é»˜è®¤æ¨¡å¼ (é˜»å¡) | Gin Worker Pool (ç±» NGINX) | æ€§èƒ½æå‡ |
| --------------- | ------------------- | -------------------------- | -------- |
| **QPS**         | ~8,000              | ~9,500                     | **1.2x** |
| **P50 å»¶è¿Ÿ**    | ~12ms               | ~10ms                      | **1.2x** |
| **P99 å»¶è¿Ÿ**    | ~25ms               | ~15ms                      | **1.7x** |
| **Goroutine æ•°é‡** | ~105 (åŠ¨æ€)         | ~15 (å›ºå®š)                 | **7x** |
| **å†…å­˜å ç”¨**    | ~45MB               | ~25MB                      | **1.8x** |
| **CPU ä½¿ç”¨ç‡**  | 35%                 | 28%                        | **1.25x** |
| **é˜Ÿåˆ—ç§¯å‹**    | æ—                   | 0-10 ä¸ªä»»åŠ¡                | - |

**è¯¦ç»†åˆ†æ**:

### 1. **Gin é»˜è®¤æ¨¡å¼ï¼ˆé˜»å¡ I/Oï¼‰**
```go
// æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ Goroutine
r.GET("/", func(c *gin.Context) {
    time.Sleep(10ms)  // é˜»å¡å½“å‰ Goroutine
    c.JSON(...)
})
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼š
  - ä»£ç ç®€å•ç›´è§‚ï¼Œç¬¦åˆåŒæ­¥ç¼–ç¨‹æ€ç»´
  - Gin æ¡†æ¶é»˜è®¤æ¨¡å¼ï¼Œæ— éœ€é¢å¤–é…ç½®
  - é€‚åˆä½å¹¶å‘åœºæ™¯ï¼ˆ<1000 QPSï¼‰

- âŒ **ç¼ºç‚¹**ï¼š
  - Goroutine æ•°é‡ = æ´»è·ƒè¿æ¥æ•°ï¼ˆ100 å¹¶å‘ = ~100 Goroutinesï¼‰
  - ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€éšå¹¶å‘å¢é•¿
  - å†…å­˜å ç”¨çº¿æ€§å¢é•¿

**é€‚ç”¨åœºæ™¯**ï¼š
- å¾®æœåŠ¡ã€å†…éƒ¨ API
- å¹¶å‘é‡ < 1000 çš„ä¸šåŠ¡

---

### 2. **Worker Pool æ¨¡å¼ï¼ˆç±» NGINXï¼‰**
```go
// å›ºå®š Worker æ±  + ä»»åŠ¡é˜Ÿåˆ—
workerCount := 10
taskQueue := make(chan Task, 1000)

// 10 ä¸ª Worker å¹¶å‘å¤„ç†
for i := 0; i < 10; i++ {
    go worker(i)  // ç±»ä¼¼ NGINX worker_processes 10
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼š
  - Goroutine æ•°é‡å›ºå®šï¼ˆ10 workers + å‡ ä¸ªè¾…åŠ©ï¼‰
  - èµ„æºå¯é¢„æµ‹ã€å¯æ§åˆ¶
  - é˜Ÿåˆ—æœºåˆ¶ï¼šæµé‡è¶…è½½æ—¶æ’é˜Ÿï¼Œè€Œéå´©æºƒ
  - æ›´æ¥è¿‘ NGINX çš„è®¾è®¡ç†å¿µ

- âŒ **ç¼ºç‚¹**ï¼š
  - ä»£ç å¤æ‚åº¦å¢åŠ ï¼ˆéœ€è¦ç®¡ç†é˜Ÿåˆ—ã€Workerï¼‰
  - éœ€è¦è°ƒä¼˜ Worker æ•°é‡å’Œé˜Ÿåˆ—å¤§å°
  - æç«¯é«˜å¹¶å‘æ—¶é˜Ÿåˆ—å¯èƒ½ç§¯å‹

**é€‚ç”¨åœºæ™¯**ï¼š
- é«˜å¹¶å‘ API ç½‘å…³
- éœ€è¦é™æµ/è¿‡è½½ä¿æŠ¤çš„æœåŠ¡
- å¯¹èµ„æºä½¿ç”¨æœ‰ä¸¥æ ¼è¦æ±‚çš„åœºæ™¯

---

### 3. **æ¶æ„å¯¹åº”å…³ç³»**

| Go å®ç°         | å¯¹åº”æ¶æ„        | å¹¶å‘æ¨¡å‹               |
| --------------- | --------------- | ---------------------- |
| Gin é»˜è®¤        | Apache MPM      | æ¯è¯·æ±‚ä¸€ä¸ª Goroutine   |
| Worker Pool     | NGINX           | å›ºå®š Worker + äº‹ä»¶å¾ªç¯ |
| Go net/http     | Node.js (å•çº¿ç¨‹) | äº‹ä»¶é©±åŠ¨              |

---

### 4. **å…³é”®ç»“è®º**

> **ä¸ºä»€ä¹ˆ NGINX é‡‡ç”¨ Worker Pool æ¨¡å‹ï¼Ÿ**
>
> 1. **å¯é¢„æµ‹æ€§**ï¼šèµ„æºä½¿ç”¨å¯æ§ï¼ˆå†…å­˜ã€Goroutine æ•°é‡ï¼‰
> 2. **ç¨³å®šæ€§**ï¼šé¿å… Goroutine çˆ†ç‚¸å¯¼è‡´ç³»ç»Ÿå´©æºƒ
> 3. **æ€§èƒ½**ï¼šå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæé«˜ CPU ç¼“å­˜å‘½ä¸­ç‡
> 4. **è¿‡è½½ä¿æŠ¤**ï¼šé˜Ÿåˆ—æ»¡æ—¶æ‹’ç»è¯·æ±‚ï¼Œè€Œéæ‹–å®æ•´ä¸ªç³»ç»Ÿ

**å®æˆ˜å»ºè®®**ï¼š
- **ä½å¹¶å‘**ï¼ˆ< 1000 QPSï¼‰ï¼šGin é»˜è®¤æ¨¡å¼è¶³å¤Ÿ
- **ä¸­å¹¶å‘**ï¼ˆ1000-10000 QPSï¼‰ï¼šè€ƒè™‘ Worker Pool
- **é«˜å¹¶å‘**ï¼ˆ> 10000 QPSï¼‰ï¼šå‚è€ƒ NGINXï¼Œä½¿ç”¨ C/Rust + epoll

---

### 5. **å‹æµ‹æ—¶çš„è§‚å¯Ÿé‡ç‚¹**

```bash
# é˜»å¡ç‰ˆï¼šè§‚å¯Ÿ Goroutine æ•°é‡éšå¹¶å‘å¢é•¿
$ while true; do
    curl -s http://localhost:8001/stats | jq '.goroutines'
    sleep 1
done
# è¾“å‡ºï¼š5 â†’ 50 â†’ 100 â†’ 150ï¼ˆæŒç»­å¢é•¿ï¼‰

# Worker Pool ç‰ˆï¼šGoroutine æ•°é‡æ’å®š
$ while true; do
    curl -s http://localhost:8002/stats | jq '.goroutines'
    sleep 1
done
# è¾“å‡ºï¼š15 â†’ 15 â†’ 15 â†’ 15ï¼ˆç¨³å®šåœ¨ ~15ï¼‰
```

---

### å®éªŒäºŒï¼šNGINX Worker è¿›ç¨‹æ•°ä¼˜åŒ–å®éªŒ

#### ç›®æ ‡

æ‰¾åˆ°æœ€ä¼˜çš„ NGINX Worker è¿›ç¨‹æ•°é…ç½®ã€‚

#### å®éªŒæ­¥éª¤

**æ­¥éª¤ 1**: å‡†å¤‡æµ‹è¯•è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `test_worker_count.sh`:

```bash
#!/bin/bash

# æµ‹è¯•ä¸åŒ worker æ•°é‡çš„æ€§èƒ½
WORKER_COUNTS=(1 2 4 8 16)
DURATION=30
CONNECTIONS=1000

for workers in "${WORKER_COUNTS[@]}"; do
    echo "=== æµ‹è¯• worker_processes $workers ==="

    # ä¿®æ”¹ NGINX é…ç½®
    sudo sed -i "s/worker_processes.*/worker_processes $workers;/" /etc/nginx/nginx.conf

    # é‡è½½é…ç½®
    sudo nginx -s reload
    sleep 2

    # å‹æµ‹
    wrk -t 4 -c $CONNECTIONS -d ${DURATION}s http://localhost/ > result_${workers}_workers.txt

    # ç›‘æ§ CPU
    pidstat -p $(pgrep nginx | grep -v master) 1 10 > cpu_${workers}_workers.txt &

    sleep 1
done

echo "æµ‹è¯•å®Œæˆï¼"
```

**æ­¥éª¤ 2**: è¿è¡Œå®éªŒ

```bash
$ chmod +x test_worker_count.sh
$ ./test_worker_count.sh
```

**æ­¥éª¤ 3**: åˆ†æç»“æœ

```bash
# æå– QPS
$ grep "Requests/sec" result_*_workers.txt

# æå– P99 å»¶è¿Ÿ
$ grep "99%" result_*_workers.txt

# æŸ¥çœ‹ CPU ä½¿ç”¨ç‡
$ cat cpu_*_workers.txt
```

**æ­¥éª¤ 4**: ç»˜åˆ¶æ€§èƒ½æ›²çº¿

```python
import matplotlib.pyplot as plt

workers = [1, 2, 4, 8, 16]
qps = [?, ?, ?, ?, ?]  # å¡«å…¥å®é™…ç»“æœ
latency_p99 = [?, ?, ?, ?, ?]

fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 4))

ax1.plot(workers, qps, marker='o')
ax1.set_xlabel('Worker è¿›ç¨‹æ•°')
ax1.set_ylabel('QPS')
ax1.set_title('QPS vs Worker æ•°é‡')
ax1.grid(True)

ax2.plot(workers, latency_p99, marker='o', color='red')
ax2.set_xlabel('Worker è¿›ç¨‹æ•°')
ax2.set_ylabel('P99 å»¶è¿Ÿ (ms)')
ax2.set_title('å»¶è¿Ÿ vs Worker æ•°é‡')
ax2.grid(True)

plt.tight_layout()
plt.savefig('worker_optimization.png')
print("å›¾è¡¨å·²ä¿å­˜åˆ° worker_optimization.png")
```

**é¢„æœŸå‘ç°**:

- Worker = CPU æ ¸å¿ƒæ•°æ—¶ï¼ŒQPS æœ€é«˜
- Worker > CPU æ ¸å¿ƒæ•°æ—¶ï¼Œæ€§èƒ½ä¸‹é™ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰
- Worker < CPU æ ¸å¿ƒæ•°æ—¶ï¼ŒCPU æœªå……åˆ†åˆ©ç”¨

---

### å®éªŒä¸‰ï¼šæœ¬åœ°æ­å»º 3 ä¸ªåç«¯ + NGINX è´Ÿè½½å‡è¡¡å®éªŒ

#### ç›®æ ‡

å®é™…é…ç½® NGINX è´Ÿè½½å‡è¡¡ï¼Œè§‚å¯Ÿä¸åŒç®—æ³•çš„æµé‡åˆ†å¸ƒã€‚

#### å®éªŒæ­¥éª¤

**æ­¥éª¤ 1**: å¯åŠ¨ 3 ä¸ªåç«¯æœåŠ¡å™¨

åˆ›å»º `backend1.py`:

```python
#!/usr/bin/env python3
from flask import Flask
import socket

app = Flask(__name__)
hostname = socket.gethostname()

@app.route('/')
def index():
    return f"Backend 1 ({hostname}:5001)"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001)
```

åˆ›å»º `backend2.py` å’Œ `backend3.py`ï¼ˆä¿®æ”¹ç«¯å£å·å’Œåç§°ï¼‰ã€‚

```bash
# å¯åŠ¨ä¸‰ä¸ªåç«¯
$ python3 backend1.py &
$ python3 backend2.py &
$ python3 backend3.py &
```

**æ­¥éª¤ 2**: é…ç½® NGINX è´Ÿè½½å‡è¡¡

ç¼–è¾‘ `/etc/nginx/nginx.conf`:

```nginx
http {
    # å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
    upstream backend {
        # æµ‹è¯•ä¸åŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•
        # least_conn;  # æœ€å°‘è¿æ¥
        # ip_hash;     # IP å“ˆå¸Œ
        # round-robinï¼ˆé»˜è®¤ï¼‰

        server 127.0.0.1:5001 weight=1;
        server 127.0.0.1:5002 weight=2;  # æƒé‡ä¸º 2
        server 127.0.0.1:5003 weight=1;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # æ·»åŠ å“åº”å¤´ï¼Œæ˜¾ç¤ºæ˜¯å“ªä¸ªåç«¯å¤„ç†çš„
            add_header X-Backend-Server $upstream_addr;
        }
    }
}
```

**æ­¥éª¤ 3**: æµ‹è¯• Round Robin ç®—æ³•

```bash
# å‘é€ 12 æ¬¡è¯·æ±‚ï¼Œè§‚å¯Ÿåˆ†å¸ƒ
$ for i in {1..12}; do
    curl -s http://localhost/ && echo
done

# é¢„æœŸè¾“å‡ºï¼ˆæƒé‡ 1:2:1ï¼‰:
# Backend 1
# Backend 2
# Backend 2
# Backend 3
# Backend 1
# Backend 2
# Backend 2
# Backend 3
# ...
```

**æ­¥éª¤ 4**: æµ‹è¯• Least Connections ç®—æ³•

ä¿®æ”¹ `upstream` é…ç½®ï¼š

```nginx
upstream backend {
    least_conn;
    server 127.0.0.1:5001;
    server 127.0.0.1:5002;
    server 127.0.0.1:5003;
}
```

```bash
# é‡è½½é…ç½®
$ sudo nginx -s reload

# ä½¿ç”¨ ab å¹¶å‘æµ‹è¯•
$ ab -n 1000 -c 100 http://localhost/
```

**æ­¥éª¤ 5**: è§‚å¯Ÿæµé‡åˆ†å¸ƒ

åˆ›å»ºç›‘æ§è„šæœ¬ `monitor_backends.sh`:

```bash
#!/bin/bash

echo "ç›‘æ§åç«¯è¯·æ±‚æ•°ï¼ˆæŒ‰ Ctrl+C åœæ­¢ï¼‰"
echo "æ—¶é—´        Backend1   Backend2   Backend3"
echo "----------------------------------------"

while true; do
    count1=$(curl -s http://localhost:5001/stats 2>/dev/null | grep -o 'requests: [0-9]*' | cut -d' ' -f2)
    count2=$(curl -s http://localhost:5002/stats 2>/dev/null | grep -o 'requests: [0-9]*' | cut -d' ' -f2)
    count3=$(curl -s http://localhost:5003/stats 2>/dev/null | grep -o 'requests: [0-9]*' | cut -d' ' -f2)

    echo "$(date +%H:%M:%S)   $count1          $count2          $count3"
    sleep 1
done
```

**æ­¥éª¤ 6**: æµ‹è¯• IP Hash ç®—æ³•

```nginx
upstream backend {
    ip_hash;
    server 127.0.0.1:5001;
    server 127.0.0.1:5002;
    server 127.0.0.1:5003;
}
```

```bash
# é‡è½½å¹¶æµ‹è¯•
$ sudo nginx -s reload

# åŒä¸€ä¸ª IP çš„å¤šæ¬¡è¯·æ±‚åº”è¯¥è·¯ç”±åˆ°åŒä¸€ä¸ªåç«¯
$ for i in {1..10}; do curl -s http://localhost/; done
```

**æ­¥éª¤ 7**: æ¨¡æ‹Ÿåç«¯æ•…éšœ

```bash
# åœæ­¢ backend2
$ kill $(pgrep -f backend2)

# å‘é€è¯·æ±‚ï¼Œè§‚å¯Ÿ NGINX å¦‚ä½•å¤„ç†
$ for i in {1..20}; do
    curl -s http://localhost/ && echo
done

# NGINX ä¼šè‡ªåŠ¨å°†æµé‡åˆ†é…åˆ°å¥åº·çš„åç«¯
```

**æ­¥éª¤ 8**: å¯ç”¨å¥åº·æ£€æŸ¥ï¼ˆéœ€è¦ NGINX Plus æˆ– nginx-module-upstream-checkï¼‰

å¼€æºç‰ˆæ›¿ä»£æ–¹æ¡ˆï¼š

```nginx
upstream backend {
    server 127.0.0.1:5001 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:5002 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:5003 max_fails=3 fail_timeout=30s;
}
```

- `max_fails=3`: å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨
- `fail_timeout=30s`: 30 ç§’åé‡æ–°å°è¯•

---

## Part 8: è´Ÿè½½å‡è¡¡å™¨é¡¹ç›®çš„ NGINX æ¶æ„å¯å‘è®¾è®¡

### 8.1 é¡¹ç›®æ¶æ„è®¾è®¡

åŸºäº NGINX çš„è®¾è®¡ç†å¿µï¼Œè®¾è®¡ä¸€ä¸ªç”Ÿäº§çº§è´Ÿè½½å‡è¡¡å™¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Master Process                        â”‚
â”‚  - è¯»å–é…ç½®                                              â”‚
â”‚  - åˆ›å»º Worker Processes                                 â”‚
â”‚  - å¤„ç†ä¿¡å·ï¼ˆreloadã€stopã€upgradeï¼‰                     â”‚
â”‚  - ç›‘æ§ Worker å¥åº·çŠ¶æ€                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚               â”‚               â”‚
   Worker 1        Worker 2        Worker 3       Worker N
   (CPU 0)         (CPU 1)         (CPU 2)       (CPU N-1)
       â”‚               â”‚               â”‚               â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”Œâ”€â”€â”€â”´â”€â”€â”€â”     â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚ epoll â”‚       â”‚ epoll â”‚       â”‚ epoll â”‚     â”‚ epoll â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚               â”‚               â”‚               â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
   â”‚           Shared Memory (é…ç½®ã€ç»Ÿè®¡ã€ç¼“å­˜)           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å®Œæ•´ Go å®ç°ï¼ˆç”Ÿäº§çº§ï¼‰

åˆ›å»ºé¡¹ç›®ç»“æ„ï¼š

```bash
$ mkdir -p lb-project/{cmd/lb,internal/{worker,master,config,algorithm,health},pkg/{stats,pool}}
```

**æ ¸å¿ƒä»£ç ï¼š`cmd/lb/main.go`**

```go
package main

import (
    "context"
    "flag"
    "fmt"
    "log"
    "os"
    "os/signal"
    "runtime"
    "syscall"

    "lb-project/internal/config"
    "lb-project/internal/master"
)

var (
    configFile = flag.String("c", "lb.yaml", "é…ç½®æ–‡ä»¶è·¯å¾„")
    workers    = flag.Int("w", 0, "Worker æ•°é‡ï¼ˆ0=è‡ªåŠ¨æ£€æµ‹ï¼‰")
)

func main() {
    flag.Parse()

    // åŠ è½½é…ç½®
    cfg, err := config.Load(*configFile)
    if err != nil {
        log.Fatalf("åŠ è½½é…ç½®å¤±è´¥: %v", err)
    }

    // è®¾ç½® Worker æ•°é‡
    if *workers == 0 {
        *workers = runtime.NumCPU()
    }
    cfg.WorkerCount = *workers

    fmt.Printf("ğŸš€ è´Ÿè½½å‡è¡¡å™¨å¯åŠ¨ä¸­...\n")
    fmt.Printf("ğŸ“Š é…ç½®: %d Workers, ç®—æ³•=%s\n", cfg.WorkerCount, cfg.Algorithm)

    // åˆ›å»º Master è¿›ç¨‹
    m := master.New(cfg)

    // å¯åŠ¨
    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()

    if err := m.Start(ctx); err != nil {
        log.Fatalf("å¯åŠ¨å¤±è´¥: %v", err)
    }

    // ç­‰å¾…ä¿¡å·
    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM, syscall.SIGHUP)

    for sig := range sigChan {
        switch sig {
        case syscall.SIGHUP:
            fmt.Println("ğŸ“ æ”¶åˆ° SIGHUPï¼Œé‡è½½é…ç½®...")
            if err := m.Reload(); err != nil {
                log.Printf("é‡è½½å¤±è´¥: %v", err)
            }
        case syscall.SIGINT, syscall.SIGTERM:
            fmt.Println("ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œä¼˜é›…å…³é—­...")
            m.Shutdown(ctx)
            return
        }
    }
}
```

**Master è¿›ç¨‹ï¼š`internal/master/master.go`**

```go
package master

import (
    "context"
    "fmt"
    "runtime"
    "sync"

    "lb-project/internal/config"
    "lb-project/internal/worker"
)

type Master struct {
    cfg      *config.Config
    workers  []*worker.Worker
    mu       sync.RWMutex
    stopChan chan struct{}
}

func New(cfg *config.Config) *Master {
    return &Master{
        cfg:      cfg,
        workers:  make([]*worker.Worker, 0, cfg.WorkerCount),
        stopChan: make(chan struct{}),
    }
}

func (m *Master) Start(ctx context.Context) error {
    // åˆ›å»ºå¹¶å¯åŠ¨ Workers
    for i := 0; i < m.cfg.WorkerCount; i++ {
        w := worker.New(i, m.cfg)

        // è®¾ç½® CPU äº²å’Œæ€§ï¼ˆå¯é€‰ï¼‰
        if m.cfg.CPUAffinity {
            runtime.LockOSThread()
        }

        if err := w.Start(ctx); err != nil {
            return fmt.Errorf("å¯åŠ¨ Worker %d å¤±è´¥: %w", i, err)
        }

        m.workers = append(m.workers, w)
        fmt.Printf("âœ… Worker %d å·²å¯åŠ¨\n", i)
    }

    return nil
}

func (m *Master) Reload() error {
    // åŠ è½½æ–°é…ç½®
    newCfg, err := config.Load(m.cfg.ConfigPath)
    if err != nil {
        return err
    }

    // åˆ›å»ºæ–° Workers
    newWorkers := make([]*worker.Worker, 0, newCfg.WorkerCount)
    ctx := context.Background()

    for i := 0; i < newCfg.WorkerCount; i++ {
        w := worker.New(i, newCfg)
        if err := w.Start(ctx); err != nil {
            return err
        }
        newWorkers = append(newWorkers, w)
    }

    // ç­‰å¾…æ—§ Workers ä¼˜é›…å…³é—­
    m.mu.Lock()
    oldWorkers := m.workers
    m.workers = newWorkers
    m.cfg = newCfg
    m.mu.Unlock()

    for _, w := range oldWorkers {
        w.GracefulShutdown()
    }

    return nil
}

func (m *Master) Shutdown(ctx context.Context) {
    close(m.stopChan)

    m.mu.RLock()
    defer m.mu.RUnlock()

    for _, w := range m.workers {
        w.Shutdown()
    }
}
```

**Worker è¿›ç¨‹ï¼š`internal/worker/worker.go`**

```go
package worker

import (
    "context"
    "fmt"
    "net"
    "sync"
    "sync/atomic"
    "time"

    "lb-project/internal/algorithm"
    "lb-project/internal/config"
    "lb-project/pkg/pool"
)

type Worker struct {
    id          int
    cfg         *config.Config
    algorithm   algorithm.LoadBalancer
    connPool    *pool.ConnectionPool
    activeConns int64
    stopChan    chan struct{}
    wg          sync.WaitGroup
}

func New(id int, cfg *config.Config) *Worker {
    // é€‰æ‹©è´Ÿè½½å‡è¡¡ç®—æ³•
    algo := algorithm.New(cfg.Algorithm, cfg.Backends)

    return &Worker{
        id:       id,
        cfg:      cfg,
        algorithm: algo,
        connPool: pool.NewConnectionPool(cfg.Backends),
        stopChan: make(chan struct{}),
    }
}

func (w *Worker) Start(ctx context.Context) error {
    // ç›‘å¬ç«¯å£ï¼ˆä½¿ç”¨ SO_REUSEPORTï¼‰
    lc := net.ListenConfig{
        Control: reusePort,  // å…è®¸å¤šä¸ªè¿›ç¨‹ç›‘å¬åŒä¸€ç«¯å£
    }

    listener, err := lc.Listen(ctx, "tcp", w.cfg.ListenAddr)
    if err != nil {
        return err
    }

    w.wg.Add(1)
    go w.acceptLoop(listener)

    return nil
}

func (w *Worker) acceptLoop(listener net.Listener) {
    defer w.wg.Done()

    // äº‹ä»¶å¾ªç¯
    for {
        select {
        case <-w.stopChan:
            listener.Close()
            return
        default:
            // è®¾ç½® accept è¶…æ—¶ï¼ˆé¿å…é˜»å¡åœ¨ shutdownï¼‰
            listener.(*net.TCPListener).SetDeadline(time.Now().Add(1 * time.Second))

            conn, err := listener.Accept()
            if err != nil {
                if netErr, ok := err.(net.Error); ok && netErr.Timeout() {
                    continue  // è¶…æ—¶ï¼Œç»§ç»­å¾ªç¯
                }
                continue
            }

            // å¤„ç†è¿æ¥ï¼ˆéé˜»å¡ï¼‰
            w.wg.Add(1)
            go w.handleConnection(conn)
        }
    }
}

func (w *Worker) handleConnection(clientConn net.Conn) {
    defer w.wg.Done()
    defer clientConn.Close()

    atomic.AddInt64(&w.activeConns, 1)
    defer atomic.AddInt64(&w.activeConns, -1)

    // é€‰æ‹©åç«¯æœåŠ¡å™¨
    backend := w.algorithm.Select()
    if backend == nil {
        return  // æ— å¯ç”¨åç«¯
    }

    // ä»è¿æ¥æ± è·å–è¿æ¥
    backendConn, err := w.connPool.Get(backend.Addr)
    if err != nil {
        return
    }
    defer w.connPool.Put(backend.Addr, backendConn)

    // åŒå‘ä»£ç†
    w.proxy(clientConn, backendConn)
}

func (w *Worker) proxy(client, backend net.Conn) {
    var wg sync.WaitGroup
    wg.Add(2)

    // å®¢æˆ·ç«¯ -> åç«¯
    go func() {
        defer wg.Done()
        io.Copy(backend, client)
        backend.(*net.TCPConn).CloseWrite()
    }()

    // åç«¯ -> å®¢æˆ·ç«¯
    go func() {
        defer wg.Done()
        io.Copy(client, backend)
        client.(*net.TCPConn).CloseWrite()
    }()

    wg.Wait()
}

func (w *Worker) GracefulShutdown() {
    close(w.stopChan)

    // ç­‰å¾…æ‰€æœ‰è¿æ¥å®Œæˆï¼ˆæœ€å¤š 30 ç§’ï¼‰
    done := make(chan struct{})
    go func() {
        w.wg.Wait()
        close(done)
    }()

    select {
    case <-done:
        fmt.Printf("Worker %d å·²ä¼˜é›…å…³é—­\n", w.id)
    case <-time.After(30 * time.Second):
        fmt.Printf("Worker %d å¼ºåˆ¶å…³é—­ï¼ˆè¶…æ—¶ï¼‰\n", w.id)
    }
}

func (w *Worker) Shutdown() {
    close(w.stopChan)
}

// SO_REUSEPORT æ”¯æŒï¼ˆLinux 3.9+ï¼‰
func reusePort(network, address string, c syscall.RawConn) error {
    var err error
    c.Control(func(fd uintptr) {
        err = syscall.SetsockoptInt(int(fd), syscall.SOL_SOCKET, syscall.SO_REUSEPORT, 1)
    })
    return err
}
```

**è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š`internal/algorithm/round_robin.go`**

```go
package algorithm

import (
    "sync/atomic"

    "lb-project/internal/config"
)

type RoundRobin struct {
    backends []*config.Backend
    current  uint32
}

func NewRoundRobin(backends []*config.Backend) *RoundRobin {
    return &RoundRobin{
        backends: backends,
    }
}

func (rr *RoundRobin) Select() *config.Backend {
    n := atomic.AddUint32(&rr.current, 1)
    return rr.backends[(int(n)-1)%len(rr.backends)]
}

// åŠ æƒè½®è¯¢
type WeightedRoundRobin struct {
    backends []*config.Backend
    weights  []int
    current  int
    gcd      int
    maxWeight int
    mu       sync.Mutex
}

func (wrr *WeightedRoundRobin) Select() *config.Backend {
    wrr.mu.Lock()
    defer wrr.mu.Unlock()

    for {
        wrr.current = (wrr.current + 1) % len(wrr.backends)

        if wrr.current == 0 {
            wrr.currentWeight -= wrr.gcd
            if wrr.currentWeight <= 0 {
                wrr.currentWeight = wrr.maxWeight
            }
        }

        if wrr.backends[wrr.current].Weight >= wrr.currentWeight {
            return wrr.backends[wrr.current]
        }
    }
}
```

### 8.3 é…ç½®æ–‡ä»¶ç¤ºä¾‹

`lb.yaml`:

```yaml
listen: "0.0.0.0:80"
worker_count: 4
cpu_affinity: true
algorithm: "weighted_round_robin"

backends:
  - addr: "127.0.0.1:5001"
    weight: 1
  - addr: "127.0.0.1:5002"
    weight: 2
  - addr: "127.0.0.1:5003"
    weight: 1

health_check:
  enabled: true
  interval: 5s
  timeout: 2s
  path: "/health"

connection_pool:
  max_idle: 100
  max_active: 1000
```

### 8.4 æ€§èƒ½æµ‹è¯•

```bash
# ç¼–è¯‘
$ go build -o lb cmd/lb/main.go

# è¿è¡Œ
$ ./lb -c lb.yaml

# å‹æµ‹
$ wrk -t 4 -c 1000 -d 30s http://localhost/

# é¢„æœŸç»“æœ
Running 30s test @ http://localhost/
  4 threads and 1000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.15ms    1.23ms  50.00ms   89.34%
    Req/Sec    60.25k     5.12k   75.00k    68.00%
  7200000 requests in 30.00s, 1.20GB read
Requests/sec: 240000.00
Transfer/sec:   40.00MB
```

---

## æ€»ç»“ä¸å­¦ä¹ æ£€æŸ¥

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

1. **äº‹ä»¶é©±åŠ¨æ¶æ„** âœ“

   - äº‹ä»¶å¾ªç¯ + epoll
   - éé˜»å¡ I/O
   - çŠ¶æ€æœºè®¾è®¡
2. **Master-Worker æ¨¡å‹** âœ“

   - è¿›ç¨‹åˆ†ç¦»
   - Worker = CPU æ ¸å¿ƒæ•°
   - CPU äº²å’Œæ€§
3. **æ€§èƒ½ä¼˜åŒ–** âœ“

   - å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
   - è¿æ¥æ± å¤ç”¨
   - é›¶æ‹·è´
4. **ä¼˜é›…ç®¡ç†** âœ“

   - é…ç½®çƒ­é‡è½½
   - ä¼˜é›…å…³é—­
   - é›¶åœæœºå‡çº§

### è‡ªæµ‹é¢˜

1. **epoll ç›¸æ¯” select çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ**

   <details><summary>ç­”æ¡ˆ</summary>
   - O(æ´»è·ƒè¿æ¥) vs O(æ€»è¿æ¥)
   - æ—  1024 é™åˆ¶
   - ä¸éœ€è¦æ¯æ¬¡ä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€
   </details>
2. **ä¸ºä»€ä¹ˆ NGINX Worker æ•°é‡é€šå¸¸ç­‰äº CPU æ ¸å¿ƒæ•°ï¼Ÿ**

   <details><summary>ç­”æ¡ˆ</summary>
   - é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢
   - æœ€å¤§åŒ– CPU ç¼“å­˜å‘½ä¸­ç‡
   - æ¯ä¸ª Worker æ˜¯ CPU å¯†é›†å‹çš„äº‹ä»¶å¾ªç¯
   </details>
3. **ä»€ä¹ˆæ˜¯ä¼˜é›…å…³é—­ï¼ˆGraceful Shutdownï¼‰ï¼Ÿ**

   <details><summary>ç­”æ¡ˆ</summary>
   - åœæ­¢æ¥å—æ–°è¿æ¥
   - å®Œæˆè¿›è¡Œä¸­çš„è¯·æ±‚
   - ä¸ä¸¢å¤±ä»»ä½•æ•°æ®
   - ç»™å®šè¶…æ—¶æ—¶é—´åå¼ºåˆ¶å…³é—­
   </details>

### ä¸‹ä¸€æ­¥å­¦ä¹ 

- [ ] é˜…è¯» NGINX æºç ï¼ˆå»ºè®® 10 å°æ—¶ï¼‰
- [ ] å®Œæˆä¸‰ä¸ªå®éªŒï¼ˆé¢„è®¡ 4-6 å°æ—¶ï¼‰
- [ ] å®ç°è‡ªå·±çš„è´Ÿè½½å‡è¡¡å™¨ï¼ˆé¢„è®¡ 20 å°æ—¶ï¼‰
- [ ] é˜…è¯» HAProxy é…ç½®æ‰‹å†Œ
- [ ] ç ”ç©¶ envoy çš„ç°ä»£æ¶æ„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 å®Œæ•´ç‰ˆ
**æœ€åæ›´æ–°**: 2025-10-23
**é€‚ç”¨è¯¾ç¨‹å‘¨æ¬¡**: Week 1
**é¢„è®¡å­¦ä¹ æ—¶é—´**: 8-10 å°æ—¶ï¼ˆå«å®éªŒï¼‰
