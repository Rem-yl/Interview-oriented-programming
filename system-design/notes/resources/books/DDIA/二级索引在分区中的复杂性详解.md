# äºŒçº§ç´¢å¼•åœ¨åˆ†åŒºä¸­çš„å¤æ‚æ€§è¯¦è§£

> åŸºäº DDIA Chapter 6: Partitioning - Secondary Indexes

## ç›®å½•

1. [ä»€ä¹ˆæ˜¯äºŒçº§ç´¢å¼•](#ä»€ä¹ˆæ˜¯äºŒçº§ç´¢å¼•)
2. [ä¸»é”®ç´¢å¼• vs äºŒçº§ç´¢å¼•](#ä¸»é”®ç´¢å¼•-vs-äºŒçº§ç´¢å¼•)
3. [ä¸ºä»€ä¹ˆåˆ†åŒº+äºŒçº§ç´¢å¼•ä¼šå¤æ‚](#ä¸ºä»€ä¹ˆåˆ†åŒºäºŒçº§ç´¢å¼•ä¼šå¤æ‚)
4. [ä¸¤ç§åˆ†åŒºäºŒçº§ç´¢å¼•æ–¹æ¡ˆ](#ä¸¤ç§åˆ†åŒºäºŒçº§ç´¢å¼•æ–¹æ¡ˆ)
5. [å®é™…æ¡ˆä¾‹åˆ†æ](#å®é™…æ¡ˆä¾‹åˆ†æ)

---

## ä»€ä¹ˆæ˜¯äºŒçº§ç´¢å¼•

### é€šä¿—è§£é‡Š

æŠŠæ•°æ®åº“æƒ³è±¡æˆä¸€æœ¬ä¹¦ï¼š

- **ä¸»é”®ç´¢å¼•** = é¡µç  (ç›´æ¥å®šä½åˆ°æŸä¸€é¡µ)
- **äºŒçº§ç´¢å¼•** = ä¹¦åçš„ä¸»é¢˜ç´¢å¼• (æŒ‰ä¸»é¢˜æŸ¥æ‰¾ï¼Œç„¶åå‘Šè¯‰ä½ åœ¨å“ªå‡ é¡µ)

### æ•°æ®åº“å®šä¹‰

**ä¸»é”®ç´¢å¼• (Primary Index)**:
- åŸºäºä¸»é”®(Primary Key)å»ºç«‹çš„ç´¢å¼•
- æ¯æ¡è®°å½•åªæœ‰ä¸€ä¸ªä¸»é”®
- ä¸»é”®å”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½•

**äºŒçº§ç´¢å¼• (Secondary Index)**:
- åŸºäºéä¸»é”®å­—æ®µå»ºç«‹çš„ç´¢å¼•
- ä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªäºŒçº§ç´¢å¼•
- å…è®¸ä»ä¸åŒç»´åº¦æŸ¥è¯¢æ•°æ®

---

## ä¸»é”®ç´¢å¼• vs äºŒçº§ç´¢å¼•

### ç¤ºä¾‹: ç”¨æˆ·è¡¨

```sql
CREATE TABLE users (
    user_id INT PRIMARY KEY,        -- ä¸»é”®
    username VARCHAR(50),
    email VARCHAR(100),
    age INT,
    city VARCHAR(50)
);

-- äºŒçº§ç´¢å¼•
CREATE INDEX idx_email ON users(email);
CREATE INDEX idx_city ON users(city);
CREATE INDEX idx_age ON users(age);
```

### æŸ¥è¯¢å¯¹æ¯”

#### ä½¿ç”¨ä¸»é”®æŸ¥è¯¢ (ç®€å•)

```sql
SELECT * FROM users WHERE user_id = 12345;
```

**æŸ¥è¯¢è·¯å¾„**:
```
user_id=12345 â†’ ä¸»é”®ç´¢å¼• â†’ ç›´æ¥æ‰¾åˆ°è®°å½•
```

**ç‰¹ç‚¹**:
- âœ… ä¸€å¯¹ä¸€æ˜ å°„
- âœ… æŸ¥è¯¢è·¯å¾„ç¡®å®š
- âœ… æ€§èƒ½é«˜

---

#### ä½¿ç”¨äºŒçº§ç´¢å¼•æŸ¥è¯¢ (å¤æ‚)

```sql
SELECT * FROM users WHERE email = 'alice@example.com';
```

**æŸ¥è¯¢è·¯å¾„**:
```
email='alice@example.com'
  â†’ äºŒçº§ç´¢å¼•(email)
  â†’ æ‰¾åˆ° user_id=12345
  â†’ ä¸»é”®ç´¢å¼•
  â†’ è·å–å®Œæ•´è®°å½•
```

**ç‰¹ç‚¹**:
- âš ï¸ éœ€è¦ä¸¤æ¬¡æŸ¥æ‰¾ (å›è¡¨æŸ¥è¯¢)
- âš ï¸ ä¸€ä¸ªemailå¯èƒ½å¯¹åº”å¤šä¸ªuser_id
- âš ï¸ æ€§èƒ½æ¯”ä¸»é”®æŸ¥è¯¢ä½

---

### æ•°æ®ç»“æ„å¯¹æ¯”

#### ä¸»é”®ç´¢å¼•

```
B+Tree (user_id â†’ å®Œæ•´è®°å½•)

        [100]
       /     \
    [50]     [150]
    /  \      /  \
  10  80   120  180
  |   |     |    |
  æ•°æ® æ•°æ®  æ•°æ®  æ•°æ®
```

#### äºŒçº§ç´¢å¼• (email)

```
B+Tree (email â†’ user_id)

        ['m@...']
       /         \
   ['a@...']   ['z@...']
      |            |
   user_id=10   user_id=99
      â†“            â†“
   å†æŸ¥ä¸»é”®ç´¢å¼•è·å–å®Œæ•´è®°å½•
```

---

## ä¸ºä»€ä¹ˆåˆ†åŒº+äºŒçº§ç´¢å¼•ä¼šå¤æ‚

### åœºæ™¯: ä¸åˆ†åŒºçš„æƒ…å†µ (ç®€å•)

**å•æœºæ•°æ®åº“**:

```
æ‰€æœ‰æ•°æ®åœ¨ä¸€å°æœºå™¨ä¸Š
ç”¨æˆ·è¡¨: 100ä¸‡æ¡è®°å½•
emailç´¢å¼•: 100ä¸‡ä¸ªæ¡ç›®

æŸ¥è¯¢: SELECT * FROM users WHERE email = 'alice@example.com'
è·¯å¾„: emailç´¢å¼• â†’ user_id â†’ ä¸»é”®ç´¢å¼• â†’ è®°å½•
æ€§èƒ½: 1æ¬¡ç£ç›˜æŸ¥æ‰¾ + 1æ¬¡å›è¡¨
```

**ç®€å•åŸå› **: æ‰€æœ‰ç´¢å¼•å’Œæ•°æ®éƒ½åœ¨ä¸€èµ·

---

### åœºæ™¯: åˆ†åŒºåçš„æƒ…å†µ (å¤æ‚)

å‡è®¾æ•°æ®æŒ‰ `user_id` å“ˆå¸Œåˆ†åŒºåˆ°3å°æœºå™¨:

```
åˆ†åŒº0 (Node A): user_id % 3 = 0
  - user_id=3, email='alice@example.com', city='Beijing'
  - user_id=6, email='bob@example.com', city='Shanghai'
  - user_id=9, email='charlie@example.com', city='Beijing'

åˆ†åŒº1 (Node B): user_id % 3 = 1
  - user_id=1, email='david@example.com', city='Beijing'
  - user_id=4, email='eve@example.com', city='Shanghai'
  - user_id=7, email='frank@example.com', city='Beijing'

åˆ†åŒº2 (Node C): user_id % 3 = 2
  - user_id=2, email='grace@example.com', city='Beijing'
  - user_id=5, email='henry@example.com', city='Shanghai'
  - user_id=8, email='iris@example.com', city='Beijing'
```

---

### é—®é¢˜1: æŒ‰ä¸»é”®æŸ¥è¯¢ (ä»ç„¶ç®€å•)

```sql
SELECT * FROM users WHERE user_id = 5;
```

**æŸ¥è¯¢è·¯å¾„**:
```
1. è®¡ç®—åˆ†åŒº: 5 % 3 = 2
2. è·¯ç”±åˆ° Node C
3. åœ¨ Node C ä¸ŠæŸ¥è¯¢
```

**ç‰¹ç‚¹**: âœ… åªéœ€è®¿é—®1ä¸ªèŠ‚ç‚¹

---

### é—®é¢˜2: æŒ‰äºŒçº§ç´¢å¼•æŸ¥è¯¢ (å˜å¾—å¤æ‚!)

```sql
SELECT * FROM users WHERE email = 'alice@example.com';
```

**é—®é¢˜**: ä¸çŸ¥é“ `alice@example.com` åœ¨å“ªä¸ªåˆ†åŒº!

**åŸå› **: æ•°æ®æ˜¯æŒ‰ `user_id` åˆ†åŒºçš„ï¼Œä¸æ˜¯æŒ‰ `email` åˆ†åŒºçš„

**å¿…é¡»**:
```
æŸ¥è¯¢æ‰€æœ‰3ä¸ªèŠ‚ç‚¹
  â†’ Node A æŸ¥ email='alice@example.com'
  â†’ Node B æŸ¥ email='alice@example.com'
  â†’ Node C æŸ¥ email='alice@example.com'
  â†’ æ±‡æ€»ç»“æœ
```

**ç‰¹ç‚¹**: âŒ éœ€è¦è®¿é—®**æ‰€æœ‰èŠ‚ç‚¹** (scatter-gather)

---

### é—®é¢˜3: æŒ‰éåˆ†åŒºé”®çš„èŒƒå›´æŸ¥è¯¢ (æ›´å¤æ‚!)

```sql
SELECT * FROM users WHERE city = 'Beijing';
```

**é—®é¢˜**:
- `city='Beijing'` çš„ç”¨æˆ·åˆ†æ•£åœ¨æ‰€æœ‰åˆ†åŒºä¸­
- æ— æ³•é€šè¿‡åˆ†åŒºé”®å®šä½

**å¿…é¡»**:
```
æŸ¥è¯¢æ‰€æœ‰3ä¸ªèŠ‚ç‚¹
  â†’ Node A: æ‰¾åˆ° user_id=3,9 (city='Beijing')
  â†’ Node B: æ‰¾åˆ° user_id=1,7 (city='Beijing')
  â†’ Node C: æ‰¾åˆ° user_id=2,8 (city='Beijing')
  â†’ æ±‡æ€»6æ¡è®°å½•
```

**æ€§èƒ½é—®é¢˜**:
- âŒ ç½‘ç»œå¼€é”€: éœ€è¦è®¿é—®æ‰€æœ‰èŠ‚ç‚¹
- âŒ å»¶è¿Ÿ: æœ€æ…¢èŠ‚ç‚¹å†³å®šæ€»å»¶è¿Ÿ (tail latency)
- âŒ è´Ÿè½½: å³ä½¿åªéœ€è¦å°‘é‡æ•°æ®ï¼Œä¹Ÿè¦æŸ¥æ‰€æœ‰åˆ†åŒº

---

## ä¸¤ç§åˆ†åŒºäºŒçº§ç´¢å¼•æ–¹æ¡ˆ

DDIA æå‡ºäº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œå„æœ‰æƒè¡¡ã€‚

---

### æ–¹æ¡ˆ1: åŸºäºæ–‡æ¡£çš„åˆ†åŒº (Document-Based Partitioning)

ä¹Ÿå« **æœ¬åœ°ç´¢å¼• (Local Index)** æˆ– **scatter-gather**

#### åŸç†

æ¯ä¸ªåˆ†åŒºç»´æŠ¤**è‡ªå·±çš„**äºŒçº§ç´¢å¼•ï¼Œåªç´¢å¼•**æœ¬åˆ†åŒº**çš„æ•°æ®ã€‚

#### æ•°æ®ç»“æ„

```
Node A (åˆ†åŒº0):
  ä¸»æ•°æ®:
    user_id=3, email='alice@example.com', city='Beijing'
    user_id=6, email='bob@example.com', city='Shanghai'

  æœ¬åœ°emailç´¢å¼•:
    'alice@example.com' â†’ user_id=3
    'bob@example.com'   â†’ user_id=6

  æœ¬åœ°cityç´¢å¼•:
    'Beijing'  â†’ [user_id=3]
    'Shanghai' â†’ [user_id=6]

Node B (åˆ†åŒº1):
  ä¸»æ•°æ®:
    user_id=1, email='david@example.com', city='Beijing'
    user_id=4, email='eve@example.com', city='Shanghai'

  æœ¬åœ°emailç´¢å¼•:
    'david@example.com' â†’ user_id=1
    'eve@example.com'   â†’ user_id=4

  æœ¬åœ°cityç´¢å¼•:
    'Beijing'  â†’ [user_id=1]
    'Shanghai' â†’ [user_id=4]

Node C (åˆ†åŒº2):
  ä¸»æ•°æ®:
    user_id=2, email='grace@example.com', city='Beijing'
    user_id=5, email='henry@example.com', city='Shanghai'

  æœ¬åœ°emailç´¢å¼•:
    'grace@example.com' â†’ user_id=2
    'henry@example.com' â†’ user_id=5

  æœ¬åœ°cityç´¢å¼•:
    'Beijing'  â†’ [user_id=2]
    'Shanghai' â†’ [user_id=5]
```

#### æŸ¥è¯¢è¿‡ç¨‹

```sql
SELECT * FROM users WHERE city = 'Beijing';
```

**æ‰§è¡Œæ­¥éª¤**:
```
1. åè°ƒèŠ‚ç‚¹å‘æ‰€æœ‰åˆ†åŒºå‘é€æŸ¥è¯¢
2. Node A: æŸ¥æœ¬åœ°cityç´¢å¼• â†’ è¿”å› [user_id=3]
3. Node B: æŸ¥æœ¬åœ°cityç´¢å¼• â†’ è¿”å› [user_id=1]
4. Node C: æŸ¥æœ¬åœ°cityç´¢å¼• â†’ è¿”å› [user_id=2]
5. åè°ƒèŠ‚ç‚¹æ±‡æ€»ç»“æœ: [1, 2, 3]
```

#### ä¼˜ç¼ºç‚¹

**âœ… ä¼˜ç‚¹**:
- **å†™å…¥ç®€å•**: åªéœ€æ›´æ–°ä¸€ä¸ªåˆ†åŒºçš„ç´¢å¼•
- **å†™å…¥å¿«**: ä¸éœ€è¦è·¨åˆ†åŒºåè°ƒ

**âŒ ç¼ºç‚¹**:
- **è¯»å–æ…¢**: éœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†åŒº (scatter-gather)
- **å°¾å»¶è¿Ÿé—®é¢˜**: æœ€æ…¢çš„åˆ†åŒºå†³å®šæ•´ä½“å»¶è¿Ÿ
- **è´Ÿè½½æ”¾å¤§**: å³ä½¿ç»“æœåªæœ‰å‡ æ¡ï¼Œä¹Ÿè¦æŸ¥æ‰€æœ‰åˆ†åŒº

**é€‚ç”¨åœºæ™¯**:
- å†™å¤šè¯»å°‘
- å¯ä»¥æ¥å—è¯»å»¶è¿Ÿ
- ä¾‹å¦‚: MongoDB, Riak, Cassandra, Elasticsearch, VoltDB

---

### æ–¹æ¡ˆ2: åŸºäºè¯æ¡çš„åˆ†åŒº (Term-Based Partitioning)

ä¹Ÿå« **å…¨å±€ç´¢å¼• (Global Index)** æˆ– **æŒ‰è¯æ¡åˆ†åŒºçš„ç´¢å¼•**

#### åŸç†

æ„å»ºä¸€ä¸ª**å…¨å±€çš„**äºŒçº§ç´¢å¼•ï¼Œç„¶åå°†è¿™ä¸ªç´¢å¼•æœ¬èº«ä¹Ÿè¿›è¡Œåˆ†åŒºã€‚

#### æ•°æ®ç»“æ„

**ä¸»æ•°æ®åˆ†åŒº** (æŒ‰user_id):
```
Node A (user_id % 3 = 0):
  user_id=3, email='alice@example.com', city='Beijing'
  user_id=6, email='bob@example.com', city='Shanghai'

Node B (user_id % 3 = 1):
  user_id=1, email='david@example.com', city='Beijing'
  user_id=4, email='eve@example.com', city='Shanghai'

Node C (user_id % 3 = 2):
  user_id=2, email='grace@example.com', city='Beijing'
  user_id=5, email='henry@example.com', city='Shanghai'
```

**å…¨å±€cityç´¢å¼•åˆ†åŒº** (æŒ‰cityå“ˆå¸Œ):
```
ç´¢å¼•åˆ†åŒº0 (hash(city) % 2 = 0):
  'Shanghai' â†’ [user_id=4, 5, 6]

ç´¢å¼•åˆ†åŒº1 (hash(city) % 2 = 1):
  'Beijing' â†’ [user_id=1, 2, 3]
```

#### æŸ¥è¯¢è¿‡ç¨‹

```sql
SELECT * FROM users WHERE city = 'Beijing';
```

**æ‰§è¡Œæ­¥éª¤**:
```
1. è®¡ç®—ç´¢å¼•åˆ†åŒº: hash('Beijing') % 2 = 1
2. æŸ¥è¯¢ç´¢å¼•åˆ†åŒº1: 'Beijing' â†’ [user_id=1, 2, 3]
3. æ ¹æ®user_idæŸ¥è¯¢ä¸»æ•°æ®:
   - user_id=1 â†’ Node B
   - user_id=2 â†’ Node C
   - user_id=3 â†’ Node A
4. æ±‡æ€»ç»“æœ
```

#### ä¼˜ç¼ºç‚¹

**âœ… ä¼˜ç‚¹**:
- **è¯»å–å¿«**: åªéœ€æŸ¥è¯¢ç›¸å…³çš„ç´¢å¼•åˆ†åŒº
- **é«˜æ•ˆæŸ¥è¯¢**: é¿å…äº†scatter-gather
- **æ”¯æŒèŒƒå›´æŸ¥è¯¢**: å¦‚æœç´¢å¼•æŒ‰èŒƒå›´åˆ†åŒº

**âŒ ç¼ºç‚¹**:
- **å†™å…¥å¤æ‚**: éœ€è¦æ›´æ–°å¤šä¸ªåˆ†åŒº
  - ä¸€æ¬¡å†™å…¥å¯èƒ½éœ€è¦æ›´æ–°ä¸»æ•°æ®åˆ†åŒº + å¤šä¸ªç´¢å¼•åˆ†åŒº
- **å†™å…¥æ…¢**: è·¨åˆ†åŒºäº‹åŠ¡
- **ä¸€è‡´æ€§éš¾**: ç´¢å¼•æ›´æ–°å¯èƒ½æ»å (å¼‚æ­¥æ›´æ–°)

**é€‚ç”¨åœºæ™¯**:
- è¯»å¤šå†™å°‘
- éœ€è¦å¿«é€ŸæŸ¥è¯¢
- å¯ä»¥æ¥å—ç´¢å¼•æœ‰çŸ­æš‚å»¶è¿Ÿ
- ä¾‹å¦‚: Amazon DynamoDB, Riakçš„æœç´¢åŠŸèƒ½

---

## ä¸¤ç§æ–¹æ¡ˆçš„å¯¹æ¯”

| ç»´åº¦ | æœ¬åœ°ç´¢å¼• (Scatter-Gather) | å…¨å±€ç´¢å¼• (Term-Based) |
|------|---------------------------|----------------------|
| **è¯»æ€§èƒ½** | âŒ æ…¢ (æŸ¥æ‰€æœ‰åˆ†åŒº) | âœ… å¿« (åªæŸ¥ç›¸å…³åˆ†åŒº) |
| **å†™æ€§èƒ½** | âœ… å¿« (åªå†™ä¸€ä¸ªåˆ†åŒº) | âŒ æ…¢ (å†™å¤šä¸ªåˆ†åŒº) |
| **ä¸€è‡´æ€§** | âœ… å¼ºä¸€è‡´ | âš ï¸ æœ€ç»ˆä¸€è‡´ (å¼‚æ­¥ç´¢å¼•) |
| **å¤æ‚åº¦** | âœ… ç®€å• | âŒ å¤æ‚ |
| **å°¾å»¶è¿Ÿ** | âŒ é«˜ (æœ€æ…¢åˆ†åŒºå†³å®š) | âœ… ä½ |
| **é€‚ç”¨åœºæ™¯** | å†™å¤šè¯»å°‘ | è¯»å¤šå†™å°‘ |
| **ä»£è¡¨ç³»ç»Ÿ** | MongoDB, Cassandra | DynamoDB, Riak Search |

---

## å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1: ç”µå•†è®¢å•æŸ¥è¯¢

**æ•°æ®æ¨¡å‹**:
```sql
CREATE TABLE orders (
    order_id BIGINT PRIMARY KEY,      -- åˆ†åŒºé”®
    user_id BIGINT,
    product_id BIGINT,
    status VARCHAR(20),               -- 'pending', 'shipped', 'delivered'
    created_at TIMESTAMP
);

-- äºŒçº§ç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);
CREATE INDEX idx_status ON orders(status);
```

**æŸ¥è¯¢éœ€æ±‚**:

#### æŸ¥è¯¢1: æŸ¥çœ‹æŸä¸ªè®¢å•è¯¦æƒ…
```sql
SELECT * FROM orders WHERE order_id = 123456;
```

**åˆ†æ**:
- âœ… ä½¿ç”¨ä¸»é”®ï¼ŒæŒ‰order_idåˆ†åŒº
- âœ… åªæŸ¥ä¸€ä¸ªåˆ†åŒº
- âœ… æ€§èƒ½å¥½

---

#### æŸ¥è¯¢2: æŸ¥çœ‹ç”¨æˆ·çš„æ‰€æœ‰è®¢å•
```sql
SELECT * FROM orders WHERE user_id = 789;
```

**åˆ†æ**:
- âŒ ä½¿ç”¨äºŒçº§ç´¢å¼•user_id
- âŒ æ•°æ®æŒ‰order_idåˆ†åŒºï¼Œuserçš„è®¢å•åˆ†æ•£åœ¨æ‰€æœ‰åˆ†åŒº
- âŒ éœ€è¦scatter-gather

**è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ¡ˆA: ä½¿ç”¨æœ¬åœ°ç´¢å¼• (MongoDBé£æ ¼)**
```
ä¼˜ç‚¹: å†™å…¥å¿«
ç¼ºç‚¹: æŸ¥è¯¢ç”¨æˆ·è®¢å•éœ€è¦æŸ¥æ‰€æœ‰åˆ†åŒº
é€‚ç”¨: è®¢å•å†™å…¥é¢‘ç¹ï¼Œç”¨æˆ·æŸ¥è¯¢è®¢å•ä¸é¢‘ç¹
```

**æ–¹æ¡ˆB: ä½¿ç”¨å…¨å±€ç´¢å¼• (DynamoDBé£æ ¼)**
```
ä¼˜ç‚¹: æŸ¥è¯¢ç”¨æˆ·è®¢å•åªéœ€æŸ¥1-2ä¸ªåˆ†åŒº
ç¼ºç‚¹: æ¯æ¬¡å†™å…¥è®¢å•éœ€è¦æ›´æ–°ç´¢å¼•åˆ†åŒº
é€‚ç”¨: ç”¨æˆ·é¢‘ç¹æŸ¥è¯¢è®¢å•ï¼Œè®¢å•å†™å…¥ç›¸å¯¹è¾ƒå°‘
```

**æ–¹æ¡ˆC: æ”¹å˜åˆ†åŒºé”® (æœ€ä¼˜ä½†æœ‰ä»£ä»·)**
```sql
-- æŒ‰user_idåˆ†åŒº
PARTITION BY HASH(user_id)
```
```
ä¼˜ç‚¹: ç”¨æˆ·çš„æ‰€æœ‰è®¢å•åœ¨åŒä¸€åˆ†åŒºï¼ŒæŸ¥è¯¢å¿«
ç¼ºç‚¹:
  - æŒ‰order_idæŸ¥è¯¢å˜æ…¢ (éœ€è¦scatter-gather)
  - ç”¨æˆ·è®¢å•ä¸å‡è¡¡å¯¼è‡´åˆ†åŒºå€¾æ–œ
é€‚ç”¨: ä¸»è¦æŸ¥è¯¢æ¨¡å¼æ˜¯"æŸ¥ç”¨æˆ·è®¢å•"
```

---

#### æŸ¥è¯¢3: æŸ¥è¯¢æ‰€æœ‰å¾…å‘è´§è®¢å•
```sql
SELECT * FROM orders WHERE status = 'pending';
```

**åˆ†æ**:
- âŒ ä½¿ç”¨äºŒçº§ç´¢å¼•status
- âŒ pendingè®¢å•åˆ†æ•£åœ¨æ‰€æœ‰åˆ†åŒº
- âŒ æ— è®ºå“ªç§æ–¹æ¡ˆéƒ½éœ€è¦æŸ¥å¤šä¸ªåˆ†åŒº

**ä¼˜åŒ–æ€è·¯**:

1. **åŠ ç¼“å­˜**:
   ```
   Redisç¼“å­˜: pending_orders â†’ [order_ids]
   å®šæœŸæ›´æ–°æˆ–äº‹ä»¶é©±åŠ¨æ›´æ–°
   ```

2. **ç‰©åŒ–è§†å›¾**:
   ```sql
   CREATE MATERIALIZED VIEW pending_orders AS
   SELECT * FROM orders WHERE status = 'pending';
   ```

3. **CQRSæ¨¡å¼**:
   ```
   å†™å…¥: è®¢å•è¡¨ (æŒ‰order_idåˆ†åŒº)
   è¯»å–: è®¢å•æŸ¥è¯¢è¡¨ (æŒ‰statusåˆ†åŒº)
   é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥
   ```

---

### æ¡ˆä¾‹2: ç¤¾äº¤ç½‘ç»œç”¨æˆ·æœç´¢

**æ•°æ®æ¨¡å‹**:
```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    city VARCHAR(50),
    age INT
);

-- äºŒçº§ç´¢å¼•
CREATE INDEX idx_city ON users(city);
CREATE INDEX idx_age ON users(age);
```

**æŸ¥è¯¢éœ€æ±‚**:

```sql
-- æŸ¥è¯¢1: æŸ¥æ‰¾æŸä¸ªåŸå¸‚çš„ç”¨æˆ·
SELECT * FROM users WHERE city = 'Beijing';

-- æŸ¥è¯¢2: æŸ¥æ‰¾æŸä¸ªå¹´é¾„æ®µçš„ç”¨æˆ·
SELECT * FROM users WHERE age BETWEEN 20 AND 30;
```

**é—®é¢˜åˆ†æ**:

- æ•°æ®æŒ‰user_idåˆ†åŒº
- cityå’ŒageæŸ¥è¯¢éœ€è¦æ‰«ææ‰€æœ‰åˆ†åŒº
- å¦‚æœç”¨æˆ·é‡å¤§ (äº¿çº§)ï¼ŒæŸ¥è¯¢ä¼šå¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ: æœç´¢å¼•æ“ (Elasticsearch)**

```
1. ä¸»æ•°æ®åº“: æŒ‰user_idåˆ†åŒº (å¿«é€ŸCRUD)
2. æœç´¢å¼•æ“: æŒ‰city/ageç­‰ç»´åº¦ç´¢å¼•
   - å…¨å±€ç´¢å¼•ï¼ŒæŒ‰è¯æ¡åˆ†åŒº
   - è¿‘å®æ—¶æœç´¢
   - å®¹å¿çŸ­æš‚å»¶è¿Ÿ
3. åŒå†™æœºåˆ¶:
   - å†™å…¥æ•°æ®åº“
   - å¼‚æ­¥å†™å…¥ES
```

**æ¶æ„**:
```
ç”¨æˆ·å†™å…¥ â†’ æ•°æ®åº“ (user_idåˆ†åŒº)
           â†“
        æ¶ˆæ¯é˜Ÿåˆ—
           â†“
      Elasticsearch (å…¨å±€city/ageç´¢å¼•)

æŸ¥è¯¢æŒ‰user_id â†’ æ•°æ®åº“
æŸ¥è¯¢æŒ‰city/age â†’ Elasticsearch
```

---

## æ ¸å¿ƒè¦ç‚¹æ€»ç»“

### ä¸ºä»€ä¹ˆåˆ†åŒº+äºŒçº§ç´¢å¼•å¤æ‚ï¼Ÿ

1. **åˆ†åŒºé”®ä¸åŒ¹é…**:
   - æ•°æ®æŒ‰ä¸»é”®åˆ†åŒº
   - äºŒçº§ç´¢å¼•æŸ¥è¯¢ä¸åŒ…å«ä¸»é”®
   - æ— æ³•å®šä½åˆ°å…·ä½“åˆ†åŒº

2. **æ•°æ®åˆ†æ•£**:
   - ç¬¦åˆæ¡ä»¶çš„æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªåˆ†åŒº
   - å¿…é¡»æŸ¥è¯¢å¤šä¸ªèŠ‚ç‚¹
   - æ±‡æ€»ç»“æœ

3. **è¯»å†™æƒè¡¡**:
   - æœ¬åœ°ç´¢å¼•: å†™å¿«è¯»æ…¢
   - å…¨å±€ç´¢å¼•: è¯»å¿«å†™æ…¢
   - æ²¡æœ‰å®Œç¾æ–¹æ¡ˆ

### è®¾è®¡å»ºè®®

1. **ä¼˜å…ˆè€ƒè™‘åˆ†åŒºé”®é€‰æ‹©**:
   ```
   åˆ†åŒºé”®åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶
   ```

2. **ç†è§£æŸ¥è¯¢æ¨¡å¼**:
   ```
   - 80%çš„æŸ¥è¯¢æ˜¯ä»€ä¹ˆï¼Ÿ
   - æ˜¯å¦å¯ä»¥é€šè¿‡åˆ†åŒºé”®æŸ¥è¯¢ï¼Ÿ
   ```

3. **æƒè¡¡è¯»å†™æ¯”ä¾‹**:
   ```
   å†™å¤šè¯»å°‘ â†’ æœ¬åœ°ç´¢å¼•
   è¯»å¤šå†™å°‘ â†’ å…¨å±€ç´¢å¼•
   ```

4. **è€ƒè™‘æ··åˆæ–¹æ¡ˆ**:
   ```
   - ä¸»æ•°æ®åº“: æŒ‰IDåˆ†åŒº
   - æœç´¢å¼•æ“: å…¨å±€ç´¢å¼•
   - ç¼“å­˜: çƒ­ç‚¹æ•°æ®
   ```

5. **æ¥å—æƒè¡¡**:
   ```
   ä¸å¯èƒ½åŒæ—¶ä¼˜åŒ–æ‰€æœ‰æŸ¥è¯¢æ¨¡å¼
   é€‰æ‹©æœ€é‡è¦çš„ä¼˜åŒ–ï¼Œå…¶ä»–æ¥å—æ€§èƒ½æŸå¤±
   ```

---

## å»¶ä¼¸æ€è€ƒ

### æ€è€ƒé¢˜

1. **å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒæŒ‰user_idå’ŒæŒ‰cityå¿«é€ŸæŸ¥è¯¢ï¼Œåº”è¯¥å¦‚ä½•è®¾è®¡ï¼Ÿ**

æç¤º: è€ƒè™‘å¤šä¸ªæ•°æ®å‰¯æœ¬ï¼Œä¸åŒåˆ†åŒºç­–ç•¥

2. **ä¸ºä»€ä¹ˆElasticsearchå¯ä»¥æ”¯æŒå¿«é€Ÿçš„å…¨æ–‡æœç´¢ï¼Œå³ä½¿æ•°æ®åˆ†åŒºäº†ï¼Ÿ**

æç¤º: å€’æ’ç´¢å¼• + å…¨å±€ç´¢å¼•åˆ†åŒº

3. **åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¦‚æœç”¨æˆ·æœåŠ¡æŒ‰user_idåˆ†åŒºï¼Œè®¢å•æœåŠ¡æŒ‰order_idåˆ†åŒºï¼Œå¦‚ä½•é«˜æ•ˆæŸ¥è¯¢"æŸç”¨æˆ·çš„æ‰€æœ‰è®¢å•"ï¼Ÿ**

æç¤º: CQRSã€äº‹ä»¶æº¯æºã€è¯»å†™åˆ†ç¦»

---

## å‚è€ƒèµ„æ–™

1. DDIA Chapter 6: Partitioning
2. [MongoDB: Sharding and Indexing](https://docs.mongodb.com/manual/sharding/)
3. [Cassandra: Secondary Indexes](https://cassandra.apache.org/doc/latest/cql/indexes.html)
4. [DynamoDB: Global Secondary Indexes](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GSI.html)
5. [Elasticsearch: Distributed Search](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-your-data.html)

---

**æ€»ç»“**: åˆ†åŒº+äºŒçº§ç´¢å¼•çš„å¤æ‚æ€§æœ¬è´¨ä¸Šæ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿçš„æƒè¡¡é—®é¢˜**ã€‚æ²¡æœ‰å®Œç¾æ–¹æ¡ˆï¼Œåªæœ‰æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚

ğŸ’¡ **å…³é”®**: ç†è§£ä½ çš„æŸ¥è¯¢æ¨¡å¼ï¼Œé€‰æ‹©åˆé€‚çš„åˆ†åŒºé”®ï¼Œæƒè¡¡è¯»å†™æ€§èƒ½ï¼Œå¿…è¦æ—¶ä½¿ç”¨æ··åˆæ¶æ„ã€‚
